<!-- patch: comments per date+line 2025-09-18T02:11:23.165743 -->
<!-- multi-upload by line + autolink @ 2025-09-18T01:57:40.081115 -->
<!-- Patch: row-click to send Cut-file to search ‚Äî 2025-09-17T09:57:12 -->
<!-- add send-from-Cut button; safe minimal patch @ 2025-09-17T09:49:54 -->
<!-- Rebuilt UPPER variant ‚Äî 2025-09-17T08:13:22 -->
<!-- Patched: restore search‚ÜíQR21‚ÜíQR24‚Üísearch focus flow + single-page print ‚Äî 2025-09-17T06:12:00 -->
<!-- One-page print variant generated 2025-09-17T05:59:13 -->
<!-- Final Build v4 ‚Äî 2025-09-17T02:16:55 -->
<!DOCTYPE html>
<html lang="th">
<head>
<script>const WEB_APP_URL = 'PUT_YOUR_APPS_SCRIPT_WEB_APP_URL_HERE';</script>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/>
<title>PDF + QR System (v5.27.1 ‚Äî Final Build)</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--ink:#101828;--muted:#667085;--pri:#2563eb;
    --ok:#15803d;--warn:#b45309;--bad:#dc2626;--bd:#e5e7eb;--soft:#f8fafc;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  .wrap{max-width:1480px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 8px}
  .status{font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:0 8px 26px rgba(0,0,0,.06);padding:16px}
  .title{font-weight:700;margin:0 0 10px;display:flex;gap:8px;align-items:center}

  .grid-main{display:grid;grid-template-columns:clamp(420px, 34%, 620px) 1fr 1fr;gap:16px;align-items:start}

  input,button,textarea{font:inherit}
  label{font-size:13px;color:#475467;display:block;margin:0 0 6px}
  input,textarea{padding:10px 12px;border:1px solid #cfd5e1;border-radius:10px;outline:0;background:#fff}
  textarea{min-height:96px;resize:vertical}
  input:focus,textarea:focus{border-color:#6b9cff;box-shadow:0 0 0 3px rgba(107,156,255,.25)}
  input:disabled{background:#f3f4f6;color:#94a3b8;cursor:not-allowed}
  .btn{padding:10px 12px;border:0;border-radius:10px;background:var(--pri);color:#fff;cursor:pointer}
  .btn.gray{background:#475569}
  .btn.red{background:#dc2626}
  .btn.ghost{background:#fff;color:#334155;border:1px solid var(--bd)}
  .row{display:grid;grid-template-columns:1fr 220px;gap:10px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .qrbox{background:#fff;border:2px dashed var(--bd);border-radius:14px;padding:10px;display:inline-block}
  canvas{background:#fff;border-radius:10px}
  .filters{border:2px dashed var(--bd);border-radius:14px;background:#f8fafc;padding:16px;min-height:68px;color:#475467;display:grid;gap:12px;align-content:start}
  .filters .rowfit{display:grid;grid-template-columns:240px 1fr;gap:12px;align-items:end}
  .list{display:grid;gap:10px;max-height:60vh;overflow:auto;padding-right:4px}
  .hidden{display:none !important}
  .item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--bd);border-radius:14px;background:#fff}
  .rowflex{display:flex;gap:12px;align-items:center}
  .meta{font-size:12px;color:#64748b}
  .qr-mini{border:1px dashed var(--bd);border-radius:12px;padding:6px}
  .modal{position:fixed;inset:0;display:none;flex-direction:column;background:rgba(0,0,0,.75);z-index:50}
  .modal.show{display:flex}
  .modal .top{background:#fff;padding:10px 14px;border-bottom:1px solid var(--bd)}
  .toolbar{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .modal iframe{width:100%;height:100%;border:0;background:#f3f4f6}
  .seg{display:flex;border:1px solid var(--bd);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{border:0;padding:8px 10px;background:transparent;cursor:pointer;font-size:12px;color:#334155}
  .seg button+button{border-left:1px solid var(--bd)}
  .seg .active{background:var(--pri);color:#fff}

  .searchShort{flex:1 1 420px; min-width:260px; max-width:100%}

  .tabs{display:flex;gap:8px;align-items:center;margin:8px 0 16px}
  .tab{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer;color:#334155}
  .tab.active{background:var(--pri);border-color:var(--pri);color:#fff}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#334155;font-size:12px;border:1px solid var(--bd)}
  .pill.ok{background:#dcfce7;border-color:#86efac;color:#14532d}
  .pill.bad{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}
  .pill.warn{background:#fff7ed;border-color:#fed7aa;color:#7c2d12}
  .pill.neutral{background:#eef2ff;border-color:#c7d2fe;color:#3730a3}
  .badge{font-size:11px;border:1px solid var(--bd);border-radius:999px;padding:2px 8px;background:#f8fafc;color:#334155}

  .uploader{display:grid;gap:12px}
  table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
  th,td{font-size:13px;border-bottom:1px solid var(--bd);padding:8px 10px;text-align:left}
  tbody tr:hover{background:#f8fafc;cursor:pointer}
  .hint{font-size:12px;color:#64748b}
  .passmodal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.65);z-index:60}
  .passmodal.show{display:grid}
  .passcard{background:#fff;border-radius:14px;border:1px solid var(--bd);padding:16px;min-width:320px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.25)}

  #mirrorBox .mirror-scroller{max-height:420px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;background:#fff}
  #mirrorBox table{width:100%;border-collapse:collapse;font-size:13.5px}
  #mirrorBox thead th{position:sticky;top:0;background:#f8fafc;z-index:1;text-align:left;padding:10px 12px;border-bottom:1px solid #e5e7eb;box-shadow: inset 0 -1px 0 #e5e7eb}
  #mirrorBox tbody td{padding:10px 12px;border-bottom:1px solid #eef1f6;white-space:nowrap}
  #mirrorBox tbody tr:nth-child(2n){background:#fbfdff}
  #mirrorBox tbody tr:hover{background:#eef6ff}
  .marker{font-weight:700}
  .marker.done{color:#15803d}
  .marker.todo{color:#b45309}
  .marker.none{color:#64748b}

  .note{font-size:12px;color:#475467}

  @media (max-width: 1280px){
    .grid-main{grid-template-columns:1fr 1fr;}
  }
  @media (max-width: 980px){
    .grid-main{grid-template-columns:1fr;}
    .row{grid-template-columns:1fr}
    .filters .rowfit{grid-template-columns:1fr}
    .searchShort{flex:1 1 auto; min-width:240px; width:auto}
  }
#search{text-transform:uppercase}

/* mini button in Cut-file column */
.sendSearch{font-size:11px; padding:2px 6px; border:1px solid #cbd5e1; background:#fff; border-radius:8px; cursor:pointer; margin-left:6px; color:#334155}
.sendSearch:hover{background:#f1f5f9}

/* row-click to search */
.mirrorRowClick{cursor:pointer}
.mirrorRowClick:hover{background:#f8fafc}
</style>
<script>
  const CFG = { autoBuild:true, autoClear:true, qrWidth:120, offsetY:60 };
  const state={maker:false,pdf:false,listMode:'one', requireScan21:false, page:'main', cmtFilter: localStorage.getItem('pdfqr_cmt_filter')||'all'};

  // === Storage (persist daily uploads + last upload session + comments) ===
  const STORE_KEY = 'pdfqr_upload_store_v1';
  const LAST_KEY  = 'pdfqr_last_upload_v1';
  const COMMENT_KEY = 'pdfqr_row_comments_v1';
  let uploadStore = { byDate: {} };  // { 'YYYY-MM-DD': { rows: [...], name:'file.csv', ts:123456789 } }
  let comments = {}; // { 'YYYY-MM-DD|primaryId': {done:boolean, note:string, ts:number, id:string, date:string} }

  function saveStore(){ try{ localStorage.setItem(STORE_KEY, JSON.stringify(uploadStore)); }catch(e){} }
  function loadStore(){
    try{ const t = localStorage.getItem(STORE_KEY); if(t){ const obj = JSON.parse(t); if(obj && obj.byDate) uploadStore = obj; } }catch(e){}
  }
  function saveComments(){ try{ localStorage.setItem(COMMENT_KEY, JSON.stringify(comments)); }catch(e){} }
  function loadComments(){ try{ const t=localStorage.getItem(COMMENT_KEY); if(t){ const obj=JSON.parse(t); if(obj) comments=obj; } }catch(e){} }

  function putIntoStore(iso, rows, name, line){
  if(!iso || !Array.isArray(rows) || rows.length===0) return false;
  const key = iso + '|' + (line||'');
  uploadStore.byDate[key] = { rows: rows, name: name||'', ts: Date.now(), line: (line||'') };
  saveStore();
  renderStoreList();
  return true;
}

  function removeFromStore(iso){ if(uploadStore.byDate[iso]){ delete uploadStore.byDate[iso]; saveStore(); renderStoreList(); } }

  // Auto-save / restore "last upload session"
  function saveLastUpload(name){
    try{
      const rows = (Array.isArray(uploadRows)? uploadRows.slice(0,2000) : []);
      const payload = JSON.stringify({ name: name||'', rows: rows, ts: Date.now() });
      localStorage.setItem(LAST_KEY, payload);
      $('lastBadge').textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÄ‡∏°‡∏∑‡πà‡∏≠ ' + new Date().toLocaleString('th-TH');
    }catch(e){ console.warn('saveLastUpload failed', e); $('lastBadge').textContent='‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î'; }
  }
  function clearLastUpload(){
    try{ localStorage.removeItem(LAST_KEY); }catch(e){};
    uploadRows=[]; lastFileName=''; $('upTable').innerHTML=''; $('upStatus').textContent='‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß'; $('lastBadge').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
  }
  function loadLastUpload(){
    try{
      const t = localStorage.getItem(LAST_KEY);
      if(!t) { $('lastBadge').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î'; return; }
      const obj = JSON.parse(t);
      if(obj && Array.isArray(obj.rows)){
        uploadRows = obj.rows;
        lastFileName = obj.name||'';
        $('upStatus').textContent = '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏à‡∏≤‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏Å‡πà‡∏≠‡∏ô ‚Ä¢ ‡πÑ‡∏ü‡∏•‡πå: ' + (lastFileName||'(‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏)') + ' ‚Ä¢ ' + uploadRows.length + ' ‡πÅ‡∏ñ‡∏ß';
        $('lastBadge').textContent = '‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ ' + new Date(obj.ts||Date.now()).toLocaleString('th-TH');
        renderUploadTable();
      }else{
        $('lastBadge').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
      }
    }catch(e){
      console.warn('loadLastUpload failed', e);
      $('lastBadge').textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î';
    }
  }

  // === Helpers ===
  const $=id=>document.getElementById(id);
  const fmtSize=n=>{if(n===0)return'0 B';const k=1024,u=['B','KB','MB','GB'];const i=Math.floor(Math.log(n)/Math.log(k));return(n/Math.pow(k,i)).toFixed(2)+' '+u[i];};
  const fmtDate=t=>new Date(t).toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'});
  function toISODate(s){
    if(!s) return '';
    s = String(s).trim();
    if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}$/.test(s)) return s;             // YYYY-MM-DD
    let m = s.match(/^([0-9]{2})\/([0-9]{2})\/([0-9]{4})$/);        // DD/MM/YYYY
    if(m) return m[3]+'-'+m[2]+'-'+m[1];
    m = s.match(/^([0-9]{2})-([0-9]{2})-([0-9]{4})$/);                // DD-MM-YYYY
    if(m) return m[3]+'-'+m[2]+'-'+m[1];
    const d = new Date(s);
    if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
    return '';
  }
  function fmtDateISO(iso){
    try{ const [y,m,d]=iso.split('-').map(Number); return new Date(y, m-1, d).toLocaleDateString('th-TH',{year:'numeric',month:'2-digit',day:'2-digit'}); }catch(e){ return iso; }
  }
  function normalizeField(obj, names){
    for(const k of names){
      if(obj[k]!==undefined) return obj[k];
      const hit = Object.keys(obj).find(x=>x.toLowerCase()===String(k).toLowerCase());
      if(hit) return obj[hit];
    }
    return '';
  }
  function primaryIdOfRow(r){
    return normalizeField(r, ['Cut-file','fileName','‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå','CODE','Code','Part','part','id','ID','Name','‡∏ä‡∏∑‡πà‡∏≠','‡∏ß‡∏±‡∏™‡∏î‡∏∏','Materials']) || String(r[Object.keys(r)[0]]||'').trim() || JSON.stringify(r).slice(0,60);
  }
  function rowKey(iso, r){ var line = $('lineMain')?$('lineMain').value:''; return iso + '|' + line + '|' + primaryIdOfRow(r); }
  function numberOrZero(v){ const n = parseFloat(String(v).replace(/[, ]/g,'')); return isNaN(n)?0:n; }

  // === Libraries loader ===
  async function smartLoad(urls, testFn){
    return new Promise((resolve)=>{
      function attempt(i){ if(i>=urls.length){ resolve(false); return; }
        const s=document.createElement('script'); s.src=urls[i]; s.async=true;
        s.onload=()=>setTimeout(()=>resolve(testFn()),0); s.onerror=()=>attempt(i+1);
        document.head.appendChild(s);
      } attempt(0);
    });
  }
  async function ensureXLSX(){
    if(window.XLSX) return true;
    const ok = await smartLoad([
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
    ], ()=>!!window.XLSX);
    return !!ok || !!window.XLSX;
  }
  async function ensureQR(){
    if(!(window.QRCode&&QRCode.toCanvas) && !window.qrcode){
      await smartLoad([
        'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
        'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js'
      ], ()=>!!(window.QRCode&&QRCode.toCanvas)||!!window.qrcode);
      if(!window.QRCode && window.qrcode){
        window.QRCode={toCanvas:function(canvas,text,opts,cb){
          try{
            const qr=window.qrcode(0, (window.qrcode.ErrorCorrectLevel&&window.qrcode.ErrorCorrectLevel.M)||'M');
            qr.addData(String(text||'')); qr.make();
            const n=qr.getModuleCount(), margin=(opts&&opts.margin!=null)?opts.margin:2;
            const target=(opts&&opts.width)?opts.width:220; const cell=Math.max(1,Math.floor(target/(n+margin*2))); const size=cell*(n+margin*2);
            canvas.width=size; canvas.height=size; const ctx=canvas.getContext('2d');
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#000';
            for(let r=0;r<n;r++){ for(let c=0;c<n;c++){ if(qr.isDark(r,c)){ const x=(c+margin)*cell,y=(r+margin)*cell; ctx.fillRect(x,y,cell,cell);} } }
            cb&&cb(null);
          }catch(e){ cb&&cb(e); }
        }};
      }
    }
    state.maker=!!((window.QRCode&&QRCode.toCanvas)||window.qrcode);
    updateLibStatus();
  }
  async function ensurePDF(){
    if(window.pdfjsLib){ state.pdf=true; updateLibStatus(); return; }
    const ok = await smartLoad([
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
      'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js']
      , ()=>!!window.pdfjsLib);
    if(ok && window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions){
      window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    state.pdf=!!window.pdfjsLib; updateLibStatus();
  }
  function updateLibStatus(){ const el=$('libStatus'); el.textContent = (state.maker?'':'')+' ¬∑ '+(state.pdf?'':''); }

  // === DOM Ready ===
  document.addEventListener('DOMContentLoaded',()=>{
    loadStore(); loadComments();
    ensureQR(); updateLibStatus();
    const d=$('date'); if(d && !d.value){ d.value=(new Date()).toISOString().split('T')[0]; }
    updateTabs();
    $('uplock').textContent='‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà'; $('uplock').className='pill bad';
    renderStoreList();
    setTimeout(()=>{ window.setListMode('one'); try{$('vOne').focus();}catch(e){} },0);
    loadLastUpload();
    try{ mirrorFromUpload(); }catch(e){};
  });

  // === Left column (folder & list) ===
  window.setListMode = function(mode){
    state.listMode = (mode==='one'||mode==='hidden') ? mode : 'all';
    const a=$('vAll'), o=$('vOne'), h=$('vHide');
    if(a&&o&&h){
      a.classList.toggle('active', state.listMode==='all');
      o.classList.toggle('active', state.listMode==='one');
      h.classList.toggle('active', state.listMode==='hidden');
    }
    const wrap=$('listWrap');
    if(wrap) wrap.classList.toggle('hidden', state.listMode==='hidden');
    if(typeof renderList==='function') renderList();
    if(typeof updateCount==='function') updateCount();
  };

  let allFiles=[], viewFiles=[], currentIdx=0, blobURL=null;
  function loadFolder(){
    const files=[...$('folder').files].filter(f=>/\.pdf$/i.test(f.name));
    allFiles=files; viewFiles=files; currentIdx=0;
    renderList(); updateCount();
    if(files.length){
      if(!$('fileName').value) $('fileName').value=files[0].name.replace(/\.pdf$/i,'');
      if(!$('date').value){ const t=new Date(files[0].lastModified); $('date').value=t.toISOString().split('T')[0]; }
      updateLast2();
    }
  }
  function updateCount(){
    const base = allFiles.length? allFiles.length + ' ‡πÑ‡∏ü‡∏•‡πå' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå';
    if(!allFiles.length){ $('fileCount').textContent=base; return; }
    if(state.listMode==='one'){ $('fileCount').textContent='1 ‡∏à‡∏≤‡∏Å ' + allFiles.length + ' ‡πÑ‡∏ü‡∏•‡πå'; }
    else if(state.listMode==='hidden'){ $('fileCount').textContent='‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏£‡∏ß‡∏° ' + allFiles.length + ' ‡πÑ‡∏ü‡∏•‡πå'; }
    else{ $('fileCount').textContent=allFiles.length===viewFiles.length ? (allFiles.length+' ‡πÑ‡∏ü‡∏•‡πå') : (viewFiles.length+' ‡∏à‡∏≤‡∏Å '+allFiles.length+' ‡πÑ‡∏ü‡∏•‡πå'); }
  }
  function renderList(){
    const q=$('search').value?$('search').value.toLowerCase():'';
    viewFiles=q?allFiles.filter(f=>f.name.toLowerCase().includes(q)):allFiles.slice();
    $('listWrap').classList.toggle('hidden', state.listMode==='hidden');
    const box=$('list');
    if(state.listMode==='hidden'){ updateCount(); return; }

    const listToShow = (state.listMode==='one' && viewFiles.length) ? [viewFiles[0]] : viewFiles;
    
  if(state.listMode==='one' && viewFiles.length){ currentIdx = 0; }
if(!listToShow.length){ box.innerHTML='<div class="meta">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>'; updateCount(); return; }

    let html='';
    listToShow.forEach(function(f){
      html+=`<div class="item">
        <div class="rowflex">
          <div class="qr-mini"><canvas class="qr-small" width="90" height="90"></canvas></div>
          <div><div><strong>${f.name}</strong></div>
          <div class="meta">${fmtSize(f.size)} ‚Ä¢ ${fmtDate(f.lastModified)}</div></div>
        </div>
        <button class="btn" data-open="${f.name.replace(/"/g,'&quot;')}">üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á</button>
      </div>`;
    });
    box.innerHTML=html;
    Array.prototype.forEach.call(document.querySelectorAll('[data-open]'), function(btn){
      btn.addEventListener('click', function(){ openPreview(btn.getAttribute('data-open')); });
    });
    const latest = $('qrCanvas').width ? collectData() : '';
    if(latest) renderListQR(latest);
    updateCount();
  }
  function renderListQR(data){ if(!(window.QRCode&&QRCode.toCanvas)) return; Array.prototype.forEach.call(document.querySelectorAll('.qr-small'), function(c){ QRCode.toCanvas(c, data, {width:90, margin:2}, function(){}); }); }

  function openPreview(name){
    const idx=viewFiles.findIndex(function(f){ return f.name===name; }); if(idx<0) return; currentIdx=idx;
    const f=viewFiles[currentIdx];
    if(!$('fileName').value) $('fileName').value=f.name.replace(/\.pdf$/i,'');
    if(!$('date').value){ const t=new Date(f.lastModified); $('date').value=t.toISOString().split('T')[0]; }
    updateLast2();
    if(blobURL) URL.revokeObjectURL(blobURL);
    blobURL=URL.createObjectURL(f); $('viewer').src=blobURL; $('mName').textContent=f.name; $('mPos').textContent=(currentIdx+1)+'/'+viewFiles.length; $('modal').classList.add('show');
  }
  function closePreview(){ $('modal').classList.remove('show'); $('viewer').src=''; if(blobURL){ URL.revokeObjectURL(blobURL); blobURL=null; } }
  function goPrev(){ if(currentIdx>0) openPreview(viewFiles[currentIdx-1].name); }
  function goNext(){ if(currentIdx<viewFiles.length-1) openPreview(viewFiles[currentIdx+1].name); }
  function doPrint(){ const f=viewFiles[currentIdx]; if(!f) return; const url=URL.createObjectURL(f); const w=window.open(url,'_blank'); if(w){ w.onload=function(){ setTimeout(function(){ w.print(); }, 400); }; } setTimeout(function(){ URL.revokeObjectURL(url); }, 10000); }
  function printWithQR(){ doPrint(); }

  // === Middle column (QR info) ===
  function setInfo2Enabled(enabled,focusWhenOk=false){
    $('qr24').disabled=!enabled;
    if(enabled){ $('s_24').textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_24').className='status ok'; $('qr24').placeholder='‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà'; if(focusWhenOk)$('qr24').focus(); }
    else{ $('s_24').textContent='‚õî ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'; $('s_24').className='status'; $('qr24').value=''; $('qr24').placeholder='‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô'; }
  }
  function checkMatch(gate=false,focusWhenOk=false){
    const a=$('last2').value.trim(); const b=$('fileName').value.trim().slice(-2); let ok=false;
    if(a&&b){ ok=(a===b); $('s_match').textContent = ok ? '‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô' : `‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (${b} ‚â† ${a})`; $('s_match').className='status '+(ok?'ok':'bad'); }
    else{$('s_match').textContent='-';$('s_match').className='status';}
    if(gate){
      if(state.requireScan21){ setInfo2Enabled(false,false); }
      else { setInfo2Enabled(ok,focusWhenOk); }
    }
    return ok;
  }
  function updateLast2(){
    const name=$('fileName').value.trim();
    if(name.length>=2){ $('last2').value=name.slice(-2); $('s_last2').textContent='‚úÖ ‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ ‚Äú'+$('last2').value+'‚Äù'; $('s_last2').className='status ok'; }
    else if(name.length===1){ $('last2').value=name; $('s_last2').textContent='‚ö†Ô∏è ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_last2').className='status warn'; }
    else{ $('last2').value=''; $('s_last2').textContent='‡∏à‡∏∞‡∏ï‡∏±‡∏î 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'; $('s_last2').className='status'; }
    checkMatch(true,false);
  }
  function onQR21(){
    const v=$('qr21').value;
    if(v.length===21){
      const cut=v.substring(14,16); $('last2').value=cut; $('s_21').textContent='‚úÖ ‡∏™‡∏Å‡∏±‡∏î ‚Äú'+cut+'‚Äù ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 15-16'; $('s_21').className='status ok';
      state.requireScan21=false;
      const ok=checkMatch(true,true); if(!ok){ $('qr21').focus(); }
    }else if(v.length<21){ $('s_21').textContent='‚è≥ '+v.length+'/21'; $('s_21').className='status'; setInfo2Enabled(false,false); }
    else{ $('s_21').textContent='‚ùå ‡πÄ‡∏Å‡∏¥‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ('+v.length+')'; $('s_21').className='status bad'; setInfo2Enabled(false,false); }
  }
  function onQR24(){
    const vRaw=$('qr24').value; const v=vRaw.replace(/\s/g,'');
    if(v!==vRaw){ $('qr24').value=v; }
    if(v.length===24){
      $('s_24').textContent='‚úÖ ‡πÑ‡∏î‡πâ‡∏Ñ‡∏£‡∏ö 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_24').className='status ok';
      if(CFG.autoBuild){ makeQR(); }
    }else if(v.length<24){ $('s_24').textContent='‚è≥ '+v.length+'/24'; $('s_24').className='status'; }
    else{ $('s_24').textContent='‚ùå ‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ('+v.length+')'; $('s_24').className='status bad'; }
  }
  function collectData(){
    const name=$('fileName').value.trim(), info2=$('qr24').value.trim(), date=$('date').value;
    return (name&&info2&&date)?(name+'|'+info2+'|'+date):'';
  }
  async function makeQR(){
    await ensureQR();
    if(!(window.QRCode&&QRCode.toCanvas)){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'); return; }
    const data=collectData(); if(!data){ return; }
    return new Promise(function(resolve){
      QRCode.toCanvas($('qrCanvas'), data, {width:180, margin:2}, function(err){
        if(err){ console.error(err); resolve(false); return; }
        renderListQR(data);
        if(CFG.autoClear){
          $('qr21').value=''; $('s_21').textContent='‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‚Ä¶'; $('s_21').className='status';
          $('qr24').value=''; $('s_24').textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_24').className='status ok';
          $('qr21').focus();
        }
        resolve(true);
      });
    });
  }

  // === Upload page ===
  function showPage(p){
    const prev = state.page;
    state.page = p;
    $('pageMain').classList.toggle('hidden', p!=='main');
    if(p==='main'){ try{ mirrorFromUpload(); }catch(e){} }
    $('pageUpload').classList.toggle('hidden', p!=='upload');
    updateTabs();
    if(prev==='upload' && p!=='upload'){
      $('uplock').textContent='‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà';
      $('uplock').className='pill bad';
    }
  }
  function updateTabs(){
    $('tabMain').classList.toggle('active', state.page==='main');
    $('tabUpload').classList.toggle('active', state.page==='upload');
  }
  function goUpload(){
    $('passModal').classList.add('show');
    setTimeout(()=>$('passcode').focus(), 0);
  }
  function cancelPass(){ $('passModal').classList.remove('show'); $('passcode').value=''; $('passMsg').textContent=''; }
  function tryPass(){
    const v=$('passcode').value.trim();
    if(v==='12345'){
      $('uplock').textContent='‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
      $('uplock').className='pill ok';
      cancelPass();
      showPage('upload');
    }else{
      $('passMsg').textContent='‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      $('passMsg').className='status bad';
    }
  }

  let uploadRows=[]; // last parsed file (preview)
  let lastFileName='';
  function handleUploadFile(files){
    uploadRows=[];
    const f=files&&files[0]; if(!f){ $('upStatus').textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'; $('upTable').innerHTML=''; return; }
    lastFileName = f.name || '';
    $('upStatus').textContent='‡πÑ‡∏ü‡∏•‡πå: '+lastFileName+' ‚Ä¢ '+fmtSize(f.size);
    if(/\.(xlsx|xls)$/i.test(lastFileName)){
      (async()=>{
        const ok = await ensureXLSX();
        if(!ok){ $('upStatus').textContent='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏≠‡πà‡∏≤‡∏ô Excel ‡πÑ‡∏î‡πâ (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏´‡∏£‡∏∑‡∏≠ CDN ‡∏•‡πà‡∏°)'; return; }
        try{
          const buf = await f.arrayBuffer();
          const wb = XLSX.read(buf, {type:'array'});
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
          buildRowsFromJSON(json);
          $('upStatus').textContent = '‡∏≠‡πà‡∏≤‡∏ô Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Ä¢ ‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô: '+sheetName+' ‚Ä¢ '+json.length+' ‡πÅ‡∏ñ‡∏ß';
        }catch(e){
          $('upStatus').textContent='‡∏≠‡πà‡∏≤‡∏ô Excel ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message;
          $('upTable').innerHTML='';
        }
      })();
      return;
    }
    const reader=new FileReader();
    if(/\.json$/i.test(lastFileName)){
      reader.onload=function(){ try{ const data=JSON.parse(reader.result); buildRowsFromJSON(data); }catch(e){ $('upStatus').textContent='‡∏≠‡πà‡∏≤‡∏ô JSON ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message; $('upTable').innerHTML=''; } };
      reader.readAsText(f);
    }else{
      reader.onload=function(){ buildRowsFromCSV(reader.result); };
      reader.readAsText(f,'utf-8');
    }
  }
  function buildRowsFromJSON(data){
    if(Array.isArray(data)){ uploadRows=data; } else if(data && Array.isArray(data.rows)){ uploadRows=data.rows; } else { uploadRows=[data]; }
    uploadRows=uploadRows.map(r=>{ const d=r.date||r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']||r['Date']||''; return Object.assign({}, r, {_d: toISODate(d)}); });
    saveLastUpload(lastFileName);
    renderUploadTable();
  }
  function buildRowsFromCSV(text){
    const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(lines.length===0){ $('upTable').innerHTML='<div class="status">‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á</div>'; return; }
    const header=lines[0].split(',').map(s=>s.trim());
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(','); const obj={};
      header.forEach((h,idx)=>{ obj[h]= (cols[idx]||'').trim(); });
      rows.push(obj);
    }
    uploadRows=rows.map(r=>{ const d=r.date||r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']||r['Date']||''; return Object.assign({}, r, {_d: toISODate(d)}); });
    saveLastUpload(lastFileName);
    renderUploadTable();
  }
  function renderUploadTable(){
    try{ mirrorFromUpload(); }catch(e){};
    const box=$('upTable');
    if(!uploadRows.length){ box.innerHTML='<div class="status">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á</div>'; $('addInfo').textContent=''; return; }
    const want=$('upDateFilter')?$('upDateFilter').value:'';
    const rows = want? uploadRows.filter(r=>r._d===want) : uploadRows;
    const keys=new Set(); rows.forEach(r=>Object.keys(r).forEach(k=>keys.add(k))); const cols=[...keys];
    let html='<div class="hint">';
    if(want){ html+=' ‚Ä¢ ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <strong>'+want+'</strong>'; } var lf=($('upLineFilter')&&$('upLineFilter').value)||''; if(lf){ html+=' ‚Ä¢ ‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï: <strong>'+lf+'</strong>'; }
    html+='</div>';
    html+='<table><thead><tr>';
    cols.forEach(c=>{ html+='<th>'+c+'</th>'; });
    html+='</tr></thead><tbody>';
    rows.forEach((r,idx)=>{
      html+='<tr data-idx="'+idx+'">';
      cols.forEach(c=>{ html+='<td>'+ (r[c]!==undefined ? String(r[c]) : '') +'</td>'; });
      html+='</tr>';
    });
    html+='</tbody></table>';
    box.innerHTML=html;

    const distinct = Array.from(new Set(uploadRows.map(r=>r._d).filter(Boolean)));
    let target = want || (distinct.length===1 ? distinct[0] : '');
    const msg = target ? ('‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <strong>'+target+'</strong>') : '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏ "‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" ‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏£‡∏∞‡∏ö‡∏ö';
    $('addInfo').innerHTML = msg;
    $('addBtn').disabled = !target;
    $('addBtn').setAttribute('data-target', target||'');

    Array.prototype.forEach.call(document.querySelectorAll('#upTable tbody tr'), tr=>{
      tr.addEventListener('click', function(){
        const i=parseInt(tr.getAttribute('data-idx'),10);
        const wantDate=$('upDateFilter')?$('upDateFilter').value:'';
        let idx=i;
        if(wantDate){ const matched=uploadRows.filter(r=>r._d===wantDate); const r=matched[i]; idx=uploadRows.indexOf(r); }
        pickRow(idx);
      });
    });
  }
  function addCurrentToStore(){
    const t = $('addBtn').getAttribute('data-target')||'';
    if(!t){ alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å "‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà" ‡∏Å‡πà‡∏≠‡∏ô'); return; }
    const rows = uploadRows.filter(r=> (r._d||'')===t );
    if(rows.length===0){
      if(confirm('‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà '+t+' ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ ‚Äî ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')){
        const forced = uploadRows.map(r=>Object.assign({}, r, {_d:t}));
        putIntoStore(t, forced, lastFileName, ($('upLineFilter')?$('upLineFilter').value:''));
        alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà '+t+' (‡∏ó‡∏±‡πâ‡∏á‡πÑ‡∏ü‡∏•‡πå)');
      }
      return;
    }
    putIntoStore(t, rows, lastFileName, ($('upLineFilter')?$('upLineFilter').value:''));
    alert('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡∏Ñ‡∏•‡∏±‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà '+t+' ('+rows.length+' ‡πÅ‡∏ñ‡∏ß)');
  }
  function renderStoreList(){
    const box = $('storeList'); if(!box) return;
    const keys = Object.keys(uploadStore.byDate).sort();
    if(keys.length===0){ box.innerHTML='<div class="status"></div>'; return; }
    let html='';
    keys.forEach(k=>{
      const rec = uploadStore.byDate[k]||{rows:[],ts:0,name:'',line:''};
      const count = (rec.rows||[]).length;
      const when = rec.ts ? new Date(rec.ts).toLocaleString('th-TH') : '-';
      const parts = String(k).split('|');
      const iso = parts[0]||'';
      const line = parts[1]||rec.line||'';
      html += `
        <div class="storeItem">
          <div>
            <div><strong class="mono">${iso}</strong> ${line?`<span class="badge neutral">${line}</span>`:''} <span class="badge ok">${count} ‡πÅ‡∏ñ‡∏ß</span></div>
            <div class="status">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: ${when}${rec.name?(' ‚Ä¢ ‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå: '+rec.name):''}</div>
          </div>
          <div class="inline" style="gap:6px">
            <button class="btn" data-use="${k}">‡πÑ‡∏õ‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ</button>
            <button class="btn gray" data-remove="${k}">‡∏•‡∏ö</button>
          </div>
        </div>`;
    });
    box.innerHTML = html;
    box.querySelectorAll('[data-use]').forEach(btn=>btn.addEventListener('click',()=>useDateOnMain(btn.dataset.use)));
    box.querySelectorAll('[data-remove]').forEach(btn=>btn.addEventListener('click',()=>removeFromStore(btn.dataset.remove)));
  }
  function useDateOnMain(isoKey){
    const parts = String(isoKey||'').split('|');
    const iso = parts[0]||'';
    const line = parts[1]||'';
    $('date').value = iso;
    if($('lineMain')){ $('lineMain').value = line; }
    showPage('main'); mirrorFromUpload();
  }

  function pickRow(i){
    const r=uploadRows[i]||{};
    const fname = r.fileName || r.filename || r.name || r['‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå'] || r['filename'] || r['FILE'] || '';
    const date  = r._d || r.date || r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || r['date'] || '';
    $('search').value = String(fname||'').toUpperCase();
    onSearchInput();
    if(date){ $('date').value = toISODate(date) || date; }
    showPage('main');
    onSearchDone();
  }

  // === Search helpers (left column) ===
  function onSearchInput(){
  const el = $('search');
  if(el){
    const pos = el.selectionStart;
    const up = (el.value||'').toUpperCase();
    if(el.value !== up){
      el.value = up;
      try{ el.setSelectionRange(pos, pos); }catch(e){}
    }
  }
  renderList(); updateCount();
}
  function clearSearch(){ $('search').value=''; onSearchInput(); }
  function onSearchDone(){
  // sync selection to search results
  try{
    const s2 = document.getElementById('search');
    const q2 = (s2 && s2.value ? s2.value.trim().toLowerCase() : '');
    if (typeof viewFiles !== 'undefined' && viewFiles.length){
      const ixExact = viewFiles.findIndex(f => f.name.toLowerCase() === q2);
      const ixPart  = viewFiles.findIndex(f => f.name.toLowerCase().includes(q2));
      currentIdx = (ixExact >= 0) ? ixExact : (ixPart >= 0 ? ixPart : 0);
    }
  }catch(e){};

  const s = document.getElementById('search');
  const q = (s && s.value ? s.value : '').trim().toUpperCase(); if(s) s.value = q;
  if(!q){ if(s) s.focus(); return; }
  // copy to "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå"
  const fn = document.getElementById('fileName');
  if(fn){
    fn.value = q;
    try{ if(typeof updateLast2==='function') updateLast2(); }catch(e){}
  }
  // focus QR21
  const el = document.getElementById('qr21');
  if(el){
    try{ el.focus(); el.select(); }catch(e){}
    try{ el.scrollIntoView({behavior:'smooth', block:'center'}); }catch(e){}
  }
}


  function setCmtFilter(mode){
    state.cmtFilter = mode;
    localStorage.setItem('pdfqr_cmt_filter', mode);
    mirrorFromUpload();
  }
  function showSummaryDialog(c){
    alert(
      '‡∏™‡∏£‡∏∏‡∏õ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô (‡∏ï‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)\\n'+
      '- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ' + c.total + ' ‡πÅ‡∏ñ‡∏ß\\n'+
      '- ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß: ' + c.done + ' ‡πÅ‡∏ñ‡∏ß\\n'+
      '- ‡∏Ñ‡πâ‡∏≤‡∏á (‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô): ' + c.todo + ' ‡πÅ‡∏ñ‡∏ß\\n'+
      '- ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô: ' + c.none + ' ‡πÅ‡∏ñ‡∏ß'
    );
  }

  // === Mirror upload store -> main filters (+ comments) ===
  function getRowsForDate(iso, line){
    const key = (iso||'') + '|' + (line||'');
    let rec = uploadStore.byDate[key];
    if(!rec){ rec = uploadStore.byDate[iso]; } // fallback legacy
    if(rec && Array.isArray(rec.rows) && rec.rows.length>0){
      return rec.rows;
    }
    return [];
  }
  function mirrorFromUpload(){
    const box = $('mirrorBox'); if(!box) return;
    const iso = $('date') ? $('date').value : '';
    if(!iso){ box.innerHTML='<div class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>'; return; }
    const line = $('lineMain') ? $('lineMain').value : '';
  if(!line){ box.innerHTML='<div class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</div>'; return; }
  const rows = getRowsForDate(iso, line);
    if(rows.length===0){ box.innerHTML='<div class="status">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å ‚Äú‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà '+iso+'</div>'; return; }

    // Counters
    let sumTimes=0, sumPieces=0;
    let cntDone=0, cntTodo=0, cntNone=0;
    const classify = (r)=>{
      const key = rowKey(iso, r);
      const cm = comments[key];
      if(cm){ if(cm.done) return 'done'; return 'todo'; }
      return 'none';
    };
    var targetFilled=0, targetEmpty=0; var targetSet=new Set();
    rows.forEach(r=>{
      sumTimes += numberOrZero( normalizeField(r, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','times','count','Times']) );
      sumPieces += numberOrZero( normalizeField(r, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','pieces','qty','Quantity']) );
      const t = classify(r);
      if(t==='done') cntDone++; else if(t==='todo') cntTodo++; else cntNone++;
      var tgt = normalizeField(r, ['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','P/NO','‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','Target']);
      if(tgt && String(tgt).trim()){ targetFilled++; targetSet.add(String(tgt).trim()); } else { targetEmpty++; }
    });

    // Apply filter
    const show = rows.filter(r=>{
      const t = classify(r);
      if(state.cmtFilter==='done') return t==='done';
      if(state.cmtFilter==='todo') return t==='todo';
      if(state.cmtFilter==='none') return t==='none';
      if(state.cmtFilter==='noted') return t!=='none';
      return true; // all
    }).slice(0,600);

    const keys = new Set(); show.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
    const cols = Array.from(keys);
    var pref = ['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','Trim','Cut-file','Materials','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','_d'];
    var rest = cols.filter(c => pref.indexOf(c) === -1);

    let html = '';
    html += '<div class="inline" style="justify-content:space-between;gap:8px;margin-bottom:8px;flex-wrap:wrap">';
    html +=   '<div class="inline" style="gap:8px;flex-wrap:wrap">';
    html +=     '<div class="status">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà '+fmtDateISO(iso)+' ‚Ä¢ ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î '+rows.length+' ‡πÅ‡∏ñ‡∏ß ‚Ä¢ ‡∏£‡∏ß‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á: <strong>'+sumTimes+'</strong> ‚Ä¢ ‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô: <strong>'+sumPieces+'</strong></div>';
    html +=     '<span class="pill ok">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß '+cntDone+'</span>';
    html +=     '<span class="pill warn">‡∏á‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤‡∏á‡πÅ‡∏ú‡∏ô '+cntTodo+'</span>';
    html +=     '<span class="pill neutral">‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏ó‡∏≥ '+cntNone+'</span>';
    html +=     '<span class="pill">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ '+targetFilled+'</span>';
    html +=     '<span class="pill gray"> '+targetEmpty+'</span>';
    html +=     '<span class="pill neutral">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÑ‡∏°‡πà‡∏ã‡πâ‡∏≥ '+targetSet.size+'</span>';
    html +=   '</div>';
    html +=   '<div class="inline" style="gap:6px">';
    html +=     '<div class="seg">';
    ['all','todo','done','noted'].forEach(mode=>{
      const label = mode==='all'?'‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î': mode==='todo'?'‡∏Ñ‡πâ‡∏≤‡∏á': mode==='done'?'‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß':'‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô';
      const active = (state.cmtFilter===mode)?'active':'';
      html += `<button class="${active}" data-cmt="${mode}">${label}</button>`;
    });
    html +=     '</div>';
    html +=     '<button class="btn gray" id="btnSum">‡∏™‡∏£‡∏∏‡∏õ</button>';
    html +=     '<button class="btn" id="btnExportCSV">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV</button>';
    html +=     '<button class="btn" id="btnExportXLS">‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>';
    html +=     '<button class="btn ghost" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>';
    html +=   '</div>';
    html += '</div>';

    html += '<div class="mirror-scroller">';
    html += '<table><thead><tr>'; 
    html += '<th>P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</th>';
    html += '<th>Trim</th>';
    html += '<th>Cut-file</th>';
    html += '<th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>';
    html += '<th>Materials</th>';
    html += '<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á</th>';
    html += '<th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)</th>';
    html += '<th>_d</th>';
    rest.forEach(c=>{ if(['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','Trim','Cut-file','Materials','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','_d'].indexOf(c)===-1){ html += '<th>'+c+'</th>'; }});
    html += '<th>‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>';
    html += '</tr></thead><tbody>';show.forEach((r)=>{
      const id = primaryIdOfRow(r);
      const key = rowKey(iso, r);
      const cm = comments[key];
      const mark = cm ? (cm.done ? '‚úÖ' : 'üìù') : 'Ôºã';
      const cls = cm ? (cm.done ? 'marker done' : 'marker todo') : 'marker none';
      const title = cm ? ((cm.done?'‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß ‚Äî ':'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Äî ') + (cm.note||'').replace(/"/g,'\"')) : '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå';
      const listText = cm ? (cm.done ? '‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß' : (cm.note||'')) : '';
      html += `<tr data-rowkey="${key}" data-display="${id}" title="${title}">`;
      var vPno = normalizeField(r, ['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','P/NO','‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','Target']);
      var vTrim = normalizeField(r, ['Trim','TRIM','trim']);
      var vCut  = normalizeField(r, ['Cut-file','fileName','‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå']);
      var vMat  = normalizeField(r, ['Materials','‡∏ß‡∏±‡∏™‡∏î‡∏∏']);
      var vTimes = normalizeField(r, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','times','count','Times']);
      var vPieces = normalizeField(r, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','pieces','qty','Quantity']);
      var vDate = normalizeField(r, ['_d','date','‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','Date']);
      html += '<td><div class="pno-edit" contenteditable="true" data-iso="'+iso+'" data-id="'+id+'" onkeydown="onPnoKey(event)" onblur="commitPno(this)">' + (vPno||'') + '</div></td>';
      html += '<td>'+ (vTrim||'') +'</td>';
      html += '<td><span class="val">' + (vCut||'') + '</span> <button class="sendSearch" title="‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤">‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</button></td>';
      html += `<td class="${cls}">${mark}</td>`;
      html += '<td>'+ (vMat||'') +'</td>';
      html += '<td>'+ (vTimes||'') +'</td>';
      html += '<td>'+ (vPieces||'') +'</td>';
      html += '<td>'+ (vDate||'') +'</td>';
      rest.forEach(function(c){ html += '<td>'+ (r[c]!==undefined? String(r[c]) : '') +'</td>'; });
      var tsCell = (cm && Array.isArray(cm.logs) && cm.logs.length) ? fmtDateTime(cm.logs[cm.logs.length-1]) : (cm && cm.ts ? fmtDateTime(cm.ts) : '');
      html += '<td>'+ tsCell +'</td>';
      html += '<td>'+ listText +'</td>';
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    box.innerHTML = html;

    box.querySelectorAll('tbody tr').forEach(tr=>{
      tr.addEventListener('click', ()=>openCommentEditor(tr.dataset.rowkey, tr.dataset.display, iso));
    });
    box.querySelectorAll('[data-cmt]').forEach(btn=>{
      btn.addEventListener('click', ()=>setCmtFilter(btn.dataset.cmt));
    });
    $('btnRefresh').addEventListener('click', ()=>mirrorFromUpload());
    $('btnSum').addEventListener('click', ()=>showSummaryDialog({total:rows.length, done:cntDone, todo:cntTodo, none:cntNone}));
    if($('btnExportCSV')) $('btnExportCSV').addEventListener('click', exportCSV_fromDom);
    if($('btnExportXLS')) $('btnExportXLS').addEventListener('click', exportXLS_fromDom);
    // ‡∏™‡πà‡∏á Cut-file ‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    box.querySelectorAll('.sendSearch').forEach(function(btn){
      btn.addEventListener('click', function(ev){
        ev.stopPropagation();
        var td = btn.closest('td');
        var v = td && td.querySelector('.val') ? td.querySelector('.val').innerText : '';
        v = String(v||'').trim();
        if(v){
          try{ $('search').value = v.toUpperCase(); onSearchInput(); onSearchDone(); }catch(e){}
        }
      });
    });

    // ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡πÅ‡∏ñ‡∏ß -> ‡∏™‡πà‡∏á Cut-file ‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ (‡∏¢‡∏Å‡πÄ‡∏ß‡πâ‡∏ô‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏°/‡∏•‡∏¥‡∏á‡∏Å‡πå/‡∏≠‡∏¥‡∏ô‡∏û‡∏∏‡∏ï)
    box.querySelectorAll('tbody tr').forEach(function(tr){
      tr.classList.add('mirrorRowClick');
      tr.addEventListener('click', function(ev){
        var tag = (ev.target && ev.target.tagName || '').toLowerCase();
        if (tag === 'button' || tag === 'a' || tag === 'input' || (ev.target.closest && ev.target.closest('.btn'))) return;
        var tds = tr.querySelectorAll('td');
        var td = tds[2]; // ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå Cut-file
        var val = td && td.querySelector('.val') ? td.querySelector('.val').innerText : (td ? td.innerText : '');
        val = String(val || '').trim();
        if(val){
          try{ $('search').value = val.toUpperCase(); onSearchInput(); onSearchDone(); }catch(e){}
        }
      });
    });

  }

  // === Comment editor modal ===
  function openCommentEditor(key, display, iso){
    $('cmtTarget').textContent = display || '(‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£)';
    $('cmtDate').textContent = fmtDateISO(iso);
    $('cmtKey').value = key;
    const cm = comments[key] || {done:false, note:'', ts:0, id:display, date:iso};
    $('cmtDone').checked = !!cm.done;
    $('cmtNote').value = cm.note || '';
    $('commentModal').classList.add('show');
  }
  function saveComment(){
    const key = $('cmtKey').value;
    const done = $('cmtDone').checked;
    const note = $('cmtNote').value.trim();
    const parts = key.split('|');
    const iso = parts[0] || ($('date').value||'');
    const id  = $('cmtTarget').textContent || '';
    var prev = comments[key] || {};
    var logs = Array.isArray(prev.logs) ? prev.logs.slice() : [];
    logs.push(Date.now());
    comments[key] = {done: done, note: note, ts: Date.now(), id: id, date: iso, logs: logs};
    saveComments();
    $('commentModal').classList.remove('show');
    mirrorFromUpload();
  }
  function deleteComment(){
    const key = $('cmtKey').value;
    if(comments[key]){ delete comments[key]; saveComments(); }
    $('commentModal').classList.remove('show');
    mirrorFromUpload();
  }
  function cancelComment(){ $('commentModal').classList.remove('show'); }



function fmtDateTime(ts){
  try{
    if(!ts) return '';
    const n = Number(ts);
    if(!isFinite(n)) return '';
    return new Date(n).toLocaleString('th-TH', { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit', second:'2-digit' });
  }catch(e){ return ''; }
}
</script>
<style>
@media (min-width: 1024px){
  .wrap{
    margin-left: 8px;
    margin-right: auto;
    padding-left: 12px;
  }
}
</style><style>
.pno-edit{ padding:4px 6px; border:1px dashed transparent; border-radius:6px; min-width:120px; display:inline-block }
.pno-edit:focus{ outline:0; border-color:#93c5fd; background:#eff6ff }
.pill.gray{ background:#f1f5f9; border-color:#e2e8f0; color:#334155 }
</style><style>
/* === Mini Calendar for üß∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏•‡∏ô‡πå === */
.cal{display:flex;flex-direction:column;gap:6px;background:#fff;border:1px dashed #cbd5e1;border-radius:12px;padding:8px}
.cal .cal-head{display:flex;align-items:center;gap:8px;justify-content:space-between}
.cal .cal-head .nav{display:flex;gap:6px}
.cal .cal-head button{padding:6px 10px;border:1px solid var(--bd);background:#fff;border-radius:10px;cursor:pointer}
.cal .cal-head .label{font-weight:600}
.cal .days{display:flex;flex-wrap:wrap;gap:6px;margin-top:6px}
.cal .day{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:999px;border:2px solid #16a34a;color:#15803d;background:#dcfce7;font-weight:700}
.cal .day.muted{opacity:.45;border-color:#94a3b8;background:#f1f5f9;color:#475569}
.cal .day.empty{border-color:#cbd5e1;background:#fff;color:#334155}
.cal .day.active{background:#16a34a;border-color:#16a34a;color:#fff;box-shadow:0 0 0 3px rgba(22,163,74,.18)}
.cal .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:#475467;margin-top:4px}
.cal .legend .chip{display:inline-flex;align-items:center;gap:6px}
.cal .chip .demo{width:14px;height:14px;border-radius:999px;border:2px solid #16a34a;background:#dcfce7;display:inline-block}
.cal .chip .demo.none{border-color:#cbd5e1;background:#fff}
.cal .chip .demo.muted{border-color:#94a3b8;background:#f1f5f9}
</style><style>
/* layout: calendar above, section below */
#calendarBox{margin: 10px 0 12px 0;}
</style></head>
<body>
<div class="wrap">
<h1>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF + ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö QR</h1>
<div class="status" id="libStatus">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‚Ä¶</div>
<div class="tabs">
<button class="tab active" id="tabMain" onclick="showPage('main')">üìÑ ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
<button class="tab" id="tabUpload" onclick="goUpload()">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
<span class="pill bad" id="uplock">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà</span>
</div>
<!-- Main Page -->
<div id="pageMain">
<div class="grid-main">
<div class="card">
<h3 class="title">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå &amp; ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå PDF</h3>
<div class="inline" style="gap:8px">
<input class="searchShort" id="search" oninput="onSearchInput()" onkeydown="if(event.key==='Enter'){onSearchDone()}" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå..."/>
<button class="btn gray" onclick="clearSearch()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á</button>
<input directory="" id="folder" multiple="" style="padding:10px;border:1px dashed #cfd5e1;border-radius:10px;background:#fff" type="file" webkitdirectory=""/>
<button class="btn" id="btnLoad" onclick="loadFolder()">‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
<div class="seg" title="‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
<button id="vAll" onclick="setListMode('all')">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<button class="active" id="vOne" onclick="setListMode('one')">1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
<button id="vHide" onclick="setListMode('hidden')">‡∏ã‡πà‡∏≠‡∏ô</button>
</div>
<div class="grow"></div>
</div>
<div class="status" id="fileCount" style="margin-top:8px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå</div>
<div id="listWrap" style="margin-top:10px">
<div class="list" id="list">
<div class="meta">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Ä¶</div>
</div>
</div>
</div>
<div class="card">
<h3 class="title">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå &amp; ‡∏™‡∏£‡πâ‡∏≤‡∏á QR</h3>
<div class="row">
<div>
<label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</label>
<input id="fileName" oninput="updateLast2()" placeholder="‡πÄ‡∏ä‡πà‡∏ô DA0101A-18"/>
<div class="status" id="s_last2">‡∏ï‡∏±‡∏î‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
</div>
<div>
<label>‡∏™‡∏µ‡∏Ç‡∏≠‡∏á file + ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏°‡πâ‡∏ß‡∏ô</label>
<input id="last2" placeholder="‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥" readonly=""/>
<div class="status" id="s_match">-</div>
</div>
</div>
<div class="row2" style="margin-top:10px">
<div>
<label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡πâ‡∏ß‡∏ô</label>
<input id="qr21" oninput="onQR21()" placeholder="‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô"/>
<div class="status" id="s_21">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
</div>
<div>
<label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RF</label>
<input disabled="" id="qr24" onchange="onQR24()" oninput="onQR24()" placeholder="‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡∏°‡πâ‡∏ß‡∏ô‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô"/>
<div class="status" id="s_24">‚õî ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</div>
</div>
</div>
<div class="inline" style="margin-top:12px">
<div class="qrbox"><canvas height="180" id="qrCanvas" width="180"></canvas></div>
<button class="btn" id="btnBuild" onclick="makeQR()">‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR</button>
<button class="btn" onclick="printWithQROverlay()">üñ®Ô∏è ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° QR</button>
</div>
</div>
<div class="card">
<div id="calendarBox"></div><h3 class="title">üß∞‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏•‡∏ô‡πå</h3><div class="filters" id="extraFilters">
<div class="rowfit">
<div>
<label>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
<input id="date" onchange="mirrorFromUpload()" type="date"/>
</div>
<div class="status"></div>
</div>
<div class="rowfit">
<div>
<label>‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</label>
<select id="lineMain" onchange="mirrorFromUpload()">
<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå ‚Äî</option>
<option value="‡πÑ‡∏•‡∏ô‡πåJ30A">‡πÑ‡∏•‡∏ô‡πåJ30A</option>
<option value="‡πÑ‡∏•‡∏ô‡πåJ30S">‡πÑ‡∏•‡∏ô‡πåJ30S</option>
<option value="‡πÑ‡∏•‡∏ô‡πåJ69P">‡πÑ‡∏•‡∏ô‡πåJ69P</option>
</select>
</div>
<div class="status"></div>
</div>
<div class="card" id="mirrorBox" style="border:1px dashed #cfd5e1;background:#fff;padding:12px;border-radius:12px">
<div class="status"></div>
</div>
</div>
</div>
</div>
</div>
<!-- Upload Page -->
<div class="hidden" id="pageUpload">
<div class="card">
<h3 class="title">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
<div class="uploader">
<div class="inline" style="align-items:center">
<input accept=".csv,.json,.xlsx,.xls" id="upFile" onchange="handleUploadFile(this.files)" type="file"/>
<div class="status" id="upStatus">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV / JSON / Excel (.xlsx/.xls) ‚Ä¢</div>
<span class="note" id="lastBadge"></span>
<div class="inline" style="gap:8px;margin-left:8px;">
<label style="margin:0"></label>
<input id="upDateFilter" onchange="renderUploadTable()" type="date"/>
<button class="btn gray" onclick="document.getElementById('upDateFilter').value=''; renderUploadTable();">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</div>
<div class="inline" style="gap:8px;margin-left:8px;">
<label style="margin:0">‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</label>
<select id="upLineFilter" onchange="renderUploadTable()">
<option value="">‚Äî ‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‚Äî</option>
<option value="‡πÑ‡∏•‡∏ô‡πåJ30A">‡πÑ‡∏•‡∏ô‡πåJ30A</option>
<option value="‡πÑ‡∏•‡∏ô‡πåJ30S">‡πÑ‡∏•‡∏ô‡πåJ30S</option>
<option value="‡πÑ‡∏•‡∏ô‡πåJ69P">‡πÑ‡∏•‡∏ô‡πåJ69P</option>
</select>
</div>
<div class="grow"></div>
<button class="btn gray" onclick="clearLastUpload()">‡∏•‡∏ö‡∏£‡∏∞‡∏ö‡∏ö‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</button>
<button class="btn gray" onclick="showPage('main')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
</div>
<div id="upTable"></div>
<div class="store" style="margin-top:12px">
<div class="inline" style="gap:8px;align-items:center">
<button class="btn" id="addBtn" onclick="addCurrentToStore()">‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</button>
<div class="status" id="addInfo"></div>
</div>
<div class="status"></div>
<div class="storeList" id="storeList"></div>
</div>
<div class="hint">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: <code>fileName</code>, <code>date</code> (‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà")</div>
</div>
</div>
</div>
</div>
<!-- Passcode Modal -->
<div class="passmodal" id="passModal" onclick="if(event.target===this) cancelPass()">
<div class="passcard">
<h3 style="margin:0 0 8px">üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äú‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù</h3>
<div class="status">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</div>
<div style="display:flex;gap:8px;align-items:center;margin-top:10px">
<input id="passcode" onkeydown="if(event.key==='Enter'){tryPass()}" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™" type="password"/>
<button class="btn" onclick="tryPass()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
<button class="btn gray" onclick="cancelPass()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
</div>
<div class="status" id="passMsg" style="margin-top:8px"></div>
<div class="hint" style="margin-top:6px">* ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö:*****</div>
</div>
</div>
<!-- Comment Modal -->
<div class="passmodal" id="commentModal" onclick="if(event.target===this) cancelComment()">
<div class="passcard" style="min-width:560px;max-width:860px">
<h3 style="margin:0 0 8px">üí¨ ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô</h3>
<div class="status" style="margin-bottom:10px">‡∏£‡∏∞‡∏ö‡∏∏‡∏ß‡πà‡∏≤‡∏á‡∏≤‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á ‡πÅ‡∏•‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏±‡∏ç‡∏´‡∏≤/‡πÇ‡∏ô‡πâ‡∏ï</div>
<input id="cmtKey" type="hidden"/>
<div class="inline" style="gap:12px;flex-wrap:wrap">
<div><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> <span id="cmtDate">-</span></div>
<div><strong>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£:</strong> <span class="mono" id="cmtTarget">-</span></div>
</div>
<div style="margin-top:12px">
<label class="inline" style="gap:8px"><input id="cmtDone" type="checkbox"/> ‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</label>
</div>
<div style="margin-top:10px">
<label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (‡∏´‡∏≤‡∏Å‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏™‡∏£‡πá‡∏à ‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏∏‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏/‡∏õ‡∏±‡∏ç‡∏´‡∏≤)</label>
<textarea id="cmtNote" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
</div>
<div class="inline" style="justify-content:flex-end;margin-top:12px">
<button class="btn red" onclick="deleteComment()">‡∏•‡∏ö‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô</button>
<button class="btn gray" onclick="cancelComment()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
<button class="btn" onclick="saveComment()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
</div>
</div>
</div>
<!-- Viewer Modal -->
<div class="modal" id="modal">
<div class="top">
<div class="toolbar">
<strong id="mName">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</strong>
<span class="meta" id="mPos"></span>
<div class="grow"></div>
<button class="btn" id="mPrintWithQR" onclick="printWithQROverlay()">‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° QR</button>
<button class="btn gray" id="mPrint" onclick="doPrint()">‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°</button>
<button class="btn gray" id="mPrev" onclick="goPrev()">‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
<button class="btn gray" id="mNext" onclick="goNext()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
<button class="btn" id="mClose" onclick="closePreview()">‡∏õ‡∏¥‡∏î</button>
</div>
</div>
<iframe id="viewer" src=""></iframe>
</div>
<script>
// (removed broken IIFE)
</script>
<script>

window.printWithQROverlay = async function(){
  // ‡πÉ‡∏ä‡πâ QR ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏≠‡∏¢‡∏π‡πà (qrCanvas) ‡∏ñ‡πâ‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏´‡πâ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏∞‡∏•‡∏á‡∏ö‡∏ô PDF ‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  await ensurePDF(); await ensureQR();
  
  // ---- Resolve target PDF file robustly (without relying solely on helper) ----
  let file = null;
  try{
    // A) Preferred: use live globals
    if (typeof viewFiles !== 'undefined' && viewFiles.length){
      if (typeof currentIdx === 'number' && currentIdx >= 0 && currentIdx < viewFiles.length) file = viewFiles[currentIdx];
      else file = viewFiles[0];
    }
    // B) If still not found, match by UI (first visible card)
    if(!file){
      const b = document.querySelector('[data-open]');
      const uiName = b ? (b.getAttribute('data-open') || '').trim() : '';
      const fi = document.getElementById('folder');
      const raw = (fi && fi.files) ? Array.from(fi.files) : [];
      if (uiName && raw.length){
        const fx = raw.find(f => f.name === uiName);
        if (fx) file = fx;
      }
      if(!file && raw.length){ file = raw[0]; }
    }
    // C) Fallback to preview blob (if modal preview was opened)
    if(!file){
      const v = document.getElementById('viewer');
      if(v && typeof v.src === 'string' && v.src.startsWith('blob:')){
        const blob = await fetch(v.src).then(r=>r.blob()).catch(()=>null);
        if (blob){
          try{ file = new File([blob], 'preview.pdf', {type: blob.type || 'application/pdf'}); }
          catch(e){ file = blob; }
        }
      }
    }
    // D) Compatibility helper, if defined
    if(!file && typeof getCurrentPDFFile === 'function'){ file = getCurrentPDFFile(); }
  }catch(e){ /* swallow */ }
  if(!file){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå\\n\\n‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå PDF ‡∏´‡∏£‡∏∑‡∏≠‡∏Å‡∏î ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á/‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ ‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏Å‡πà‡∏≠‡∏ô'); return; }
// ‡∏ñ‡πâ‡∏≤ qrCanvas ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á ‡πÉ‡∏´‡πâ‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤
  var qrCanvas = document.getElementById('qrCanvas');
  if(!(qrCanvas && qrCanvas.width > 0)){
    if(typeof makeQR === 'function'){ 
      var ok = await makeQR(); 
      qrCanvas = document.getElementById('qrCanvas');
      if(!ok || !(qrCanvas && qrCanvas.width>0)){
        alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ QR ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‚Äî ‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR" ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'); 
        return; 
      }
    }else{
      alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ QR ‡∏ö‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á QR'); 
      return;
    }
  }

  var qrW = (window.CFG && CFG.qrWidth) ? CFG.qrWidth : 120;
  var offsetY = (window.CFG && CFG.offsetY != null) ? CFG.offsetY : 40;

  // ‡∏≠‡πà‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå PDF ‡∏î‡πâ‡∏ß‡∏¢ pdf.js
  var buf = await file.arrayBuffer();
  var pdf = await pdfjsLib.getDocument({data: buf}).promise;
  var images = [];
  for (var i = 1; i <= Math.min(1, pdf.numPages); i++) {
    var page = await pdf.getPage(i);
    var viewport = page.getViewport({scale: 1.3});
    var c = document.createElement('canvas');
    var ctx = c.getContext('2d');
    c.width = Math.floor(viewport.width);
    c.height = Math.floor(viewport.height);
    await page.render({canvasContext: ctx, viewport: viewport}).promise;

    var w = qrW;
    var x = Math.round((c.width - w)/2);
    var y = Math.max(0, Math.round(offsetY));
    ctx.drawImage(qrCanvas, x, y, w, w);

    images.push(c.toDataURL('image/png'));
  }

  // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡∏∞‡∏û‡∏¥‡∏°‡∏û‡πå (‡∏™‡∏£‡πâ‡∏≤‡∏á DOM ‡∏î‡πâ‡∏ß‡∏¢ createElement ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
  var w = window.open('', '_blank');
  if(!w){ alert('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏õ‡πä‡∏≠‡∏õ‡∏≠‡∏±‡∏õ ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß'); return; }
  var doc = w.document;
  doc.head.innerHTML = '';
  var meta = doc.createElement('meta'); meta.setAttribute('charset','utf-8'); doc.head.appendChild(meta);
  var title = doc.createElement('title'); title.textContent = '‡∏û‡∏¥‡∏°‡∏û‡πå‡∏û‡∏£‡πâ‡∏≠‡∏° QR'; doc.head.appendChild(title);
  var style = doc.createElement('style');
  style.textContent = '@page{margin:0}' + ' html,body{margin:0;background:#fff}' + ' .page{display:block;}' + ' .page img{display:block;width:100%;height:auto}' + ' @media print{ .page{page-break-after:always;break-after:page} .page:last-child{page-break-after:auto;break-after:auto} }'
                    + '@media print{ /* single page */ }';
  style.innerHTML += '@page{size:auto;margin:0} html,body{margin:0;padding:0} img{display:block;page-break-inside:avoid}';
    doc.head.appendChild(style);

  images.forEach(function(src){ var d = doc.createElement('div'); d.className='page'; var im = doc.createElement('img'); im.src=src; d.appendChild(im); doc.body.appendChild(d);});

  try{ w.focus(); }catch(e){}
  setTimeout(function(){ try{ w.print(); }catch(e){} }, 500);
};

</script>
<script>
window.onPnoKey = function(e){
  if(e.key === 'Enter'){ e.preventDefault(); e.target.blur(); }
};
window.commitPno = function(el){
  try{
    var iso = el.getAttribute('data-iso')||'';
    var id  = el.getAttribute('data-id')||'';
    var val = (el.textContent||'').trim();
    if(!iso || !id) return;
    var store = (window.uploadStore && uploadStore.byDate && uploadStore.byDate[iso]) ? uploadStore.byDate[iso] : null;
    if(!store) return;
    var rows = Array.isArray(store.rows) ? store.rows : [];
    var changed = false;
    for(var i=0;i<rows.length;i++){
      var r = rows[i];
      var rid = (typeof primaryIdOfRow==='function') ? primaryIdOfRow(r) : '';
      if(String(rid) === String(id)){
        if(r['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'] !== undefined) r['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'] = val;
        else if(r['P/NO'] !== undefined) r['P/NO'] = val;
        else if(r['‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'] !== undefined) r['‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'] = val;
        else r['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢'] = val;
        changed = true;
        break;
      }
    }
    if(changed){ if(typeof saveStore==='function') saveStore(); if(typeof mirrorFromUpload==='function') mirrorFromUpload(); }
  }catch(e){ console.warn('commitPno failed', e); }
};
</script><script>
// === Persistent UI State (auto save/restore) ===
(function(){
  const KEY = 'uiState_v3';
  const $ = (id)=>document.getElementById(id);
  function read(){ try{ return JSON.parse(localStorage.getItem(KEY)||'{}'); }catch(e){ return {}; } }
  function write(s){ try{ localStorage.setItem(KEY, JSON.stringify(s)); }catch(e){} }

  window.saveUiState = function(extra){
    const s = read();
    const d = $('date'), l = $('lineMain');
    if(d) s.date = d.value;
    if(l) s.line = l.value;
    ['fileName','qr21','qr24','search'].forEach(id=>{ const el = $(id); if(el) s[id] = el.value; });
    if(window.state && typeof state.listMode==='string') s.listMode = state.listMode;
    if(window.state && typeof state.cmtFilter==='string') s.cmtFilter = state.cmtFilter;
    const sc = document.querySelector('.mirror-scroller');
    if(sc) s.mirrorScroll = { top: sc.scrollTop, left: sc.scrollLeft };
    if(extra && typeof extra==='object') Object.assign(s, extra);
    write(s);
  };

  window.restoreUiState = function(){
    const s = read();
    const d = $('date'), l = $('lineMain');
    if(d && s.date) d.value = s.date;
    if(l && s.line) l.value = s.line;

    ['fileName','qr21','qr24','search'].forEach(id=>{
      const el = $(id);
      if(el && s[id] != null){
        el.value = s[id];
        try{ el.dispatchEvent(new Event('input')); el.dispatchEvent(new Event('change')); }catch(e){}
      }
    });

    if(typeof setListMode==='function' && s.listMode){ try{ setListMode(s.listMode); }catch(e){} }
    if(window.state && s.cmtFilter){ state.cmtFilter = s.cmtFilter; }

    // ‡∏ß‡∏≤‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
    if(typeof mirrorFromUpload==='function'){ try{ mirrorFromUpload(); }catch(e){} }
    setTimeout(()=>{
      const sc = document.querySelector('.mirror-scroller');
      if(sc && s.mirrorScroll){ sc.scrollTop = s.mirrorScroll.top||0; sc.scrollLeft = s.mirrorScroll.left||0; }
    }, 0);
  };

  document.addEventListener('DOMContentLoaded', ()=>{
    restoreUiState();
    ['date','lineMain','fileName','qr21','qr24','search'].forEach(id=>{
      const el = $(id); if(!el) return;
      el.addEventListener('change', saveUiState);
      el.addEventListener('input',  saveUiState);
    });
    // ‡∏õ‡∏∏‡πà‡∏°‡πÇ‡∏´‡∏°‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô
    ['vAll','vOne','vHide'].forEach(id=>{ const b=$(id); if(b) b.addEventListener('click', saveUiState); });
    document.body.addEventListener('click', (e)=>{
      const btn = e.target.closest('[data-cmt]');
      if(btn && window.state){ state.cmtFilter = btn.getAttribute('data-cmt'); saveUiState(); }
    });
    // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á
    document.body.addEventListener('scroll', (e)=>{
      const sc = document.querySelector('.mirror-scroller');
      if(e.target===sc) saveUiState();
    }, true);
  });

  window.addEventListener('beforeunload', saveUiState);
})();
</script><script>
// === Export from visible table DOM so it always matches what user sees ===
(function(){
  function sanitizeCSV(v){ if(v==null) return ''; let s=String(v).replace(/\r?\n/g,' '); if(s.includes('"')||s.includes(',')||s.includes('\n')) s='"'+s.replace(/"/g,'""')+'"'; return s; }
  function headerOrder(){ return ['P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢','Trim','Cut-file','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','Materials','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','_d','‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤','‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô']; }
  
  function collectRows(){
  const box = document.getElementById('mirrorBox');
  const tbl = box && box.querySelector('table');
  if(!tbl) return [];

  // --- ‡πÉ‡∏ä‡πâ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö UI ---
  // 0:P/NO, 1:Trim, 2:Cut-file, 3:‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞, 4:Materials, 5:‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á, 6:‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô), 7:_d, 8:‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤, 9:‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏á‡∏≤‡∏ô
  const FIX = {PNO:0, Trim:1, Cut:2, Stat:3, Mat:4, Times:5, Pieces:6, D:7, TS:8, Job:9};
  const trs = Array.from(tbl.querySelectorAll('tbody tr'));
  const rows = [];

  trs.forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    const txt = i => { const td = tds[i]; if(!td) return ''; const s = td.querySelector('.val'); const t = s ? s.innerText : td.innerText; return String(t||'').trim(); };

    let ts = txt(FIX.TS);
    // fallback ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡πâ‡∏ô‡∏ñ‡πâ‡∏≤‡πÄ‡∏ã‡∏•‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á
    if(!ts){
      const key = tr.getAttribute('data-rowkey') || '';
      const cm  = (window.comments||{})[key];
      if(cm){
        if(Array.isArray(cm.logs) && cm.logs.length){ ts = fmtDateTime(cm.logs[cm.logs.length-1]); }
        else if(cm.ts){ ts = fmtDateTime(cm.ts); }
      }
    }

    rows.push({
      'P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢': txt(FIX.PNO),
      'Trim': txt(FIX.Trim),
      'Cut-file': txt(FIX.Cut),
      '‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞': txt(FIX.Stat),
      'Materials': txt(FIX.Mat),
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á': txt(FIX.Times),
      '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)': txt(FIX.Pieces),
      '_d': txt(FIX.D),
      '‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤': ts,
      '‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô': txt(FIX.Job)
    });
  });
  return rows;
}window.exportCSV_fromDom = function(){
    const rows = collectRows(); if(!rows.length){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á'); return; }
    const hdrs = headerOrder(); const lines=[hdrs.map(sanitizeCSV).join(',')];
    rows.forEach(o=> lines.push(hdrs.map(h=>sanitizeCSV(o[h]==null?'':o[h])).join(',')));
    const iso = (document.getElementById('date')||{}).value||'';
    const line = (document.getElementById('lineMain')||{}).value||'';
    const a=document.createElement('a'); a.download='export-filter-'+(iso||'')+(line?('-'+line):'')+'.csv';
    a.href=URL.createObjectURL(new Blob(['\ufeff'+lines.join('\n')],{type:'text/csv;charset=utf-8'})); document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
  };
  window.exportXLS_fromDom = function(){
    const rows = collectRows(); if(!rows.length){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á'); return; }
    const hdrs = headerOrder(); let html='<table border=\"1\" cellspacing=\"0\" cellpadding=\"4\" style=\"border-collapse:collapse\">';
    html+='<thead><tr>'+hdrs.map(h=>'<th>'+h+'</th>').join('')+'</tr></thead><tbody>';
    rows.forEach(o=>{ html+='<tr>'+hdrs.map(h=>'<td>'+String(o[h]==null?'':o[h]).replace(/[<>&]/g,s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))+'</td>').join('')+'</tr>'; });
    html+='</tbody></table>';
    const iso = (document.getElementById('date')||{}).value||'';
    const line = (document.getElementById('lineMain')||{}).value||'';
    const a=document.createElement('a'); a.download='export-filter-'+(iso||'')+(line?('-'+line):'')+'.xls';
    a.href=URL.createObjectURL(new Blob(['\ufeff'+html],{type:'application/vnd.ms-excel'})); document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); },0);
  };
})();
</script><script>
// === Mini Calendar (binds to #date + #lineMain) ===
(function(){
  function pad(n){ return (n<10?'0':'')+n; }
  function parseISO(s){
    if(!s) return null;
    const m = String(s).match(/^(\d{4})-(\d{2})-(\d{2})$/);
    if(!m) return null;
    return new Date(parseInt(m[1]), parseInt(m[2])-1, parseInt(m[3]));
  }
  function formatISO(d){ return d.getFullYear()+'-'+pad(d.getMonth()+1)+'-'+pad(d.getDate()); }
  function labelMonth(d){ return d.toLocaleDateString('th-TH', { year:'numeric', month:'long' }); }

  function hasDataForDay(year, month, day, line){
    try{
      const iso = year+'-'+pad(month+1)+'-'+pad(day);
      const key = iso + '|' + (line||'');
      const rec = (window.uploadStore && uploadStore.byDate && (uploadStore.byDate[key] || uploadStore.byDate[iso]));
      if(rec && Array.isArray(rec.rows) && rec.rows.length>0) return true;
      return false;
    }catch(e){ return false; }
  }

  function renderCalendar(){
    const box = document.getElementById('calendarBox');
    if(!box) return;
    const dateEl = document.getElementById('date');
    const lineEl = document.getElementById('lineMain');
    const line = lineEl ? lineEl.value : '';

    // determine month to show
    let base = parseISO(dateEl && dateEl.value);
    const now = new Date();
    if(!base) base = new Date(now.getFullYear(), now.getMonth(), 1);
    const first = new Date(base.getFullYear(), base.getMonth(), 1);
    const last = new Date(base.getFullYear(), base.getMonth()+1, 0);
    const selectedISO = dateEl && dateEl.value ? dateEl.value : '';

    // Build DOM
    const wrap = document.createElement('div'); wrap.className='cal';
    // head
    const head = document.createElement('div'); head.className='cal-head';
    const nav = document.createElement('div'); nav.className='nav';
    const btnPrev = document.createElement('button'); btnPrev.textContent='‚Üê ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô';
    const btnNext = document.createElement('button'); btnNext.textContent='‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí';
    nav.appendChild(btnPrev); nav.appendChild(btnNext);
    const lbl = document.createElement('div'); lbl.className='label'; lbl.textContent = labelMonth(first);
    head.appendChild(lbl); head.appendChild(nav);
    wrap.appendChild(head);
    // days
    const days = document.createElement('div'); days.className='days';
    for(let d=1; d<=last.getDate(); d++){
      const iso = first.getFullYear()+'-'+pad(first.getMonth()+1)+'-'+pad(d);
      const b = document.createElement('button');
      b.type='button';
      b.className='day';
      if(selectedISO===iso) b.classList.add('active');
      const ok = hasDataForDay(first.getFullYear(), first.getMonth(), d, line);
      if(!ok) b.classList.add('empty');
      b.textContent=String(d);
      b.addEventListener('click', function(){
        const el = document.getElementById('date');
        if(el){ el.value = iso; try{ el.dispatchEvent(new Event('change')); }catch(e){} }
        try{ if(typeof saveUiState==='function') saveUiState({}); }catch(e){}
        // re-render to update "active" highlight
        renderCalendar();
      });
      days.appendChild(b);
    }
    wrap.appendChild(days);

    // legend
    const leg = document.createElement('div'); leg.className='legend';
    leg.innerHTML = '<span class="chip"><span class="demo"></span>‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î</span>' +
                    '<span class="chip"><span class="demo none"></span>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span>';
    wrap.appendChild(leg);

    box.innerHTML=''; box.appendChild(wrap);

    btnPrev.addEventListener('click', function(){
      const cur = parseISO(selectedISO) || first;
      const prev = new Date(first.getFullYear(), first.getMonth()-1, 1);
      // keep same day if possible
      const keep = new Date(prev.getFullYear(), prev.getMonth(), Math.min(cur.getDate(), new Date(prev.getFullYear(), prev.getMonth()+1, 0).getDate()));
      if(dateEl){ dateEl.value = formatISO(keep); try{ dateEl.dispatchEvent(new Event('change')); }catch(e){} }
      renderCalendar();
    });
    btnNext.addEventListener('click', function(){
      const cur = parseISO(selectedISO) || first;
      const next = new Date(first.getFullYear(), first.getMonth()+1, 1);
      const keep = new Date(next.getFullYear(), next.getMonth(), Math.min(cur.getDate(), new Date(next.getFullYear(), next.getMonth()+1, 0).getDate()));
      if(dateEl){ dateEl.value = formatISO(keep); try{ dateEl.dispatchEvent(new Event('change')); }catch(e){} }
      renderCalendar();
    });
  }

  // render on load & when inputs change
  document.addEventListener('DOMContentLoaded', renderCalendar);
  document.addEventListener('change', function(e){
    const id = (e.target&&e.target.id)||'';
    if(id==='date' || id==='lineMain'){ renderCalendar(); }
  });
  // also when upload store changes (after adding data), hook into renderStoreList if exists
  const origRenderStoreList = window.renderStoreList;
  if(typeof origRenderStoreList === 'function'){
    window.renderStoreList = function(){ origRenderStoreList.apply(this, arguments); try{ renderCalendar(); }catch(e){} };
  }
  window.renderCalendar = renderCalendar;
})();
</script><style>#calendarBox + h1, #calendarBox + h2, #calendarBox + h3, #calendarBox + h4 { margin-top: 10px; display:block;}</style><style>
/* calendar sits on top of the whole production block */
#calendarBox{margin-bottom:12px;}
</style>
<style id="layout-v5-desktop-2col">
/* Desktop: switch to two-column grid, left narrow, right wide (match screenshot) */
@media (min-width: 981px){
  #pageMain .grid-main{
    grid-template-columns: clamp(360px, 34%, 520px) 1fr !important;
    grid-auto-rows: minmax(100px, auto);
    align-items: start;
  }
  #pageMain .grid-main .card{
    margin: 0; /* tighter like screenshot */
  }
  /* visual polish closer to screenshot */
  #pageMain .card{
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(2,6,23,0.06);
    border: 1px solid #e2e8f0;
  }
  #pageMain h3.title{
    gap: 8px;
  }
}
/* Mobile: reset any forced grid placement */
@media (max-width: 980px){
  #cardFolder,#cardQR,#cardProduction{
    grid-column: auto !important;
    grid-row: auto !important;
  }
}
</style>
<script id="layout-v5-place-cards">
// === Layout v5 (match screenshot) ===
// Desktop: two-column grid. Left column (row1=üìÅ, row2=üìù). Right column = üß∞ spanning two rows.
(function(){
  function findCard(icon){
    return Array.from(document.querySelectorAll('#pageMain .grid-main > .card')).find(function(card){
      var h = card.querySelector('h3.title');
      return h && h.textContent && h.textContent.indexOf(icon) !== -1;
    }) || null;
  }
  function applyLayoutV5(){
    var grid = document.querySelector('#pageMain .grid-main');
    if(!grid) return;
    var cardFolder = findCard('üìÅ');
    var cardQR     = findCard('üìù');
    var cardProd   = findCard('üß∞');
    if(!(cardFolder && cardQR && cardProd)) return;

    // Source order for accessibility and keyboard nav
    grid.appendChild(cardFolder);
    grid.appendChild(cardQR);
    grid.appendChild(cardProd);

    // Stable ids
    cardFolder.id = cardFolder.id || 'cardFolder';
    cardQR.id     = cardQR.id     || 'cardQR';
    cardProd.id   = cardProd.id   || 'cardProduction';

    // Desktop placement (mobile will stack naturally)
    cardFolder.style.gridColumn = '1';
    cardFolder.style.gridRow = '1';
    cardQR.style.gridColumn = '1';
    cardQR.style.gridRow = '2';
    cardProd.style.gridColumn = '2';
    cardProd.style.gridRow = '1 / span 2';
  }
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', applyLayoutV5);
  }else{
    applyLayoutV5();
  }
  // Re-apply when returning to main tab
  document.addEventListener('click', function(e){
    var b = e.target.closest && e.target.closest('#tabMain');
    if(b){ setTimeout(applyLayoutV5, 0); }
  });
})();
</script>


<script>
/* === Production QR logger with aggressive caching for qr21/qr24 === */
(function(){
  const WEBHOOK = 'https://script.google.com/macros/s/AKfycbwyn2HFclAjEQs72g84eqo5r9hhxUTdQ6Z4JbvFCarFBSbLv6qyta5oFcz6f0qM5Wv-UA/exec';
  const SHEET   = '';
  const QKEY    = 'pdfqr_print_log_queue_v1';
  const DEDUPE  = 'pdfqr_last_payload_hash_v5';

  // cache
  window.__qrCache = window.__qrCache || { qr21:'', qr24:'' };

  function get(id){ return document.getElementById(id) || null; }
  function val(el){ return el ? String((el.value!==undefined ? el.value : '')).trim() : ''; }
  function attrVal(el){ return el ? String(el.getAttribute('value')||'').trim() : ''; }
  function text(el){ return el ? String((el.textContent||'')).trim() : ''; }

  function clean(s){ return (s||'').trim(); }
  function isMeaningful(s){ return !!clean(s); }

  function updateCacheFromDom(){
    const v21 = val(get('qr21')) || attrVal(get('qr21'));
    const v24 = val(get('qr24')) || attrVal(get('qr24'));
    if(isMeaningful(v21)) window.__qrCache.qr21 = v21;
    if(isMeaningful(v24)) window.__qrCache.qr24 = v24;
  }

  function bindInputs(){
    const i21 = get('qr21'), i24 = get('qr24');
    if(i21){
      ['input','change','keyup','blur'].forEach(ev => i21.addEventListener(ev, () => {
        const v = val(i21);
        if(isMeaningful(v)) window.__qrCache.qr21 = v;
      }, {passive:true}));
    }
    if(i24){
      ['input','change','keyup','blur'].forEach(ev => i24.addEventListener(ev, () => {
        const v = val(i24) || attrVal(i24);
        if(isMeaningful(v)) window.__qrCache.qr24 = v;
      }, {passive:true}));
    }
  }

  function wrapQRHandlers(){
    // wrap onQR21/onQR24 if present so cache updates when they run
    ['onQR21','onQR24'].forEach(fnName => {
      const orig = window[fnName];
      if(typeof orig === 'function' && !orig.__wrapped){
        window[fnName] = function(){
          try{ const r = orig.apply(this, arguments); updateCacheFromDom(); return r; }
          finally{ updateCacheFromDom(); }
        };
        window[fnName].__wrapped = true;
      }
    });
  }

  function hash(obj){
    try{ return btoa(unescape(encodeURIComponent(JSON.stringify(obj)))).slice(0,64); }
    catch(_){ return String(Math.random()); }
  }
  function qPush(row){
    try{ const q = JSON.parse(localStorage.getItem(QKEY)||'[]'); q.push(row); localStorage.setItem(QKEY, JSON.stringify(q)); }catch(e){}
  }
  async function qFlush(){
    try{
      const q = JSON.parse(localStorage.getItem(QKEY)||'[]');
      if(!Array.isArray(q)||!q.length) return;
      await fetch(WEBHOOK, {method:'POST', mode:'no-cors', headers:{'Content-Type':'text/plain'}, body: JSON.stringify({sheet:SHEET, rows:q})}).catch(()=>null);
      localStorage.removeItem(QKEY);
    }catch(e){}
  }

  
  // Return local time in ISO 8601 with timezone offset, e.g. 2025-09-23T15:30:00+07:00
  function localISO(d){
    d = d ? new Date(d) : new Date();
    const tzo = -d.getTimezoneOffset(); // minutes east of UTC
    const sign = tzo >= 0 ? '+' : '-';
    const pad = (n) => String(Math.floor(Math.abs(n))).padStart(2,'0');
    const off = sign + pad(tzo/60) + ':' + pad(tzo%60);
    const yyyy = d.getFullYear();
    const mm = pad(d.getMonth()+1);
    const dd = pad(d.getDate());
    const HH = pad(d.getHours());
    const MM = pad(d.getMinutes());
    const SS = pad(d.getSeconds());
    return `${yyyy}-${mm}-${dd}T${HH}:${MM}:${SS}${off}`;
  }
function collect(){
    updateCacheFromDom();
    const qr21Dom = val(get('qr21')) || attrVal(get('qr21'));
    const qr24Dom = val(get('qr24')) || attrVal(get('qr24'));
    const qr21 = isMeaningful(qr21Dom) ? qr21Dom : (window.__qrCache.qr21 || '');
    const qr24 = isMeaningful(qr24Dom) ? qr24Dom : (window.__qrCache.qr24 || '');
    const fileName = val(get('fileName')) || val(document.querySelector('#qrBox input[type="text"]')) || '';
    return {
      timestamp: localISO(),
      date_display: (get('date')||{}).value || '',
      line: (get('lineMain')||{}).value || '',
      fileName, qr21, qr24,
      user_agent: navigator.userAgent || ''
    };
  }

  async function sendOnce(){
    const data = collect();
    const h = hash(data);
    if(localStorage.getItem(DEDUPE) === h) return;
    localStorage.setItem(DEDUPE, h);
    qPush(data);
    await qFlush();
  }

  document.addEventListener('click', function(ev){
    const btn = ev.target.closest && ev.target.closest('button, a');
    if(!btn) return;
    const t = (btn.textContent||'').replace(/\s+/g,' ').trim();
    if(/‡∏õ‡∏£‡∏¥‡πâ‡∏ô.*QR|QR.*‡∏õ‡∏£‡∏¥‡πâ‡∏ô/i.test(t)) { sendOnce(); }
  }, true);

  window.addEventListener('DOMContentLoaded', function(){
    bindInputs();
    wrapQRHandlers();
    updateCacheFromDom();
  });
  window.addEventListener('focus', qFlush);
  window.addEventListener('online', qFlush);
})();
</script>





<script>
/* ==== UploadLog: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ "‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•" ‡πÑ‡∏õ Google Sheet ==== */
(function(){
  const WEBHOOK = 'https://script.google.com/macros/s/AKfycbwyn2HFclAjEQs72g84eqo5r9hhxUTdQ6Z4JbvFCarFBSbLv6qyta5oFcz6f0qM5Wv-UA/exec';
  const SHEET_UPLOAD = 'UploadLog_clean';

  function localISO(d){
    try{
      d = d ? new Date(d) : new Date();
      const tzo = -d.getTimezoneOffset();
      const sign = tzo >= 0 ? '+' : '-';
      const pad = n => String(Math.floor(Math.abs(n))).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${pad(tzo/60)}:${pad(tzo%60)}`;
    }catch(_){ return new Date().toISOString(); }
  }
  function $(sel, root){ return (root||document).querySelector(sel); }
  function $all(sel, root){ return Array.from((root||document).querySelectorAll(sel)); }
  function val(el){ return el ? String((el.value!==undefined?el.value:'')).trim() : ''; }
  function txt(el){ return el ? String((el.textContent||'')).trim() : ''; }

  

function parseUploadPanel(){
  const box = document.getElementById('pageUpload') || document;
  // date
  const dateInput = box.querySelector('input[type="date"], input[placeholder*="mm/dd"], input[type="text"]');
  let date_display = dateInput ? String(dateInput.value||'').trim() : '';

  // line
  let line = '';
  const lineSel = box.querySelector('select');
  if(lineSel) line = String(lineSel.value||'').trim();

  // file name detection (aggressive)
  let file_name = '';

  // A) direct from file input (most reliable when a file is chosen now)
  const fileInput = box.querySelector('input[type="file"]');
  if (fileInput && fileInput.files && fileInput.files[0]) {
    file_name = fileInput.files[0].name;
  }

  // B) scan visible text for last-looking filename
  if (!file_name) {
    const txt = (box.innerText || document.body.innerText || '').replace(/\s+/g,' ');
    // We'll collect all candidates that look like filename with extension
    const rxAll = /([^\s\/\\]+?\.(?:xlsx|xls|csv|json))/gi;
    let m;
    while((m = rxAll.exec(txt))){
      // exclude obvious UA tokens like "Edg/140.0.0.0" etc by filtering short tokens with '/'
      const cand = m[1];
      if (!/\/|\//.test(cand)) file_name = cand; // keep last
    }
  }

  // C) scan attribute hints
  if (!file_name) {
    const cand = box.querySelector('[data-file],[data-filename]');
    if (cand) file_name = (cand.getAttribute('data-file') || cand.getAttribute('data-filename') || '').trim();
  }

  return { date_display, line, file_name, rows_added: '' };
}
async function sendUploadLog(){
    const {date_display, line, file_name, rows_added} = parseUploadPanel();
    
    const payload = [{
      timestamp: localISO(),
      date_display: date_display || '',
      line: line || '',
      file_name: file_name || ''
    }];

    try{
      await fetch(WEBHOOK, {
        method: 'POST',
        mode: 'no-cors',
        headers: {'Content-Type':'text/plain'},
        body: JSON.stringify({ sheet: SHEET_UPLOAD, rows: payload })
      });
      console.log('‡∏™‡πà‡∏á UploadLog:', payload[0]);
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å UploadLog ‡πÅ‡∏•‡πâ‡∏ß');
    }catch(e){
      console.error(e);
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å UploadLog ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
    }
  }

  function injectUploadButton(){
    const box = document.getElementById('pageUpload');
    if(!box) return;
    // ‡∏´‡∏≤ toolbar ‡∏ö‡∏£‡∏¥‡πÄ‡∏ß‡∏ì‡∏õ‡∏∏‡πà‡∏° "‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ"
    const buttons = Array.from(box.querySelectorAll('button, a.btn, .btn'));
    const clearBtn = buttons.find(b => /‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà|‡∏•‡πâ‡∏≤‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ/i.test(txt(b)));
    const host = clearBtn ? clearBtn.parentElement : box;
    const btn = document.createElement('button');
    btn.type = 'button';
    btn.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå';
    btn.style.cssText = 'margin-left:8px;background:#22c55e;border:0;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;';
    btn.addEventListener('click', sendUploadLog);
    if(clearBtn && clearBtn.nextSibling){
      clearBtn.parentElement.insertBefore(btn, clearBtn.nextSibling);
    }else{
      host.appendChild(btn);
    }
  }

  window.addEventListener('DOMContentLoaded', injectUploadButton);
})();
</script>





<!-- ==== Begin: LineDailyLog Password-Locked Export (by ChatGPT) ==== -->
<style>
  /* Modal */
  #ldl-pass-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,.35); display: none; align-items: center; justify-content: center; z-index: 9999; }
  #ldl-pass-modal { background: #fff; width: clamp(280px, 90vw, 420px); border-radius: 14px; box-shadow: 0 10px 30px rgba(0,0,0,.2); overflow: hidden; font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif; }
  #ldl-pass-modal header { padding: 14px 16px; font-weight: 600; background: #0ea5e9; color: #fff; }
  #ldl-pass-modal .body { padding: 16px; }
  #ldl-pass-modal .row { display: flex; gap: 10px; align-items: center; }
  #ldl-pass-modal input[type="password"] { flex: 1; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 10px; outline: none; }
  #ldl-pass-modal footer { display: flex; justify-content: flex-end; gap: 8px; padding: 12px 16px 16px; }
  #ldl-pass-modal button { border: 0; border-radius: 10px; padding: 8px 14px; cursor: pointer; }
  #ldl-btn-cancel { background: #e5e7eb; }
  #ldl-btn-confirm { background: #0ea5e9; color: #fff; }

  /* Icon button */
  .ldl-locked-btn {
    /* LineDailyLog icon button */
    position: relative;
    width: 40px; height: 40px;
    display: inline-flex; align-items: center; justify-content: center;
    border-radius: 9999px;
    border: 0;
    background: #0ea5e9;
    color: #fff;
    cursor: pointer;
    margin-left: 8px;
  }
  .ldl-locked-btn:hover { filter: brightness(0.95); }
  .ldl-locked-btn[disabled] { opacity: .6; cursor: not-allowed; }
  .ldl-locked-btn svg { width: 20px; height: 20px; }

  /* small remaining badge */
  .ldl-badge {
    position: absolute; right: -3px; top: -3px;
    min-width: 18px; height: 18px;
    padding: 0 4px;
    background: #ef4444;
    color: #fff;
    border-radius: 9999px;
    font-size: 11px; line-height: 18px; text-align: center;
    font-weight: 700;
    pointer-events: none;
  }

  /* subtle tooltip using title attribute handled by browser */

  /* Generic toolbar icon buttons */
  .toolbar-icon-btn {
    position: relative;
    width: 36px; height: 36px;
    display: inline-flex; align-items: center; justify-content: center;
    border-radius: 10px;
    border: 1px solid #e5e7eb;
    background: #f9fafb;
    color: #111827;
    cursor: pointer;
    margin-right: 6px;
  }
  .toolbar-icon-btn:hover { background: #f3f4f6; }
  .toolbar-icon-btn svg { width: 18px; height: 18px; }

</style>

<div id="ldl-pass-modal-backdrop" role="dialog" aria-modal="true" aria-labelledby="ldl-pass-title">
  <div id="ldl-pass-modal">
    <header id="ldl-pass-title">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ä‡∏µ‡∏ï (LineDailyLog)</header>
    <div class="body">
      <div class="row">
        <label for="ldl-pass-input">‡∏£‡∏´‡∏±‡∏™:</label>
        <input id="ldl-pass-input" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™" autocomplete="off" />
      </div>
      <p id="ldl-pass-msg" style="color:#b91c1c; margin-top:8px; display:none;">‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
    </div>
    <footer>
      <button id="ldl-btn-cancel" type="button">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button id="ldl-btn-confirm" type="button">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
    </footer>
  </div>
</div>

<script>
(function(){
  const REQUIRED_PASS = '12345';
  const STORAGE_KEY   = 'LDL_UNLOCKED_V1';
  const STORAGE_REMAIN= 'LDL_UNLOCK_REMAIN_V1';
  const MAX_UNLOCK_USES = 3; // configurable
  const SHEET_NAME    = 'LineDailyLog';

  const $text = el => el ? String((el.textContent||'')).trim() : '';

  // ===== helpers for data extraction =====
  function localISO(d){
    try{
      d = d ? new Date(d) : new Date();
      const tzo = -d.getTimezoneOffset();
      const sign = tzo >= 0 ? '+' : '-';
      const pad = n => String(Math.floor(Math.abs(n))).padStart(2,'0');
      return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}T${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}${sign}${pad(tzo/60)}:${pad(tzo%60)}`;
    }catch(_){ return new Date().toISOString(); }
  }
  function findLineTable(){
    const tables = Array.from(document.querySelectorAll('table'));
    for(const tb of tables){
      const header = Array.from(tb.querySelectorAll('thead th')).map(t => $text(t)).join('|');
      if(/P\/?NO|Trim|Cut-?file|‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞|Materials/i.test(header)) return tb;
    }
    return null;
  }
  function normalizeKey(s){
    s = (s||'').trim();
    const map = {'P/NO ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢':'pno','P/NO':'pno','‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢':'pno','Trim':'trim','Cut-file':'cut_file','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞':'status','Materials':'materials','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á':'times','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)':'qty_cut','_d':'d','‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤':'when'};
    return map[s] || s.replace(/\s+/g,'_').toLowerCase();
  }
  function extractLineRows(){
    const table = findLineTable();
    if(!table) return [];
    const heads = Array.from(table.querySelectorAll('thead th')).map(th => normalizeKey($text(th)));
    const rows = [];
    for(const tr of Array.from(table.querySelectorAll('tbody tr'))){
      const tds = Array.from(tr.querySelectorAll('td'));
      if(!tds.length) continue;
      const row = {};
      heads.forEach((k, i) => row[k] = $text(tds[i]));
      rows.push(row);
    }
    return rows;
  }

  // ===== storage =====
  function isUnlocked(){ try { return localStorage.getItem(STORAGE_KEY) === '1'; } catch(_){ return false; } }
  function getRemain(){ try { return parseInt(localStorage.getItem(STORAGE_REMAIN)||'0', 10) || 0; } catch(_){ return 0; } }
  function setUnlocked(v, resetRemain=false){
    try {
      localStorage.setItem(STORAGE_KEY, v ? '1' : '');
      if(v){
        if(resetRemain || getRemain()<=0){
          localStorage.setItem(STORAGE_REMAIN, String(MAX_UNLOCK_USES));
        }
      }else{
        localStorage.setItem(STORAGE_REMAIN, '0');
      }
    } catch(_){}
  }
  function setRemain(n){ try { localStorage.setItem(STORAGE_REMAIN, String(Math.max(0, n|0))); } catch(_){ } }

  // ===== UI =====
  function iconLocked(){
    return '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M17 9h-1V7a4 4 0 10-8 0v2H7a2 2 0 00-2 2v7a2 2 0 002 2h10a2 2 0 002-2v-7a2 2 0 00-2-2zm-7-2a2 2 0 114 0v2h-4V7z"></path></svg>';
  }
  function iconSheet(){
    return '<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM8 7h5V3.5L18.5 9H8v8h8v2H8a1 1 0 01-1-1V8a1 1 0 011-1z"></path></svg>';
  }

  function updateButtonIcon(){
    const btn = document.getElementById('ldl-locked-export-btn');
    if(!btn) return;
    // Clear previous content
    btn.innerHTML = isUnlocked() ? iconSheet() : iconLocked();
    btn.title = isUnlocked() ? '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ä‡∏µ‡∏ï (‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á)' : '‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡∏ä‡∏µ‡∏ï';
    // Badge show remain
    if(isUnlocked()){
      const remain = getRemain();
      if(remain > 0){
        const badge = document.createElement('span');
        badge.className = 'ldl-badge';
        badge.textContent = String(remain);
        btn.appendChild(badge);
      }
    }
  }

  function relock(){
    setUnlocked(false);
    updateButtonIcon();
    const btn = document.getElementById('ldl-locked-export-btn');
    if(btn){ btn.disabled = false; }
  }

  async function sendLineLog(){
    const btn = document.getElementById('ldl-locked-export-btn');
    if(btn) btn.disabled = true;

    const rowsRaw = extractLineRows();
    if(!rowsRaw.length){ if(btn) btn.disabled = false; alert('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å'); return; }

    const payloadRows = rowsRaw.map(r => ({
      timestamp: localISO(),
      date_display: (document.getElementById('date')||{}).value || '',
      line: (document.getElementById('lineMain')||{}).value || '',
      pno: r.pno || '',
      trim: r.trim || '',
      cut_file: r.cut_file || '',
      status: r.status || '',
      materials: r.materials || '',
      times: r.times || '',
      qty_cut: r.qty_cut || '',
      when: r.when || r['‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤'] || ''
    }));

    const WEBHOOK = window.LINE_DAILYLOG_WEBHOOK || (window.LINE_DAILYLOG?.WEBHOOK) || 'https://script.google.com/macros/s/AKfycbwyn2HFclAjEQs72g84eqo5r9hhxUTdQ6Z4JbvFCarFBSbLv6qyta5oFcz6f0qM5Wv-UA/exec';
    try{
      await fetch(WEBHOOK, { method:'POST', mode:'no-cors', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ sheet: 'LineDailyLog', rows: payloadRows }) });
      alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏ä‡∏µ‡∏ï "LineDailyLog" ‡πÅ‡∏•‡πâ‡∏ß ('+payloadRows.length+' ‡πÅ‡∏ñ‡∏ß)');
      // consume one remain
      let remain = getRemain();
      remain = (remain>0 ? remain-1 : 0);
      if(remain <= 0){ relock(); }
      else{ setRemain(remain); if(btn) btn.disabled = false; updateButtonIcon(); }
    }catch(e){
      console.error(e);
      alert('‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
      if(btn) btn.disabled = false;
    }
  }

  function removeOriginalButtons(){
    const candidates = Array.from(document.querySelectorAll('button, a.btn, .btn'));
    for(const b of candidates){
      const t = $text(b);
      if(/‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å\s*Sheet\s*\(LineDailyLog\)/i.test(t)){
        if(b.id !== 'ldl-locked-export-btn'){ b.remove(); }
      }
    }
  }

  function injectLockedButton(){
    if(document.getElementById('ldl-locked-export-btn')) return;
    removeOriginalButtons();

    const buttons = Array.from(document.querySelectorAll('button, a.btn, .btn'));
    const excelBtn = buttons.find(b => /‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å\s*Excel/i.test($text(b)));
    const host = (excelBtn && excelBtn.parentElement) || (document.querySelector('.card-body, .toolbar, .filters, .container, main') || document.body);

    const btn = document.createElement('button');
    btn.id = 'ldl-locked-export-btn';
    btn.type = 'button';
    btn.className = 'ldl-locked-btn';
    btn.setAttribute('aria-label', '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Sheet (LineDailyLog)');

    btn.addEventListener('click', () => {
      if(isUnlocked()){ sendLineLog(); }
      else{ openModal(); }
    });

    if(excelBtn && excelBtn.nextSibling){
      excelBtn.parentElement.insertBefore(btn, excelBtn.nextSibling);
    }else{
      host.appendChild(btn);
    }
    updateButtonIcon();
  }

  // Modal
  const $backdrop = document.getElementById('ldl-pass-modal-backdrop');
  const $input    = document.getElementById('ldl-pass-input');
  const $msg      = document.getElementById('ldl-pass-msg');
  const $btnOK    = document.getElementById('ldl-btn-confirm');
  const $btnCancel= document.getElementById('ldl-btn-cancel');

  function openModal(){ $msg.style.display='none'; $input.value=''; $backdrop.style.display='flex'; setTimeout(()=>{ $input.focus(); }, 50); }
  function closeModal(){ $backdrop.style.display='none'; }
  function tryConfirm(){
    if(($input.value||'') !== REQUIRED_PASS){ $msg.style.display='block'; return; }
    closeModal();
    setUnlocked(true, /*resetRemain*/ true);
    updateButtonIcon();
  }

  $btnOK.addEventListener('click', tryConfirm);
  $btnCancel.addEventListener('click', closeModal);
  $input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryConfirm(); if(e.key==='Escape') closeModal(); });
  $backdrop.addEventListener('click', (e)=>{ if(e.target===$backdrop) closeModal(); });

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', injectLockedButton); }
  
  // ===== Toolbar: turn labeled buttons into icons =====
  function icon(name){
    switch(name){
      case '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î':      // list/bars
        return '<svg viewBox="0 0 24 24"><path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"/></svg>';
      case '‡∏Ñ‡πâ‡∏≤‡∏á':         // clock
        return '<svg viewBox="0 0 24 24"><path d="M12 1a11 11 0 1011 11A11.013 11.013 0 0012 1zm1 11H7v-2h4V5h2z"/></svg>';
      case '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß':    // check circle
        return '<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm-1 15l-5-5 1.41-1.41L11 14.17l6.59-6.58L19 9z"/></svg>';
      case '‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡πâ‡∏ô':   // chat bubble
        return '<svg viewBox="0 0 24 24"><path d="M2 3h20v14H6l-4 4V3z"/></svg>';
      case '‡∏™‡∏£‡∏∏‡∏õ':         // pie chart
        return '<svg viewBox="0 0 24 24"><path d="M11 2v10H2A10 10 0 0011 2zm2 0a10 10 0 019.95 9H13V2zm-2 20A10 10 0 012 12h10v10z"/></svg>';
      case '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV':   // file with arrow
        return '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM8 14h3v3l4-4-4-4v3H8v2z"/></svg>';
      case '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel': // spreadsheet
        return '<svg viewBox="0 0 24 24"><path d="M19 2H8a2 2 0 00-2 2v3H5a1 1 0 00-1 1v10a2 2 0 002 2h13a1 1 0 001-1V3a1 1 0 00-1-1zM6 9h6v3H6V9zm0 4h6v3H6v-3zm7-4h6v3h-6V9zm0 4h6v3h-6v-3z"/></svg>';
      case '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä':       // refresh
        return '<svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.95 7.95 0 0012 4a8 8 0 108 8h-2a6 6 0 11-6-6 5.96 5.96 0 014.24 1.76L14 10h8V2z"/></svg>';
      default:
        return '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>';
    }
  }

  function toIconButton(el, label){
    // Preserve existing click handlers; just change appearance
    el.classList.add('toolbar-icon-btn');
    el.setAttribute('aria-label', label);
    el.setAttribute('title', label);
    el.innerHTML = icon(label);
  }

  function transformToolbarButtons(){
    const targets = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','‡∏Ñ‡πâ‡∏≤‡∏á','‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß','‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡πâ‡∏ô','‡∏™‡∏£‡∏∏‡∏õ','‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV','‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel','‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä'];
    const nodes = Array.from(document.querySelectorAll('button, a.btn, .btn'));
    for(const node of nodes){
      const txt = (node.textContent||'').trim();
      const match = targets.find(t => new RegExp('^'+t+'\s*$', 'i').test(txt));
      if(match){
        // avoid transforming our LineDailyLog button
        if(node.id === 'ldl-locked-export-btn') continue;
        toIconButton(node, match);
      }
    }
  }

  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', () => { injectLockedButton(); transformToolbarButtons(); }); }
  else{ injectLockedButton(); transformToolbarButtons(); }
})();
</script>

<script>
// === Toolbar Icons: keep-as-icons with MutationObserver (debounced re-apply) ===
(function(){
  function debounce(fn, ms){
    let t; return function(){ clearTimeout(t); t=setTimeout(fn, ms||80); };
  }
  // We re-use/extend transformToolbarButtons if present, otherwise define it.
  function ensureTransform(){
    if(typeof window.transformToolbarButtons === 'function'){
      try{ window.transformToolbarButtons(); }catch(e){}
      return;
    }
    // Fallback minimal transformer (same target labels)
    const targets = ['‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î','‡∏Ñ‡πâ‡∏≤‡∏á','‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß','‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡πâ‡∏ô','‡∏™‡∏£‡∏∏‡∏õ','‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV','‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel','‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä'];
    const icon = (name)=>{
      switch(name){
        case '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î': return '<svg viewBox="0 0 24 24"><path d="M4 6h16v2H4V6zm0 5h16v2H4v-2zm0 5h16v2H4v-2z"/></svg>';
        case '‡∏Ñ‡πâ‡∏≤‡∏á': return '<svg viewBox="0 0 24 24"><path d="M12 1a11 11 0 1011 11A11.013 11.013 0 0012 1zm1 11H7v-2h4V5h2z"/></svg>';
        case '‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß': return '<svg viewBox="0 0 24 24"><path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm-1 15l-5-5 1.41-1.41L11 14.17l6.59-6.58L19 9z"/></svg>';
        case '‡∏°‡∏µ‡∏Ñ‡∏≠‡∏°‡πÅ‡∏°‡πâ‡∏ô': return '<svg viewBox="0 0 24 24"><path d="M2 3h20v14H6l-4 4V3z"/></svg>';
        case '‡∏™‡∏£‡∏∏‡∏õ': return '<svg viewBox="0 0 24 24"><path d="M11 2v10H2A10 10 0 0011 2zm2 0a10 10 0 019.95 9H13V2zm-2 20A10 10 0 012 12h10v10z"/></svg>';
        case '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV': return '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6zM8 14h3v3l4-4-4-4v3H8v2z"/></svg>';
        case '‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel': return '<svg viewBox="0 0 24 24"><path d="M19 2H8a2 2 0 00-2 2v3H5a1 1 0 00-1 1v10a2 2 0 002 2h13a1 1 0 001-1V3a1 1 0 00-1-1zM6 9h6v3H6V9zm0 4h6v3H6v-3zm7-4h6v3h-6V9zm0 4h6v3h-6v-3z"/></svg>';
        case '‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä': return '<svg viewBox="0 0 24 24"><path d="M17.65 6.35A7.95 7.95 0 0012 4a8 8 0 108 8h-2a6 6 0 11-6-6 5.96 5.96 0 014.24 1.76L14 10h8V2z"/></svg>';
        default: return '<svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/></svg>';
      }
    };
    const iconize = (el,label)=>{
      if(!el || el.dataset && el.dataset.iconized === '1') return;
      el.classList.add('toolbar-icon-btn');
      el.setAttribute('aria-label', label);
      el.setAttribute('title', label);
      el.innerHTML = icon(label);
      el.dataset.iconized = '1';
    };
    const nodes = Array.from(document.querySelectorAll('button, a.btn, .btn'));
    nodes.forEach(node=>{
      if(node.id === 'ldl-locked-export-btn') return;
      const text = (node.textContent||'').trim();
      const hit = targets.find(t => new RegExp('^'+t+'\s*$', 'i').test(text));
      if(hit) iconize(node, hit);
    });
  }

  const apply = debounce(ensureTransform, 80);

  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', apply, {once:true});
  }else{
    apply();
  }

  // Observe changes across the app (toolbar re-render, tab switch, etc.)
  const obs = new MutationObserver(apply);
  obs.observe(document.body, {childList:true, subtree:true});
  window.__toolbarIconObserver = obs;
})();
</script>


<script>
// === Keep LineDailyLog icon button persistent ===
(function(){
  function ensureLDL(){
    try{
      if(!document.getElementById('ldl-locked-export-btn') && typeof injectLockedButton === 'function'){
        injectLockedButton();
      }
    }catch(e){}
  }
  function debounce(fn, ms){ let t; return ()=>{ clearTimeout(t); t=setTimeout(fn, ms||80); }; }
  const apply = debounce(ensureLDL, 60);
  if(document.readyState === 'loading'){ document.addEventListener('DOMContentLoaded', apply, {once:true}); }
  else { apply(); }
  const obs = new MutationObserver(apply);
  obs.observe(document.body, {childList:true, subtree:true});
  window.__ldlPersistObserver = obs;
})();
</script>

<!-- ==== End: LineDailyLog Password-Locked Export (by ChatGPT) ==== -->



</body>
</html>
