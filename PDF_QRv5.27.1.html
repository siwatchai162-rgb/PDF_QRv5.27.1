<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF</title>
<style>
  :root{
    --bg:#f6f7fb;--card:#fff;--ink:#101828;--muted:#667085;--pri:#2563eb;
    --ok:#15803d;--warn:#b45309;--bad:#dc2626;--bd:#e5e7eb;--soft:#f8fafc;
  }
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:var(--bg);margin:0;color:var(--ink)}
  .wrap{max-width: 1600px;margin:24px auto;padding:0 16px}
  h1{margin:0 0 8px}
  .status{font-size:12px;color:var(--muted)}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .card{background:var(--card);border:1px solid var(--bd);border-radius:16px;box-shadow:0 8px 26px rgba(0,0,0,.06);padding:16px}
  .title{font-weight:700;margin:0 0 10px;display:flex;gap:8px;align-items:center}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .grid-bottom{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px}
  .left-only{grid-column:1/2}
  .span-all{grid-column:1 / -1}
  input,button,select{font:inherit}
  label{font-size:13px;color:#475467;display:block;margin:0 0 6px}
  input,select{padding:14px 16px;border:1px solid #cfd5e1;border-radius:10px;outline:0;background:#fff}
  input:focus,select:focus{border-color:#6b9cff;box-shadow:0 0 0 3px rgba(107,156,255,.25)}
  input:disabled{background:#f3f4f6;color:#94a3b8;cursor:not-allowed}
  .btn{padding:14px 16px;border:0;border-radius:10px;background:var(--pri);color:#fff;cursor:pointer}
  .btn.gray{background:#475569}      
  .row{display:grid;grid-template-columns:1fr 220px;gap:10px}
  .row2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .inline{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .qrbox{background:#fff;border:2px dashed var(--bd);border-radius:14px;padding:10px;display:inline-block}
  canvas{background:#fff;border-radius:10px}
  .filters{border:2px dashed var(--bd);border-radius:14px;background:#f8fafc;padding:16px;min-height:68px;color:#475467;display:grid;gap:12px;align-content:start}
  .filters .rowfit{display:grid;grid-template-columns:240px 1fr;gap:12px;align-items:end}
  .filters .rowfit3{display:grid;grid-template-columns:240px 240px 1fr;gap:12px;align-items:end}
  .list{display:grid;gap:10px;max-height:60vh;overflow:auto;padding-right:4px}
  .hidden{display:none !important}
  .item{display:flex;justify-content:space-between;align-items:center;padding:12px;border:1px solid var(--bd);border-radius:14px;background:#fff}
  .rowflex{display:flex;gap:12px;align-items:center}
  .meta{font-size:12px;color:#64748b}
  .qr-mini{border:1px dashed var(--bd);border-radius:12px;padding:6px}
  .modal{position:fixed;inset:0;display:none;flex-direction:column;background:rgba(0,0,0,.75);z-index:50}
  .modal.show{display:flex}
  .modal .top{background:#fff;padding:10px 14px;border-bottom:1px solid var(--bd)}
  .toolbar{display:flex;gap:8px;align-items:center}
  .grow{flex:1}
  .modal iframe{width:100%;height:100%;border:0;background:#f3f4f6}
  @media (max-width: 980px){
    .grid,.grid-bottom{grid-template-columns:1fr}
    .left-only{grid-column:auto}
    .row{grid-template-columns:1fr}
    .filters .rowfit{grid-template-columns:1fr}
    .filters .rowfit3{grid-template-columns:1fr}
    .searchShort{flex:1 1 auto; min-width:240px; width:auto}
  }
  .seg{display:flex;border:1px solid var(--bd);border-radius:10px;overflow:hidden;background:#fff}
  .seg button{border:0;padding:12px 16px;background:transparent;cursor:pointer;font-size:12px;color:#334155}
  .seg button+button{border-left:1px solid var(--bd)}
  .seg .active{background:var(--pri);color:#fff}
  .searchShort{flex:0 0 360px; max-width:45vw}

  /* Top nav */
  .tabs{display:flex;gap:8px;align-items:center;margin:8px 0 16px}
  .tab{padding:8px 12px;border:1px solid var(--bd);border-radius:999px;background:#fff;cursor:pointer;color:#334155}
  .tab.active{background:var(--pri);border-color:var(--pri);color:#fff}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#334155;font-size:12px;border:1px solid var(--bd)}
  .pill.ok{background:#dcfce7;border-color:#86efac;color:#14532d}
  .pill.bad{background:#fee2e2;border-color:#fecaca;color:#7f1d1d}

  /* Upload page */
  .uploader{display:grid;gap:12px}
  table{width:100%;border-collapse:separate;border-spacing:0;background:#fff;border:1px solid var(--bd);border-radius:12px;overflow:hidden}
  th,td{font-size:13px;border-bottom:1px solid var(--bd);padding:12px 16px;text-align:left}
  tbody tr:hover{background:#f8fafc;cursor:pointer}
  .hint{font-size:12px;color:#64748b}
  .passmodal{position:fixed;inset:0;display:none;place-items:center;background:rgba(0,0,0,.65);z-index:60}
  .passmodal.show{display:grid}
  .passcard{background:#fff;border-radius:14px;border:1px solid var(--bd);padding:16px;min-width:320px;max-width:92vw;box-shadow:0 10px 30px rgba(0,0,0,.25)}

  .title .inline input[type="date"]{padding:6px 10px;border-radius:8px}
  @media (max-width: 980px){
    .title{align-items:flex-start;gap:8px}
    .title .inline{margin-top:6px}
  }


  .title .inline select{padding:6px 10px;border-radius:8px}
  .title .inline label{white-space:nowrap}
  @media (max-width: 980px){
    .title{align-items:flex-start;gap:8px}
    .title .inline{flex-wrap:wrap}
  }


  /* clickable Cut-file */
  .cf-link{cursor:pointer;color:var(--pri);text-decoration:underline}
  .cf-link:focus,.cf-link:hover{text-decoration:none}
  /* --- Row coloring by status --- */
  .row-status-done td{ background:#e6ffed; }       /* green tint */
  .row-status-blocked td{ background:#ffe6e6; }    /* red tint */
  .row-status-progress td{ background:#e8f1ff; }   /* blue tint */
  /* filter bar */
  .status-filter-bar{display:flex;gap:8px;align-items:center;margin:8px 0 6px 0}
  .status-chip{border:1px solid #e5e7eb;border-radius:999px;padding:4px 10px;font-size:12px;cursor:pointer;background:#fff}
  .status-chip.active{border-color:var(--pri);box-shadow:0 0 0 2px rgba(59,130,246,.15)}

  /* Sticky header for extra table */
  #extraTable thead th{
    position: sticky;
    top: 0;
    background: #fff;
    z-index: 5;
    box-shadow: inset 0 -1px 0 #e2e8f0;
  }


/* === AUTO-HIDE COLOR FIELDS (UX for operators) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏µ‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏µ Roll ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà logic ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.hide-color-field{display:none !important;}


/* === AUTO-HIDE LIST MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#vAll, #vOne, #vHide {
  display: none !important;
}


/* === HIDE CUT MACHINE FIELD (Operator UX) === */
.hide-cut-machine { display:none !important; }

/* icon button */
.cm-icon-btn{
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.cm-icon-btn:hover{ background:#f1f5f9; }


/* === HIDE CREATE / UPDATE QR BUTTON (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö autoBuild ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.btn-make-qr,
button[onclick*="makeQR"]{
  display:none !important;
}


/* === SEARCH FIELD STATUS === */
#search.valid {
  border: 2px solid #16a34a !important;
  background: #ecfdf5;
}
#search.invalid {
  border: 2px solid #dc2626 !important;
  background: #fef2f2;
  animation: shake 0.25s linear 2;
}

@keyframes shake {
  0% { transform: translateX(0); }
  25% { transform: translateX(-2px); }
  50% { transform: translateX(2px); }
  75% { transform: translateX(-2px); }
  100% { transform: translateX(0); }
}


/* === HIDE STATUS FILTER BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ / ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
#statusFilterBar {
  display: none !important;
}


/* === HIDE VIEW MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
#extraViewToggle {
  display: none !important;
}


/* === HIDE SAVE STATUS BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
#quickSaveBar,
#saveAllStatusBtn,
#saveAllEveryRowBtn {
  display: none !important;
}


/* === HIDE LIBRARY STATUS TEXT (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: QR Maker ‚úÖ ¬∑ PDF.js ‚ùå */
#libStatus {
  display: none !important;
}

</style>
<script>
  // ---- Global state ----
  const CFG = { autoBuild:true, autoClear:true, qrWidth:120, offsetY:60 };
  const state={maker:false,pdf:false,listMode:'one', round:0, requireScan21:false, page:'main'};
  
  // *** GLOBAL STATE FOR SCROLL POSITION ***
  let _extraTableScrollTop = 0; 
  let _extraTableScrollLeft = 0;


  // ---- Expose setListMode early & globally ----
  window.setListMode = function(mode){
    state.listMode = (mode==='one'||mode==='hidden') ? mode : 'all';
    const a=document.getElementById('vAll'), o=document.getElementById('vOne'), h=document.getElementById('vHide');
    if(a&&o&&h){
      a.classList.toggle('active', state.listMode==='all');
      o.classList.toggle('active', state.listMode==='one');
      h.classList.toggle('active', state.listMode==='hidden');
    }
    const wrap=document.getElementById('listWrap');
    if(wrap) wrap.classList.toggle('hidden', state.listMode==='hidden');
    if(typeof renderList==='function') renderList();
    if(typeof updateCount==='function') updateCount();
  };

  // ---- Loader helpers ----
  async function ensureXLSX(){
    if(window.XLSX) return true;
    const ok = await smartLoad([
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js',
      'https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'
    ], ()=>!!window.XLSX);
    return !!ok || !!window.XLSX;
  }

  function smartLoad(urls, testFn){
    return new Promise((resolve)=>{
      function attempt(i){ if(i>=urls.length){ resolve(false); return; }
        const s=document.createElement('script'); s.src=urls[i]; s.async=true;
        s.onload=()=>setTimeout(()=>resolve(testFn()),0); s.onerror=()=>attempt(i+1);
        document.head.appendChild(s);
      } attempt(0);
    });
  }
  async function ensureQR(){
    if(!(window.QRCode&&QRCode.toCanvas) && !window.qrcode){
      await smartLoad([
        'https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js',
        'https://unpkg.com/qrcode@1.5.3/build/qrcode.min.js',
        'https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js'
      ], ()=>!!(window.QRCode&&QRCode.toCanvas)||!!window.qrcode);
      if(!window.QRCode && window.qrcode){
        window.QRCode={toCanvas:function(canvas,text,opts,cb){
          try{
            const qr=window.qrcode(0, (window.qrcode.ErrorCorrectLevel&&window.qrcode.ErrorCorrectLevel.M)||'M');
            qr.addData(String(text||'')); qr.make();
            const n=qr.getModuleCount(), margin=(opts&&opts.margin!=null)?opts.margin:2;
            const target=(opts&&opts.width)?opts.width:220; const cell=Math.max(1,Math.floor(target/(n+margin*2))); const size=cell*(n+margin*2);
            canvas.width=size; canvas.height=size; const ctx=canvas.getContext('2d');
            ctx.fillStyle='#fff'; ctx.fillRect(0,0,size,size); ctx.fillStyle='#000';
            for(let r=0;r<n;r++){ for(let c=0;c<n;c++){ if(qr.isDark(r,c)){ const x=(c+margin)*cell,y=(r+margin)*cell; ctx.fillRect(x,y,cell,cell);} } }
            cb&&cb(null);
          }catch(e){ cb&&cb(e); }
        }};
      }
    }
    state.maker=!!((window.QRCode&&QRCode.toCanvas)||window.qrcode);
    updateLibStatus();
  }
  async function ensurePDF(){
    if(window.pdfjsLib){ state.pdf=true; updateLibStatus(); return; }
    const ok = await smartLoad([
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js',
      'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js',
      'https://unpkg.com/pdfjs-dist@3.11.174/build/pdf.min.js']
      , ()=>!!window.pdfjsLib);
    if(ok && window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions){
      window.pdfjsLib.GlobalWorkerOptions.workerSrc='https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    state.pdf=!!window.pdfjsLib; updateLibStatus();
  }
  function updateLibStatus(){
    const el=document.getElementById('libStatus');
    el.textContent = (state.maker?'QR Maker ‚úÖ':'QR Maker ‚ùå')+' ¬∑ '+(state.pdf?'PDF.js ‚úÖ':'PDF.js ‚ùå');
  }

  // ---- DOM Ready ----
  document.addEventListener('DOMContentLoaded',()=>{
  try{ mirrorFromUpload(); }catch(e){}

  ensureQR(); updateLibStatus();
  const d=document.getElementById('date'); if(d && !d.value){ d.value=(new Date()).toISOString().split('T')[0]; }
  updateTabs();
  const up=document.getElementById('uplock'); if(up){ up.textContent='‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà'; up.className='pill bad'; }
  setTimeout(()=>{ try{ window.setListMode('one'); const v=document.getElementById('vOne'); if(v) v.focus(); }catch(e){} },0);

  // Hook change events from main filters to refresh extra data
  const d1=document.getElementById('date')||document.getElementById('mDateFilter')||document.getElementById('upDateFilter');
  const l1=document.getElementById('line')||document.getElementById('mLineFilter')||document.getElementById('upLineFilter');
  if(d1) d1.addEventListener('change', refreshExtraFromSheet);
  if(l1) l1.addEventListener('change', refreshExtraFromSheet);
  try{ refreshExtraFromSheet(); }catch(e){}

  // *** NEW: Cut Machine No Lock Check on Load ***
  const LS_CM_UNLOCK = 'cutMachineNo_unlocked';
  try{
    if(sessionStorage.getItem(LS_CM_UNLOCK)==='1'){
      window.unlockCutMachineNo();
    } else {
      window.lockCutMachineNo();
    }
  }catch(e){
    window.lockCutMachineNo();
  }
  // *** END NEW ***
});

  const $=id=>document.getElementById(id);
  const fmtSize=n=>{if(n===0)return'0 B';const k=1024,u=['B','KB','MB','GB'];const i=Math.floor(Math.log(n)/Math.log(k));return(n/Math.pow(k,i)).toFixed(2)+' '+u[i];};
  const fmtDate=t=>new Date(t).toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'});
  function toISODate(s){
    if(!s) return '';
    s=String(s).trim();
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return s;
    let m;
    if(m=s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/)) return `${m[3]}-${m[2]}-${m[1]}`;
    if(m=s.match(/^(\d{2})-(\d{2})-(\d{4})$/)) return `${m[3]}-${m[2]}-${m[1]}`;
    const d=new Date(s); if(!isNaN(d.getTime())) return d.toISOString().slice(0,10);
    return '';
  }

  function setInfo2Enabled(enabled,focusWhenOk=false){
    $('qr24').disabled=!enabled;
    if(enabled){ $('s_24').textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_24').className='status ok'; $('qr24').placeholder='‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà'; if(focusWhenOk)$('qr24').focus(); }
    else{ $('s_24').textContent='‚õî ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏°‡∏∑‡πà‡∏≠ 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô'; $('s_24').className='status'; $('qr24').value=''; $('qr24').placeholder='‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô'; }
  }
  function checkMatch(gate=false,focusWhenOk=false){
    const a=$('last2').value.trim(); const b=$('fileName').value.trim().slice(-2); let ok=false;
    if(a&&b){ ok=(a===b); $('s_match').textContent = ok ? '‚úÖ ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô' : `‚ùå ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô (${b} ‚â† ${a})`; $('s_match').className='status '+(ok?'ok':'bad'); }
    else{$('s_match').textContent='-';$('s_match').className='status';}
    if(gate){
      if(state.requireScan21){ setInfo2Enabled(false,false); }
      else { setInfo2Enabled(ok,focusWhenOk); }
    }
    return ok;
  }
  function updateLast2(){
    const name=$('fileName').value.trim();
    if(name.length>=2){ $('last2').value=name.slice(-2); $('s_last2').textContent='‚úÖ ‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ ‚Äú'+$('last2').value+'‚Äù'; $('s_last2').className='status ok'; }
    else if(name.length===1){ $('last2').value=name; $('s_last2').textContent='‚ö†Ô∏è ‡∏°‡∏µ‡πÄ‡∏û‡∏µ‡∏¢‡∏á 1 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_last2').className='status warn'; }
    else{ $('last2').value=''; $('s_last2').textContent='‡∏à‡∏∞‡∏ï‡∏±‡∏î 2 ‡∏ï‡∏±‡∏ß‡∏ó‡πâ‡∏≤‡∏¢‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥'; $('s_last2').className='status'; }
    checkMatch(true,false);
  }
  function onQR21(){
    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö Roll ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà (Uppercase) ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    let v = $('qr21').value;
    const upper = v.toUpperCase();
    if(v !== upper){
      $('qr21').value = upper;
      v = upper;
    }

    if(v.length===21){
      const cut=v.substring(14,16); $('last2').value=cut; $('s_21').textContent='‚úÖ ‡∏™‡∏Å‡∏±‡∏î ‚Äú'+cut+'‚Äù ‡∏à‡∏≤‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á 15-16'; $('s_21').className='status ok';
      state.requireScan21=false;
      const ok=checkMatch(true,true); if(!ok){ $('qr21').focus(); }
    }else if(v.length<21){ $('s_21').textContent='‚è≥ '+v.length+'/21'; $('s_21').className='status'; setInfo2Enabled(false,false); }
    else{ $('s_21').textContent='‚ùå ‡πÄ‡∏Å‡∏¥‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ('+v.length+')'; $('s_21').className='status bad'; setInfo2Enabled(false,false); }
  }
  function onQR24(){
    // ‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö RF ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà ‡πÅ‡∏•‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏≤‡∏ß = 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
    let vRaw = $('qr24').value;
    // ‡∏•‡∏ö‡∏ä‡πà‡∏≠‡∏á‡∏ß‡πà‡∏≤‡∏á + ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏ç‡πà
    let v = vRaw.replace(/\s/g,'').toUpperCase();
    if(v !== vRaw){ $('qr24').value = v; }

    if(v.length === 24){
      $('s_24').textContent='‚úÖ RF ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)';
      $('s_24').className='status ok';
      if(CFG.autoBuild){ makeQR(); }
    }
    else if(v.length < 24){
      $('s_24').textContent='‚õî RF ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ('+v.length+'/24)';
      $('s_24').className='status bad';
    }
    else{
      $('s_24').textContent='‚ùå RF ‡πÄ‡∏Å‡∏¥‡∏ô 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ('+v.length+'/24)';
      $('s_24').className='status bad';
      // ‡∏ï‡∏±‡∏î‡πÄ‡∏Å‡∏¥‡∏ô‡∏ó‡∏¥‡πâ‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏™‡πÅ‡∏Å‡∏ô‡∏ú‡∏¥‡∏î
      $('qr24').value = v.substring(0,24);
    }
  }
  // VVVV ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï collectData ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏° cutMachineNo VVVV
  function collectData(){
    const name=$('fileName').value.trim(), info2=$('qr24').value.trim(), date=$('date').value;
    const line = $('line') ? $('line').value.trim() : '';
    const cutMachineNo = $('cutMachineNo') ? $('cutMachineNo').value.trim() : ''; // NEW
    
    let base = (name&&info2&&date)?(name+'|'+info2+'|'+date):'';
    
    if(!base) return '';
    
    base = line ? base+'|'+line : base;
    return cutMachineNo ? base+'|'+cutMachineNo : base; // NEW: ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo
  }
  // ^^^^ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï collectData ‡πÉ‡∏´‡πâ‡∏£‡∏ß‡∏° cutMachineNo ^^^^
  async function makeQR(){

  // === GUARD: Require Roll (qr21) and RF (qr24) ===
  const _roll = (document.getElementById('qr21')?.value || '').trim();
  const _rf   = (document.getElementById('qr24')?.value || '').trim();
  if(!_roll || !_rf){
    alert('‚ùå ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Roll ‡πÅ‡∏•‡∏∞ RF ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR');
    return false;
  }

    await ensureQR();
    if(!(window.QRCode&&QRCode.toCanvas)){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏™‡∏£‡πâ‡∏≤‡∏á QR ‚Äî ‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ô‡πá‡∏ï'); return; }
    const data=collectData(); if(!data){ return; }
    return new Promise(function(resolve){
      QRCode.toCanvas($('qrCanvas'), data, {width:180, margin:2}, function(err){
        if(err){ console.error(err); resolve(false); return; }
        renderListQR(data);
        if(CFG.autoClear){
          $('qr21').value=''; $('s_21').textContent='‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‚Ä¶'; $('s_21').className='status';
          $('qr24').value=''; $('s_24').textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; $('s_24').className='status ok';
          $('qr21').focus();
        }
        resolve(true);
      });
    });
  }

  let allFiles=[], viewFiles=[], currentIdx=0, blobURL=null;
  function loadFolder(){
    // *******************************************************************
    // ** ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .pdf, .tif, ‡πÅ‡∏•‡∏∞ .tiff (‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡∏ï‡∏±‡∏ß‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡πá‡∏Å/‡πÉ‡∏´‡∏ç‡πà) **
    // *******************************************************************
    const files=[...$('folder').files].filter(f=>/\.(pdf|tif|tiff)$/i.test(f.name)); 
    allFiles=files; viewFiles=files; currentIdx=0;
    renderList(); updateCount();
    if(files.length){
      // ‡∏ï‡∏±‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .pdf, .tif, .tiff ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
      if(!$('fileName').value) $('fileName').value=files[0].name.replace(/\.(pdf|tif|tiff)$/i,'');
      if(!$('date').value){ const t=new Date(files[0].lastModified); $('date').value=t.toISOString().split('T')[0]; }
      updateLast2();
    }
  }
  function updateCount(){
    const base = allFiles.length? allFiles.length + ' ‡πÑ‡∏ü‡∏•‡πå' : '‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå';
    if(!allFiles.length){ $('fileCount').textContent=base; return; }
    if(state.listMode==='one'){ $('fileCount').textContent='1 ‡∏à‡∏≤‡∏Å ' + allFiles.length + ' ‡πÑ‡∏ü‡∏•‡πå'; }
    else if(state.listMode==='hidden'){ $('fileCount').textContent='‡∏ã‡πà‡∏≠‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‚Ä¢ ‡∏£‡∏ß‡∏° ' + allFiles.length + ' ‡πÑ‡∏ü‡∏•‡πå'; }
    else{ $('fileCount').textContent=allFiles.length===viewFiles.length ? (allFiles.length+' ‡πÑ‡∏ü‡∏•‡πå') : (viewFiles.length+' ‡∏à‡∏≤‡∏Å '+allFiles.length+' ‡πÑ‡∏ü‡∏•‡πå'); }
  }
  function renderList(){
    const q=$('search').value?$('search').value.toLowerCase():'';
    // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡∏Ñ‡∏≥‡∏ô‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• (.pdf, .tif, .tiff)
    viewFiles=q?allFiles.filter(f=>f.name.toLowerCase().replace(/\.(pdf|tif|tiff)$/i,'').includes(q) || f.name.toLowerCase().includes(q)):allFiles.slice();
    $('listWrap').classList.toggle('hidden', state.listMode==='hidden');
    const box=$('list');
    if(state.listMode==='hidden'){ updateCount(); return; }

    const listToShow = (state.listMode==='one' && viewFiles.length) ? [viewFiles[0]] : viewFiles;
    if(!listToShow.length){ box.innerHTML='<div class="meta">‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>'; updateCount(); return; }

    let html='';
    listToShow.forEach(function(f){
      html+='<div class="item">'+
        '<div class="rowflex">'+
          '<div class="qr-mini"><canvas class="qr-small" width="90" height="90"></canvas></div>'+
          '<div><div><strong>'+f.name+'</strong></div>'+
          '<div class="meta">'+fmtSize(f.size)+' ‚Ä¢ '+fmtDate(f.lastModified)+'</div></div>'+
        '</div>'+
        '<button class="btn" data-open="'+f.name.replace(/"/g,'&quot;')+'">üëÅÔ∏è ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° QR</button>'+
      '</div>';
    });
    box.innerHTML=html;
    Array.prototype.forEach.call(document.querySelectorAll('[data-open]'), function(btn){
      btn.addEventListener('click', function(){ openPreview(btn.getAttribute('data-open')); });
    });
    const latest = $('qrCanvas').width ? collectData() : '';
    if(latest) renderListQR(latest);
    updateCount();
  }
  function renderListQR(data){ if(!(window.QRCode&&QRCode.toCanvas)) return; Array.prototype.forEach.call(document.querySelectorAll('.qr-small'), function(c){ QRCode.toCanvas(c, data, {width:90, margin:2}, function(){}); }); }

  function openPreview(name){
    const idx=viewFiles.findIndex(function(f){ return f.name===name; }); if(idx<0) return; currentIdx=idx;
    const f=viewFiles[currentIdx];
    // ‡∏ï‡∏±‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .pdf, .tif, .tiff ‡∏≠‡∏≠‡∏Å
    if(!$('fileName').value) $('fileName').value=f.name.replace(/\.(pdf|tif|tiff)$/i,'');
    if(!$('date').value){ const t=new Date(f.lastModified); $('date').value=t.toISOString().split('T')[0]; }
    updateLast2();
    if(blobURL) URL.revokeObjectURL(blobURL);
    blobURL=URL.createObjectURL(f); $('viewer').src=blobURL; $('mName').textContent=f.name; $('mPos').textContent=(currentIdx+1)+'/'+viewFiles.length; $('modal').classList.add('show');
  }
  function closePreview(){ $('modal').classList.remove('show'); $('viewer').src=''; if(blobURL){ URL.revokeObjectURL(blobURL); blobURL=null; } }
  function goPrev(){ if(currentIdx>0) openPreview(viewFiles[currentIdx-1].name); }
  function goNext(){ if(currentIdx<viewFiles.length-1) openPreview(viewFiles[currentIdx+1].name); }
  function doPrint(){ const f=viewFiles[currentIdx]; if(!f) return; const url=URL.createObjectURL(f); const w=window.open(url,'_blank'); if(w){ w.onload=function(){ setTimeout(function(){ w.print(); }, 400); }; } setTimeout(function(){ URL.revokeObjectURL(url); }, 10000); }

  async function printWithQR(){
    await ensurePDF(); await ensureQR();
    const f=viewFiles[currentIdx]; if(!f){ alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏à‡∏≤‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå'); return; }
    if(!$('qrCanvas').width){ const ok=await makeQR(); if(!ok) return; }
    const qrCanvas=$('qrCanvas'); 
    const qrW=parseInt(CFG.qrWidth||120,10); 
    const OFFSET = 20; // <--- ‡∏£‡∏∞‡∏¢‡∏∞‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ã‡πâ‡∏≤‡∏¢/‡∏ö‡∏ô
    
    const buf = await f.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data: buf}).promise;
    const images=[];
    for(var i=1;i<=pdf.numPages;i++){
      const page=await pdf.getPage(i);
      const viewport=page.getViewport({scale:1.2});
      const c=document.createElement('canvas'); const ctx=c.getContext('2d');
      c.width=viewport.width; c.height=viewport.height;
      await page.render({canvasContext:ctx, viewport:viewport}).promise;
      
      // *** ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô x ‡πÄ‡∏õ‡πá‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏à‡∏≤‡∏Å‡∏Ç‡∏ß‡∏≤ ***
      const w=qrW; 
      const x=c.width - w - OFFSET; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á X: ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á Canvas - ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á QR - 20px (‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô)
      const y=OFFSET; // ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á Y: ‡∏à‡∏≤‡∏Å‡∏Ç‡∏≠‡∏ö‡∏ö‡∏ô 20 ‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•
      
      ctx.drawImage(qrCanvas, x, y, w, w);
      images.push(c.toDataURL('image/png'));
    }
    const win=window.open('', '_blank');
// ... (‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠)
    const doc=win.document; doc.open(); doc.close();
    doc.title='‡∏û‡∏¥‡∏°‡∏û‡πå‡∏û‡∏£‡πâ‡∏≠‡∏° QR';
    const style=doc.createElement('style');
    style.textContent='@page{size:A4;margin:0} body{margin:0;background:#fff} img{display:block;width:100%} @media print{ img{page-break-after:always} img:last-child{page-break-after:auto} }';
    doc.head.appendChild(style);
    images.forEach(function(src){ var im=doc.createElement('img'); im.src=src; doc.body.appendChild(im); });
    win.focus(); setTimeout(function(){ win.print(); }, 600);
  }

  // *** NEW: Cut Machine No Lock Control ***
  const LS_CM_UNLOCK = 'cutMachineNo_unlocked';
  
  window.lockCutMachineNo = function(){
    const sel = document.getElementById('cutMachineNo');
    const status = document.getElementById('cmLockStatus');
    const btn = document.getElementById('btnUnlockCM');
    if(sel) sel.disabled = true;
    if(status){ status.textContent = 'üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà'; status.className = 'pill bad'; }
    if(btn){ btn.textContent = '‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å'; btn.onclick = window.goUnlockCM; btn.classList.add('gray'); }
    try{ sessionStorage.removeItem(LS_CM_UNLOCK); }catch(e){} // Clear session unlock status
  }

  window.unlockCutMachineNo = function(){
    const sel = document.getElementById('cutMachineNo');
    const status = document.getElementById('cmLockStatus');
    const btn = document.getElementById('btnUnlockCM');
    if(sel) sel.disabled = false;
    if(status){ status.textContent = 'üîì ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß'; status.className = 'pill ok'; }
    if(btn){ btn.textContent = '‡∏•‡πá‡∏≠‡∏Å'; btn.onclick = window.lockCutMachineNo; btn.classList.remove('gray'); }
    try{ sessionStorage.setItem(LS_CM_UNLOCK, '1'); }catch(e){} // Set session unlock status
  }

  window.goUnlockCM = function(){
    document.getElementById('passModal').classList.add('show');
    document.getElementById('passModal').setAttribute('data-target-unlock','cutMachineNo'); // Mark target
    setTimeout(()=>document.getElementById('passcode').focus(), 0);
  }
  // *** END NEW ***


  // Tabs
  function showPage(p){
    const prevPage = state.page;
    const prev = state.page;
    state.page = p;
    document.getElementById('pageMain').classList.toggle('hidden', p!=='main');
    if(p==='main'){ try{ mirrorFromUpload(); }catch(e){} }
    document.getElementById('pageUpload').classList.toggle('hidden', p!=='upload');
    updateTabs();
    // Added: hook changes from main date/line filters to refresh the extra sheet view
    (function(){
      const d1 = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter');
      const l1 = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter');
      if(d1) d1.addEventListener('change', refreshExtraFromSheet);
      if(l1) l1.addEventListener('change', refreshExtraFromSheet);
      try{ refreshExtraFromSheet(); }catch(e){}
    })();
    if(prev==='upload' && p!=='upload'){
      document.getElementById('uplock').textContent='‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà';
      document.getElementById('uplock').className='pill bad';
    }
  }
  // VVVV RENDER (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà: ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏ö‡∏ö‡πÄ‡∏á‡∏µ‡∏¢‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö‡∏ï‡∏≤)
  function updateTableBody(rows, columns, sheetName, sort = null) {
    const tBody = document.getElementById('tableBody');
    if (!tBody) return;

    // 1. ‡∏ã‡πà‡∏≠‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏´‡πá‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠‡∏Ç‡∏≤‡∏ß/‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
    tBody.style.visibility = 'hidden'; //

    try {
      // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å (‡πÉ‡∏ô‡∏Ç‡∏ì‡∏∞‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏≠‡∏¢‡∏π‡πà)
      tBody.innerHTML = '';

      // ‡πÉ‡∏ä‡πâ DocumentFragment ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏î‡∏µ‡∏ï‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ)
      const frag = document.createDocumentFragment();

      for (let i = 0; i < rows.length; i++) {
        const row = rows[i];
        const tr = document.createElement('tr');

        // --- ‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏™‡πà‡∏™‡∏µ‡πÅ‡∏ñ‡∏ß‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ (Logic ‡πÄ‡∏î‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì) ---
        const statusIdx = columns.indexOf('Status');
        if (statusIdx !== -1) {
          const st = (row[statusIdx] || '').toString().toLowerCase();
          if (st.includes('done') || st.includes('‡πÄ‡∏™‡∏£‡πá‡∏à')) tr.classList.add('row-status-done');
          else if (st.includes('block') || st.includes('‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤')) tr.classList.add('row-status-blocked');
          else if (st.includes('progress') || st.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥')) tr.classList.add('row-status-progress');
        }

        for (let j = 0; j < columns.length; j++) {
          const td = document.createElement('td');
          const val = row[j] === undefined || row[j] === null ? '' : row[j];

          // ‡∏õ‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• Column ‡∏û‡∏¥‡πÄ‡∏®‡∏©
          if (columns[j] === 'Cut-file' && val) {
            td.innerHTML = `<span class="cf-link" onclick="openCutFile('${val}')">${val}</span>`;
          } else {
            td.textContent = val;
          }
          tr.appendChild(td);
        }
        frag.appendChild(tr);
      }

      // ‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏µ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß
      tBody.appendChild(frag);

      // 2. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ‡∏à‡∏∂‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏≠‡∏≠‡∏Å‡∏°‡∏≤ ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏à‡∏∞‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÇ‡∏î‡∏¢‡πÑ‡∏°‡πà‡πÄ‡∏´‡πá‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö
      tBody.style.visibility = 'visible'; //

    } catch (e) {
      console.error("Render Error:", e);
      // ‡πÉ‡∏ô‡∏Å‡∏£‡∏ì‡∏µ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ Error ‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏∞‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÑ‡∏î‡πâ‡∏õ‡∏Å‡∏ï‡∏¥
      tBody.style.visibility = 'visible';
    }
  }
  function goUpload(){
    document.getElementById('passModal').classList.add('show');
    setTimeout(()=>document.getElementById('passcode').focus(), 0);
  }
  function cancelPass(){ document.getElementById('passModal').classList.remove('show'); document.getElementById('passcode').value=''; document.getElementById('passMsg').textContent=''; }

  // *** UPDATED: tryPass() to handle cutMachineNo unlock ***
  window.tryPass = function(){
    const v=document.getElementById('passcode').value.trim();
    const target = document.getElementById('passModal').getAttribute('data-target-unlock');

    if(v==='12345'){
      if(target==='cutMachineNo'){
        window.unlockCutMachineNo();
        document.getElementById('passModal').removeAttribute('data-target-unlock');
        cancelPass();
      }else{
        document.getElementById('uplock').textContent='‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß';
        document.getElementById('uplock').className='pill ok';
        cancelPass();
        showPage('upload');
      }
    }else{
      document.getElementById('passMsg').textContent='‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á';
      document.getElementById('passMsg').className='status bad';
    }
  }
  // *** END UPDATED tryPass() ***

  // Round control
  function startNewRound(){
    state.round += 1;
    state.requireScan21 = true;
    $('qr21').value=''; $('s_21').textContent='‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‚Ä¶'; $('s_21').className='status';
    $('qr24').value=''; setInfo2Enabled(false,false);
    $('qr21').focus();
  }
  function clearSearch(){
    $('search').value='';
    $('fileName').value='';
    updateLast2();
    renderList();
    $('search').focus();
  }
  function onSearchInput(){
    renderList();
    const term=$('search').value.trim();
    // ‡∏ï‡∏±‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .pdf, .tif, .tiff ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    $('fileName').value=term.replace(/\.(pdf|tif|tiff)$/i,''); 
    updateLast2();
  }
  function onSearchDone(){
    const term=$('search').value.trim();
    if(term.length>0){
      // ‡∏ï‡∏±‡∏î‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏• .pdf, .tif, .tiff ‡∏≠‡∏≠‡∏Å
      $('fileName').value=term.replace(/\.(pdf|tif|tiff)$/i,'');
      updateLast2();
      startNewRound();
    }
  }

  // ===== Upload support (enhanced with date + line filters) =====
  let uploadRows=[];
  function handleUploadFile(files){
    uploadRows=[];
    const f=files&&files[0]; if(!f){ $('upStatus').textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå'; $('upTable').innerHTML=''; return; }
    const name = f.name || '';
    $('upStatus').textContent='‡πÑ‡∏ü‡∏•‡πå: '+name+' ‚Ä¢ '+fmtSize(f.size);
    // Excel first
    if(/\.(xlsx|xls)$/i.test(name)){
      (async()=>{
        const ok = await ensureXLSX();
        if(!ok){ $('upStatus').textContent='‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‡∏≠‡πà‡∏≤‡∏ô Excel ‡πÑ‡∏î‡πâ (‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå‡∏´‡∏£‡∏∑‡∏≠ CDN ‡∏•‡πà‡∏°)'; return; }
        try{
          const buf = await f.arrayBuffer();
          const wb = XLSX.read(buf, {type:'array'});
          const sheetName = wb.SheetNames[0];
          const ws = wb.Sheets[sheetName];
          const json = XLSX.utils.sheet_to_json(ws, {defval:'', raw:false});
          buildRowsFromJSON(json);
          $('upStatus').textContent = '‡∏≠‡πà‡∏≤‡∏ô Excel ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‚Ä¢ ‡πÅ‡∏ú‡πà‡∏ô‡∏á‡∏≤‡∏ô: '+sheetName+' ‚Ä¢ '+json.length+' ‡πÅ‡∏ñ‡∏ß';
        }catch(e){
          $('upStatus').textContent='‡∏≠‡πà‡∏≤‡∏ô Excel ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message;
          $('upTable').innerHTML='';
        }
      })();
      return;
    }
    // JSON
    const reader=new FileReader();
    if(/\.json$/i.test(name)){
      reader.onload=function(){ try{ const data=JSON.parse(reader.result); buildRowsFromJSON(data); }catch(e){ $('upStatus').textContent='‡∏≠‡πà‡∏≤‡∏ô JSON ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: '+e.message; $('upTable').innerHTML=''; } };
      reader.readAsText(f);
      return;
    }
    // CSV (default)
    reader.onload=function(){ buildRowsFromCSV(reader.result); };
    reader.readAsText(f,'utf-8');
  }
  function buildRowsFromJSON(data){
    if(Array.isArray(data)){ uploadRows=data; } else if(data && Array.isArray(data.rows)){ uploadRows=data.rows; } else { uploadRows=[data]; }
    uploadRows=uploadRows.map(r=>{ const d=r.date||r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']||r['Date']||''; return Object.assign({}, r, {_d: toISODate(d)}); });
    populateLineOptions();
    renderUploadTable();
  }
  function buildRowsFromCSV(text){
    const lines=text.split(/\r?\n/).filter(l=>l.trim().length>0);
    if(lines.length===0){ $('upTable').innerHTML='<div class="status">‡πÑ‡∏ü‡∏•‡πå‡∏ß‡πà‡∏≤‡∏á</div>'; return; }
    const header=lines[0].split(',').map(s=>s.trim());
    const rows=[];
    for(let i=1;i<lines.length;i++){
      const cols=lines[i].split(','); const obj={};
      header.forEach((h,idx)=>{ obj[h]= (cols[idx]||'').trim(); });
      rows.push(obj);
    }
    uploadRows=rows.map(r=>{ const d=r.date||r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà']||r['Date']||''; return Object.assign({}, r, {_d: toISODate(d)}); });
    populateLineOptions();
    renderUploadTable();
  }

  // Helper to read common field names
  function normalizeField(obj, names){
    for(const k of names){
      if(obj[k]!==undefined) return obj[k];
      const hit = Object.keys(obj).find(x=>x.toLowerCase()===String(k).toLowerCase());
      if(hit) return obj[hit];
    }
    return '';
  }

  // Build the line dropdown (unique values from uploaded data, plus defaults)
  function populateLineOptions(){
    const sel = $('upLineFilter');
    if(!sel) return;
    const values = new Set(['', 'J69P','J30A','J30SXK','J72A','J03M','‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏¥‡∏ï']);
    (uploadRows||[]).forEach(r=>{
      const v = String(normalizeField(r, ['line','Line','‡πÑ‡∏•‡∏ô‡πå','‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï','productionLine','prodLine'])).trim();
      if(v) values.add(v);
    });
    const current = sel.value;
    sel.innerHTML='';
    values.forEach(v=>{
      const opt=document.createElement('option');
      opt.value=v; opt.textContent = v ? ('‡πÑ‡∏•‡∏ô‡πå '+v) : '‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî';
      sel.appendChild(opt);
    });
    if(values.has(current)) sel.value=current;
  }

  function getUploadRowsByDate(iso){
    if(!iso) return [];
    if(!Array.isArray(uploadRows) || uploadRows.length===0) return [];
    return uploadRows.filter(r=> (r._d||'')===iso);
  }

  function numberOrZero(v){
    const n = parseFloat(String(v).replace(/[, ]/g,''));
    return isNaN(n)?0:n;
  }

  function renderUploadTable(){
    try{ mirrorFromUpload(); }catch(e){}

    if(!uploadRows.length){ $('upTable').innerHTML='<div class="status">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏™‡∏î‡∏á</div>'; return; }
    const want=$('upDateFilter')?$('upDateFilter').value:'';
    const wantLine=$('upLineFilter')?$('upLineFilter').value:'';
    let rows = want? uploadRows.filter(r=>r._d===want) : uploadRows.slice();
    if(wantLine){
      rows = rows.filter(r=> String(normalizeField(r, ['line','Line','‡πÑ‡∏•‡∏ô‡πå','‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï','productionLine','prodLine'])).trim()===wantLine);
    }
    const keys=new Set();
    rows.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
    const cols=[...keys];
    let html='<div class="hint">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å (‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á ‚Äú‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‚Äù, ‚Äú‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‚Äù, ‚Äú‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‚Äù ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)';
    if(want){ html+=' ‚Ä¢ ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: <strong>'+want+'</strong>'; }
    if(wantLine){ html+=' ‚Ä¢ ‡πÑ‡∏•‡∏ô‡πå: <strong>'+wantLine+'</strong>'; }
    html+='</div>';
    html+='<table><thead><tr>';
    cols.forEach(c=>{ html+='<th>'+c+'</th>'; });
    html+='</tr></thead><tbody>';
    rows.forEach((r,idx)=>{
      html+='<tr data-idx="'+idx+'">';
      cols.forEach(c=>{ html+='<td>'+ (r[c]!==undefined ? String(r[c]) : '') +'</td>'; });
      html+='</tr>';
    });
    html+='</tbody></table>';
    $('upTable').innerHTML=html;
    Array.prototype.forEach.call(document.querySelectorAll('#upTable tbody tr'), tr=>{
      tr.addEventListener('click', function(){
        const i=parseInt(tr.getAttribute('data-idx'),10);
        const wantDate=$('upDateFilter')?$('upDateFilter').value:'';
        const wantLine=$('upLineFilter')?$('upLineFilter').value:'';
        let idx=i;
        let rows2 = wantDate? uploadRows.filter(r=>r._d===wantDate) : uploadRows.slice();
        if(wantLine){
          rows2 = rows2.filter(r=> String(normalizeField(r, ['line','Line','‡πÑ‡∏•‡∏ô‡πå','‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï','productionLine','prodLine'])).trim()===wantLine);
        }
        const r = rows2[i];
        idx=uploadRows.indexOf(r);
        pickRow(idx);
      });
    });
  }

  function pickRow(i){
    const r=uploadRows[i]||{};
    const fname = r.fileName || r.filename || r.name || r['‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå'] || r['filename'] || r['FILE'] || '';
    const date  = r.date || r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] || r['date'] || '';
    const line  = normalizeField(r, ['line','Line','‡πÑ‡∏•‡∏ô‡πå','‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï','productionLine','prodLine']);
    $('search').value = fname;
    onSearchInput();
    const want=$('upDateFilter')?$('upDateFilter').value:'';
    if(want){ $('date').value = want; } else if(date){ $('date').value = toISODate(date) || date; }
    if(line){ $('line').value = line; }
    showPage('main');
    onSearchDone();
  }

  // ---- Mirror upload data into main filters (now respects line) ----
  function getRowsFilteredByMain(){
    const iso = $('date') ? $('date').value : '';
    const selectedLine = $('line') ? $('line').value.trim() : '';
    if(!iso) return [];
    let rows = getUploadRowsByDate(iso);
    if(selectedLine){
      rows = rows.filter(r=> String(normalizeField(r, ['line','Line','‡πÑ‡∏•‡∏ô‡πå','‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï','productionLine','prodLine'])).trim()===selectedLine);
    }
    return rows;
  }
  function mirrorFromUpload(){
    const box = $('mirrorBox');
    if(!box) return;
    const iso = $('date') ? $('date').value : '';
    const line = $('line') ? $('line').value.trim() : '';
    if(!iso){ 
      // *** Silent Reset: No date selected ***
      const newHtml = '<div class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>';
      if(box.innerHTML.trim() !== newHtml.trim()){
          box.innerHTML = newHtml;
      }
      return; 
    }
    const rows = getRowsFilteredByMain();
    if(rows.length===0){ 
      // *** Silent Reset: No data found ***
      const newHtml = '<div class="status">‚Äú‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù ‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà '+iso+(line?(' ‚Ä¢ ‡πÑ‡∏•‡∏ô‡πå '+line):'')+'</div>';
      if(box.innerHTML.trim() !== newHtml.trim()){
          box.innerHTML = newHtml; 
      }
      return; 
    }
    // Summaries
    let sumTimes=0, sumPieces=0;
    rows.forEach(r=>{
      sumTimes += numberOrZero( normalizeField(r, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','times','count','Times']) );
      sumPieces += numberOrZero( normalizeField(r, ['‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','pieces','qty','Quantity']) );
    });
    
    // *** Generate new HTML and perform State Check ***
    let html = '';
    html += '<div class="inline" style="justify-content:space-between;gap:8px;margin-bottom:8px">';
    html +=   '<div class="status">‡∏û‡∏ö '+rows.length+' ‡πÅ‡∏ñ‡∏ß'+(line?(' ‚Ä¢ ‡πÑ‡∏•‡∏ô‡πå: <strong>'+line+'</strong>'):'')+' ‚Ä¢ ‡∏£‡∏ß‡∏°‡∏Ñ‡∏£‡∏±‡πâ‡∏á: <strong>'+sumTimes+'</strong> ‚Ä¢ ‡∏£‡∏ß‡∏°‡∏ä‡∏¥‡πâ‡∏ô: <strong>'+sumPieces+'</strong></div>';
    html +=   '<button class="btn gray" onclick="mirrorFromUpload()">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>';
    html += '</div>';
    // Table preview (first 150 rows)
    const show = rows.slice(0,150);
    const keys = new Set();
    show.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
    const cols = Array.from(keys);
    html += '<div style="max-height:360px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px">';
    html += '<table><thead><tr>';
    cols.forEach(c=>{ html += '<th>'+c+'</th>'; });
    html += '</tr></thead><tbody>';
    show.forEach((r)=>{
      html += '<tr>';
      cols.forEach(c=>{ html += '<td>'+ (r[c]!==undefined? String(r[c]) : '') +'</td>'; });
      html += '</tr>';
    });
    html += '</tbody></table></div>';
    
    // Check if new HTML content is different before updating the DOM
    if(box.innerHTML.trim() !== html.trim()){
      box.innerHTML = html;
    }
  }

  // ===== Google Sheet Export (Apps Script) ‚Äî merged (Form POST) =====
  const GSCRIPT_URL = "https://script.google.com/macros/s/AKfycbyO6AHvZ1Z_hqOTq4MJAnZKKrqKizJBxIkk4hftya0yDUJncy9LiRwPdwxUoJ2OhW2u9w/exec";

function getFilteredRowsOnUpload(){
  const rows = Array.isArray(uploadRows) ? uploadRows : [];
  const wantDate = document.getElementById('upDateFilter') ? document.getElementById('upDateFilter').value : '';
  const wantLine = document.getElementById('upLineFilter') ? document.getElementById('upLineFilter').value : '';

  const hasDateCol = rows.some(r => r.hasOwnProperty('_d') || r.hasOwnProperty('date') || r.hasOwnProperty('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || r.hasOwnProperty('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ'));
  const hasLineCol = rows.some(r => r.hasOwnProperty('line') || r.hasOwnProperty('‡πÑ‡∏•‡∏ô‡πå') || r.hasOwnProperty('‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï') || r.hasOwnProperty('productionLine') || r.hasOwnProperty('prodLine'));

  if(!hasDateCol && !hasLineCol){
    return rows;
  }
  return rows.filter(r => {
    let ok = true;
    if(hasDateCol){
      const rv = r._d ?? r.date ?? r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà'] ?? r['‡∏ß‡∏±‡∏ô‡∏ó‡∏µ'] ?? '';
      ok = ok && (!wantDate || String(rv).startsWith(String(wantDate)));
    }
    if(hasLineCol){
      const lv = r.line ?? r['‡πÑ‡∏•‡∏ô‡πå'] ?? r['‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï'] ?? r.productionLine ?? r.prodLine ?? '';
      ok = ok && (!wantLine || String(lv).trim() === String(wantLine).trim());
    }
    return ok;
  });
}

function genSheetName(dateISO, line){
    const d = dateISO || (new Date()).toISOString().slice(0,10);
    const ln = (line||'').trim();
    return ln ? `Prod_${d}_Line${ln}` : `Prod_${d}_All`;
  }

  function localISOInTZ(tz){
    try{
      const dt = new Date();
      const p = new Intl.DateTimeFormat('en-GB', {
        timeZone: tz || 'Asia/Bangkok',
        year:'numeric', month:'2-digit', day:'2-digit',
        hour:'2-digit', minute:'2-digit', second:'2-digit', hour12:false
      }).formatToParts(dt).reduce((a,x)=>{a[x.type]=x.value; return a;},{});
      const off = '+07:00';
      return `${p.year}-${p.month}-${p.day}T${p.hour}:${p.minute}:${p.second}${off}`;
    }catch(e){
      return new Date().toISOString().replace('Z','+07:00');
    }
  }

  function filtersReady(){
    const d = document.getElementById('upDateFilter') && document.getElementById('upDateFilter').value;
    const l = document.getElementById('upLineFilter') && document.getElementById('upLineFilter').value;
    return !!(d && l);
  }

  function ensureGsHistory(){
    let wrap = document.getElementById('gsHistory');
    if(!wrap){
      const status = document.getElementById('gsStatus');
      wrap = document.createElement('div');
      wrap.id = 'gsHistory';
      wrap.style.marginTop = '8px';
      wrap.innerHTML = '<div style="font-size:12px;color:#64748b;">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div><ul id="gsHistoryList" style="margin:6px 0 0 0;padding-left:18px;font-size:13px;"></ul>';
      if(status && status.parentElement){ status.parentElement.appendChild(wrap); } else { document.body.appendChild(wrap); }
    }
    if(!document.getElementById('gsHistoryList')){
      const ul=document.createElement('ul'); ul.id='gsHistoryList'; wrap.appendChild(ul);
    }
    return document.getElementById('gsHistoryList');
  }

  function postSaveCleanup(sheetName, rowCount){
    try{
      const up = document.getElementById('upFile'); if(up){ up.value=''; }
      if(Array.isArray(uploadRows)) uploadRows.length = 0;
      if(Array.isArray(uploadHeaders)) uploadHeaders.length = 0;
      const lf = document.getElementById('upLineFilter'); if(lf){ lf.selectedIndex = 0; lf.dispatchEvent(new Event('change')); }
      const st = document.getElementById('gsStatus'); if(st){ st.textContent = '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‚Üí '+sheetName+' ('+rowCount+' ‡πÅ‡∏ñ‡∏ß)'; st.className='status ok'; }
      const ul = ensureGsHistory(); const li = document.createElement('li'); const now = new Date().toLocaleString('th-TH',{hour12:false}); li.textContent = sheetName + ' ‚Ä¢ ' + now; ul.insertBefore(li, ul.firstChild);
    }catch(e){}
  }

  function parseSheetDateFromName(name){
    const m = String(name).match(/(\d{4}-\d{2}-\d{2})/);
    if(m) return m[1];
    const wantDate = document.getElementById('upDateFilter') ? document.getElementById('upDateFilter').value : '';
    if(wantDate){
      const parts = wantDate.split('/'); // mm/dd/yyyy
      if(parts.length===3){ return `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}`; }
    }
    const d = new Date(); const y=d.getFullYear(); const m2=String(d.getMonth()+1).padStart(2,'0'); const da=String(d.getDate()).padStart(2,'0'); return `${y}-${m2}-${da}`;
  }

  function updateSaveBtn(){
    const btn = document.getElementById('btnSaveGS') || document.querySelector('button[onclick="saveToGoogleSheet()"]');
    const ready = filtersReady();
    if(btn){ btn.disabled = !ready; }
    const status = document.getElementById('gsStatus');
    if(status && Array.isArray(uploadRows)){
      status.textContent = uploadRows.length ? (ready ? '' : '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å') : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå';
    }
  }

  function saveToGoogleSheet(){
    const status = document.getElementById('gsStatus');
    if(!Array.isArray(uploadRows) || uploadRows.length===0){
      if(status){ status.textContent='‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô'; status.className='status warn'; }
      alert('‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    if(!filtersReady()){
      if(status){ status.textContent='‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï'; status.className='status warn'; }
      alert('‡πÇ‡∏õ‡∏£‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏•‡∏∞ ‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï');
      return;
    }
    if(status){ status.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...'; status.className='status'; }

    const wantDate = document.getElementById('upDateFilter') ? document.getElementById('upDateFilter').value : '';
    const wantLine = document.getElementById('upLineFilter') ? document.getElementById('upLineFilter').value : '';
    let rows = getFilteredRowsOnUpload();
    const hasDateCol = Array.isArray(uploadRows) && uploadRows.some(r => r.hasOwnProperty('_d') || r.hasOwnProperty('date') || r.hasOwnProperty('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà') || r.hasOwnProperty('‡∏ß‡∏±‡∏ô‡∏ó‡∏µ'));
    const hasLineCol = Array.isArray(uploadRows) && uploadRows.some(r => r.hasOwnProperty('line') || r.hasOwnProperty('‡πÑ‡∏•‡∏ô‡πå') || r.hasOwnProperty('‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï') || r.hasOwnProperty('productionLine') || r.hasOwnProperty('prodLine'));
    if(rows.length===0){
      if(!hasDateCol || !hasLineCol){ rows = Array.isArray(uploadRows) ? uploadRows : []; }
      if(rows.length===0){
        if(status){ status.textContent='‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å'; status.className='status warn'; }
        alert('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏≤‡∏°‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
        return;
      }
    }

    const keys = new Set(); rows.forEach(r=>Object.keys(r).forEach(k=>keys.add(k)));
    const columns = Array.from(keys);
    const haveLineCol = columns.some(c => String(c).toLowerCase()==='line' || c==='‡πÑ‡∏•‡∏ô‡πå' || c==='‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï' || c==='productionLine' || c==='prodLine');
    const haveDateCol = columns.includes('_d');
    if(!haveLineCol) columns.push('line');
    if(!haveDateCol) columns.push('_d');

    const nowISO = localISOInTZ('Asia/Bangkok');
    const rawName = genSheetName(wantDate, wantLine);
    const sheetName = rawName.replace(/[\/:*?\[\]]/g,'-');
    const sheetDate = parseSheetDateFromName(sheetName);

    const rowsOut = rows.map(r=>{
      const o = {};
      columns.forEach(c=>{
        if(c==='line' && !haveLineCol) o[c] = wantLine;
        else if(c==='_d') o[c] = sheetDate; // force G date to sheet date
        else if(c==='_d' && !haveDateCol) o[c] = sheetDate;
        else o[c] = (r[c]!==undefined ? r[c] : '');
      });
      o['_savedAt'] = nowISO;
      return o;
    });

    const payload = {
      sheetName,
      columns: [...columns, '_savedAt'],
      rows: rowsOut,
      meta: { filterDate: wantDate, filterLine: wantLine, source: 'PDF Tool v5.30-merged', rowCount: rowsOut.length }
    };

    try{
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = GSCRIPT_URL;
      form.target = 'gs_iframe';
      const input = document.createElement('input');
      input.type='hidden'; input.name='payload'; input.value=JSON.stringify(payload);
      form.appendChild(input);
      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>{ try{ document.body.removeChild(form); }catch(e){} }, 1000);
      if(status){ status.textContent='‡∏™‡πà‡∏á‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢  (‡πÅ‡∏ó‡πá‡∏ö: '+sheetName+')'; status.className='status ok'; }
      postSaveCleanup(sheetName, rowsOut.length);
      alert('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏•‡πâ‡∏ß (‡πÅ‡∏ó‡πá‡∏ö: '+sheetName+')');
    }catch(err){
      if(status){ status.textContent='‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: '+(err && err.message? err.message: err); status.className='status bad'; }
      alert('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: '+(err && err.message? err.message: err));
    }
  }

  // ===== Read back rows from Google Sheet (for Extra Filters) =====
  // Requires Apps Script to support GET with CORS: ?action=fetch&sheetName=... -> JSON
  async function fetchSheetRowsByName(sheetName){
    const url = `${GSCRIPT_URL}?action=fetch&sheetName=${encodeURIComponent(sheetName)}&header=0`;
    try{
      const res = await fetch(url, { method:'GET' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json(); // expected: { rows: [...], range: 'A1:Z', headers: [...] }
    }catch(err){
      console.warn('fetchSheetRowsByName failed', err);
      return { rows: [], headers: [] };
    }
  }

function renderExtraRows(rows){
  const host = document.getElementById('extraFetch');
  if(!host) return;
  const out = [];

  // *** 1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà ***
  const oldWrap = document.getElementById('extraTableWrap');
  if(oldWrap){
      _extraTableScrollTop = oldWrap.scrollTop;
      _extraTableScrollLeft = oldWrap.scrollLeft;
  }
  
  out.push('<div style="font-size:12px;color:#64748b;margin-bottom:6px;"></div>');

  // ‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå
  let maxCols = 0;
  (rows||[]).forEach(r => { if(Array.isArray(r)) maxCols = Math.max(maxCols, r.length); });
  maxCols = maxCols;

  function colLetter(i){
    let s=''; i = i|0;
    while(true){ s = String.fromCharCode(65 + (i % 26)) + s; if(i < 26) break; i = Math.floor(i/26) - 1; }
    return s;
  }
  const headerNames = ['Cut-file','Materials','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)'];

  out.push(`<div id="extraViewToggle" style="font-size:12px;color:#64748b;display:flex;gap:8px;align-items:center;margin:6px 0;">
              <span>‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á:</span>
              <button type="button" id="btnFit" style="border:1px solid #cbd5e1;border-radius:6px;padding:2px 6px;cursor:pointer;background:#f8fafc">‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á</button>
              <button type="button" id="btnScroll" style="border:1px solid #cbd5e1;border-radius:6px;padding:2px 6px;cursor:pointer;background:#fff">‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô</button>
            </div>
            <div id="extraTableWrap" style="overflow:auto; max-height:850px; max-width:100%; overflow-x:auto; width:100%; min-width:100%; overflow-x:auto">`);
  
  out.push('<div class="status-filter-bar" id="statusFilterBar">'
    + '<span style="opacity:.7;font-size:12px">‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞:</span>'
    + '<button type="button" class="status-chip active" data-status-filter="‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>'
    + '<button type="button" class="status-chip" data-status-filter="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô">‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</button>'
    + '<button type="button" class="status-chip" data-status-filter="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</button>'
    + '<button type="button" class="status-chip" data-status-filter="‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤">‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</button>'
    + '</div>');
out.push('<div id="quickSaveBar" style="margin:6px 0 8px 0;display:flex;gap:8px;align-items:center">'
 + '<button id="saveAllStatusBtn" style="padding:6px 10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô (<span id="saveAllCount">0</span>)</button>' + '<button id="saveAllEveryRowBtn" style="padding:6px 10px;border:1px solid #e2e8f0;border-radius:8px;background:#fff;cursor:pointer">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ</button>'
 + '<span id="saveAllHint" style="font-size:12px;color:#64748b">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</span>'
+ '</div>');
// VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô font-size:12px ‡πÄ‡∏õ‡πá‡∏ô font-size:16px VVVV
out.push('<table id="extraTable" style="border-collapse:separate;border-spacing:0;font-size:16px;min-width:100%; width:max-content;table-layout:auto;">');
  out.push('<thead><tr>');

  for(let i=0;i<maxCols;i++){
    const label = headerNames[i] || colLetter(i);
    const align = (i >= 2) ? 'center' : 'left';
    // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding:12px 16px ‡πÄ‡∏õ‡πá‡∏ô padding:14px 16px VVVV
    out.push('<th style="text-align:'+align+';border-bottom:1px solid #e2e8f0;padding:14px 16px;white-space:nowrap">'+label+'</th>');
  }
  // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding:12px 16px ‡πÄ‡∏õ‡πá‡∏ô padding:14px 16px VVVV
  out.push('<th style="text-align:left;border-bottom:1px solid #e2e8f0;padding:14px 16px;white-space:nowrap">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>');
  out.push('</tr></thead><tbody>');

  (rows||[]).forEach((r,rowIndex) => {
    out.push('<tr>');
    for(let i=0;i<maxCols;i++){
      const val = (r && r[i] != null) ? r[i] : '';
      const align = (i >= 2) ? 'center' : 'left';
      
      if(i===0){
        out.push(
          // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding:12px 16px ‡πÄ‡∏õ‡πá‡∏ô padding:14px 16px VVVV
          '<td style="text-align:'+align+';border-bottom:1px dashed #e5e7eb;padding:14px 16px;white-space:nowrap;vertical-align:middle">'
          + '<span class="cf-link" title="‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡πÑ‡∏õ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤" data-cutfile="'+String(val).replace(/"/g,'&quot;')+'">'+ String(val) +'</span>'
          + '</td>'
        );
      }else{
        // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding:12px 16px ‡πÄ‡∏õ‡πá‡∏ô padding:14px 16px VVVV
        out.push('<td style="text-align:'+align+';border-bottom:1px dashed #e5e7eb;padding:14px 16px;white-space:nowrap;vertical-align:middle">'+ String(val) +'</td>');
      }

    }

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á cell ‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÄ‡∏î‡∏µ‡∏¢‡∏ß (flex) ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡∏≠‡πà‡∏≤‡∏ô‡∏à‡∏≤‡∏Å localStorage
    const rowKey = (r && r.length) ? [r[0],r[1],r[2],r[3]].join('|') : ('row_'+rowIndex);
    const data = {status:'',note:'',ts:''}; // localStorage disabled; rely on Google Sheet

    const selectHtml =
      // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding/height ‡∏Ç‡∏≠‡∏á select VVVV
      '<select data-role="status" data-key="'+rowKey+'" style="border:1px solid #cbd5e1;border-radius:6px;padding:8px 12px;margin-right:6px;height:40px;">'
      + '<option value="">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</option>'
      + '<option value="‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô"'+(data.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'?' selected':'')+'>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</option>'
      + '<option value="‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥"'+(data.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥'?' selected':'')+'>‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥</option>'
      + '<option value="‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤"'+(data.status==='‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'?' selected':'')+'>‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤</option>'
      + '</select>';

    const inputHtml =
      '<input data-role="note" data-key="'+rowKey+'" type="text" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏õ‡∏±‡∏ç‡∏´‡∏≤"'
      + ' value="'+(data.note||'').replace(/"/g,'&quot;')+'"'
      // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding/height ‡∏Ç‡∏≠‡∏á input VVVV
      + ' style="width:420px;max-width:60vw;border:1px solid #cbd5e1;border-radius:6px;padding:12px 16px;height:40px;">';

    const tsText = data.ts ? new Date(data.ts).toLocaleString() : '';
    // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô font-size ‡∏Ç‡∏≠‡∏á small VVVV
    const tsHtml = '<small data-role="ts" data-key="'+rowKey+'" style="margin-left:8px;color:#64748b;white-space:nowrap;font-size:13px;">'+(tsText?('‡πÄ‡∏ß‡∏•‡∏≤: '+tsText):'')+'</small>';

    // VVVV ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô padding ‡∏Ç‡∏≠‡∏á td ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô VVVV
    out.push('<td style="border-bottom:1px dashed #e5e7eb;padding:8px 12px;white-space:nowrap;vertical-align:middle">'
             + '<span style="display:inline-flex;align-items:center;gap:6px;">'
             + selectHtml + inputHtml + tsHtml
             + '</span>'
             + '</td>');
    out.push('</tr>');
  });

  out.push('</tbody></table></div>');
  host.innerHTML = out.join('');
  
  // *** 2. ‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà ***
  const newWrap = document.getElementById('extraTableWrap');
  if(newWrap){
    // ‡πÉ‡∏ä‡πâ setTimeout ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏ß‡πà‡∏≤ DOM ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡∏Å‡πà‡∏≠‡∏ô
    setTimeout(()=>{
      newWrap.scrollTop = _extraTableScrollTop;
      newWrap.scrollLeft = _extraTableScrollLeft;
    }, 0);
  }

  // Attach Cut-file click -> fill search & trigger new round
  (function attachCutfileHandler(){
    const tbl = document.getElementById('extraTable');
    if(!tbl) return;
    tbl.addEventListener('click', function(ev){
      const el = ev.target.closest('[data-cutfile]');
      if(!el) return;
      const v = String(el.getAttribute('data-cutfile') || '').trim();
      if(!v) return;
      try{ if(typeof showPage==='function') showPage('main'); }catch(e){}
      const search = document.getElementById('search');
      if(search){
        search.value = v;
        try{ if(typeof onSearchInput==='function') onSearchInput(); }catch(e){}
        try{ if(typeof onSearchDone==='function') onSearchDone(); }catch(e){}
        search.blur();
      }
    });
  })();
  // ---- status row coloring + filters ----
  (function initStatusRowColoringAndFilters(){
    const tbl = document.getElementById('extraTable');
    function applyRowClass(tr, status){
      tr.dataset.status = status || '';
      tr.classList.remove('row-status-done','row-status-blocked','row-status-progress');
      if(status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') tr.classList.add('row-status-done');
      else if(status==='‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤') tr.classList.add('row-status-blocked');
      else if(status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥') tr.classList.add('row-status-progress');
    }
    function applyFilter(){
      const bar = document.getElementById('statusFilterBar');
      const activeBtn = bar ? bar.querySelector('.status-chip.active') : null;
      const f = activeBtn ? activeBtn.getAttribute('data-status-filter') : '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î';
      if(!tbl) return;
      Array.from(tbl.querySelectorAll('tbody tr')).forEach(tr=>{
        // derive status from select in the row
        const sel = tr.querySelector('select[data-role="status"]');
        const st = sel ? sel.value : '';
        applyRowClass(tr, st);
        tr.style.display = (f==='‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î' || st===f) ? '' : 'none';
      });
    }
    if(tbl){
      tbl.addEventListener('change', function(ev){
        const t = ev.target;
        if(t && t.matches('select[data-role="status"]')){
          const tr = t.closest('tr');
          if(tr) applyRowClass(tr, t.value);
          applyFilter();
        }
      });
    }
    const bar = document.getElementById('statusFilterBar');
    if(bar){
      bar.addEventListener('click', function(ev){
        const btn = ev.target.closest('[data-status-filter]');
        if(!btn) return;
        bar.querySelectorAll('.status-chip').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        applyFilter();
      });
    }
    // initial apply after render
    applyFilter();
  })();

  // Build sticky header that syncs with horizontal scroll
  (function makeStickyHeader(){
    const wrap = document.getElementById('extraTableWrap');
    const tbl = document.getElementById('extraTable');
    if(!wrap || !tbl || !tbl.tHead) return;
    // Remove old
    const old = document.getElementById('extraStickyHdr');
    if(old) old.remove();

    const sticky = document.createElement('div');
    sticky.id = 'extraStickyHdr';
    sticky.style.position = 'sticky';
    sticky.style.top = '0';
    sticky.style.zIndex = '15';
    sticky.style.background = '#fff';
    sticky.style.borderBottom = '1px solid #e2e8f0';
    sticky.style.overflow = 'hidden';

    // Clone header into its own table for perfect stickiness
    const hdrTable = document.createElement('table');
    hdrTable.style.borderCollapse = 'separate';
    hdrTable.style.borderSpacing = '0';
    hdrTable.style.tableLayout = 'fixed';
    hdrTable.style.width = tbl.scrollWidth + 'px';
    const theadClone = tbl.tHead.cloneNode(true);
    hdrTable.appendChild(theadClone);
    sticky.appendChild(hdrTable);
    // Hide the original header to avoid double headers
    tbl.tHead.style.visibility = 'hidden';
    tbl.tHead.style.pointerEvents = 'none';
    tbl.tHead.style.height = '0px';

    // Compute widths
    const ths = Array.from(tbl.tHead.querySelectorAll('th'));
    const cloneThs = Array.from(theadClone.querySelectorAll('th'));
    ths.forEach((th,i)=>{
      const w = th.getBoundingClientRect().width;
      if(cloneThs[i]) cloneThs[i].style.width = Math.ceil(w) + 'px';
    });

    // Insert as first child of wrap
    wrap.insertBefore(sticky, wrap.firstChild);

    // Sync horizontal scroll
    wrap.addEventListener('scroll', ()=>{
      sticky.scrollLeft = wrap.scrollLeft;
    });

    // Recalc on resize
    window.addEventListener('resize', ()=>{
      hdrTable.style.width = tbl.scrollWidth + 'px';
      const ths = Array.from(tbl.tHead.querySelectorAll('th'));
      const cloneThs = Array.from(theadClone.querySelectorAll('th'));
      ths.forEach((th,i)=>{
        const w = th.getBoundingClientRect().width;
        if(cloneThs[i]) cloneThs[i].style.width = Math.ceil(w) + 'px';
      });
    });
  })();

  // Toggle view
  (function(){
    const wrap = document.getElementById('extraTableWrap');
    const tbl = document.getElementById('extraTable');
    if(!wrap || !tbl) return;
    const btnFit = document.getElementById('btnFit');
    const btnScroll = document.getElementById('btnScroll');
    function apply(mode){
      if(mode==='fit'){ wrap.style.overflowX='hidden'; tbl.style.tableLayout='auto'; }
      else { wrap.style.overflowX='auto'; tbl.style.tableLayout='fixed'; }
    }
    if(btnFit) btnFit.onclick = ()=>apply('fit');
    if(btnScroll) btnScroll.onclick = ()=>apply('scroll');
  })();

  // ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå + ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
  (function(){
    const tbl = document.getElementById('extraTable');
    if(!tbl) return;

    function nowISO(){ return localISOInTZ('Asia/Bangkok'); }
    function updateTsLabel(key, ts){
      const el = tbl.querySelector('small[data-role="ts"][data-key="'+key+'"]');
      if(el){ el.textContent = ts ? ('‡πÄ‡∏ß‡∏•‡∏≤: '+ new Date(ts).toLocaleString()) : ''; }
    }
    function requireNoteIfIssue(key){
      const input = tbl.querySelector('input[data-role="note"][data-key="'+key+'"]');
      if(!input) return true;
      const ok = input.value.trim().length > 0;
      input.style.borderColor = ok ? '#cbd5e1' : '#ef4444';
      if(!ok){ input.focus(); }
      return ok;
    }

    // change events
    tbl.addEventListener('change', function(ev){
      const t = ev.target;
      if(!t.dataset || !t.dataset.key) return;
      const key = t.dataset.key;
      const saved = (window.localStorage.getItem('extraCommentsV3')||'{}');
      let mem = {}; try{ mem = JSON.parse(saved); }catch(e){ mem = {}; }
      mem[key] = mem[key] || {status:'',note:'',ts:''};

      if(t.dataset.role === 'status'){
        mem[key].status = t.value;
        if(t.value === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'){
          mem[key].ts = nowISO();
          updateTsLabel(key, mem[key].ts);
        }else if(t.value === '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'){
          mem[key].ts = nowISO();
          updateTsLabel(key, mem[key].ts);
          requireNoteIfIssue(key);
        }
      }else if(t.dataset.role === 'note'){
        mem[key].note = t.value;
      }
      });

    // input events (note)
    tbl.addEventListener('input', function(ev){
      const t = ev.target;
      if(!t.dataset || t.dataset.role !== 'note') return;
      const key = t.dataset.key;
      const saved = (window.localStorage.getItem('extraCommentsV3')||'{}');
      let mem = {}; try{ mem = JSON.parse(saved); }catch(e){ mem = {}; }
      mem[key] = mem[key] || {status:'',note:'',ts:''};
      mem[key].note = t.value;
      if(mem[key].status === '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'){
        const ok = t.value.trim().length > 0;
        t.style.borderColor = ok ? '#cbd5e1' : '#ef4444';
      }
      });

    // export button
    const wrap = document.getElementById('extraTableWrap');
    if(wrap && !document.getElementById('btnExportComments')){
      const btn = document.createElement('button');
      btn.id = 'btnExportComments';
      btn.textContent = '‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≠‡∏°‡πÄ‡∏°‡∏ô‡∏ï‡πå (CSV)';
      btn.style = 'margin-top:8px;border:1px solid #cbd5e1;border-radius:6px;padding:6px 10px;background:#fff;cursor:pointer';
      btn.onclick = function(){
        let mem = {}; // localStorage disabled; use DOM values
        const rows = [];
        const trNodes = tbl.querySelectorAll('tbody tr');
        trNodes.forEach(tr => {
          const tds = tr.querySelectorAll('td');
          if(tds.length < (maxCols+1)) return;
          const cutfile = tds[0].innerText.trim();
          const materials = tds[1].innerText.trim();
          const times = tds[2].innerText.trim();
          const qty = tds[3].innerText.trim();
          const key = [cutfile,materials,times,qty].join('|');
          const d = mem[key] || {status:'',note:'',ts:''};
          rows.push([cutfile,materials,times,qty,d.status,d.note,d.ts]);
        });
        const header = ['Cut-file','Materials','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á','‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô)','‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞','‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏','‡πÄ‡∏ß‡∏•‡∏≤'];
        let csv = header.join(',') + '\n';
        rows.forEach(r => { csv += r.map(x => '"' + String(x).replace(/"/g,'""') + '"').join(',') + '\n'; });
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'comments.csv'; a.click();
        URL.revokeObjectURL(url);
      };
      wrap.appendChild(btn);
    }
  })();
}
async function refreshExtraFromSheet(){
    const d = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter') || null;
    const l = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter') || null;
    const dateVal = d && d.value ? d.value : '';
    const lineVal = l && l.value ? l.value : '';
    
    // ** ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å Scroll Position ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥‡∏Å‡∏≤‡∏£ Fetch **
    const wrap = document.getElementById('extraTableWrap');
    if(wrap){
        _extraTableScrollTop = wrap.scrollTop;
        _extraTableScrollLeft = wrap.scrollLeft;
    }

    if(!(dateVal && lineVal && lineVal !== '')){
      const host = document.getElementById('extraFetch');
      // *** ‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: Silent Reset ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ExtraFetch ***
      const newHtml = '<div style="color:#94a3b8;font-size:13px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</div>';
      if(host && host.innerHTML.trim() !== newHtml.trim()){
        host.innerHTML = newHtml;
      }
      return;
    }
    // Build tab name exactly like we save
    const parts = dateVal.includes('/') ? dateVal.split('/') : [dateVal.split('-')[1], dateVal.split('-')[2], dateVal.split('-')[0]]; // mm/dd/yyyy or yyyy-mm-dd
    const dISO = parts.length===3 ? `${parts[2]}-${parts[0].padStart(2,'0')}-${parts[1].padStart(2,'0')}` : dateVal;
    const rawName = genSheetName(dISO, lineVal);
    const sheetName = rawName.replace(/[\\/:*?\\[\\]]/g,'-');
    
    const resp = await fetchSheetRowsByName(sheetName);
    
    // ** ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: renderExtraRows() ‡∏à‡∏∞‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏Å‡∏π‡πâ‡∏Ñ‡∏∑‡∏ô Scroll Position ‡πÄ‡∏≠‡∏á **
    renderExtraRows(resp.rows || []);
    
    try{ await hydrateStatusFromGS(sheetName, 4); }catch(e){ console.warn(e); }

    await hydrateStatusFromGS(sheetName, 4);
    await showPrefScopeBadge(sheetName);
    loadStatusFilterPrefAndApply(sheetName);
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    try{
      const d=document.getElementById('upDateFilter');
      const l=document.getElementById('upLineFilter');
      if(d) d.addEventListener('change', updateSaveBtn);
      if(l) l.addEventListener('change', updateSaveBtn);
      updateSaveBtn();
    }catch(e){}
    // --- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á ---
    const iCM = document.getElementById('cutMachineNo');
    const savedMachine = localStorage.getItem('LS_CUTMACHINE'); // ‡∏î‡∏∂‡∏á‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
    if (iCM && savedMachine) {
        iCM.value = savedMachine; // ‡∏ô‡∏≥‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏à‡∏≠‡πÑ‡∏õ‡πÉ‡∏™‡πà‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    }
    // ------------------------------------------

    hookCutMachineCache(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á (‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÅ‡∏•‡πâ‡∏ß)
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≠‡∏¢‡πÄ‡∏ù‡πâ‡∏≤‡∏î‡∏π ‡∏ñ‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
  function hookCutMachineCache(){
      const iCM = document.getElementById('cutMachineNo');
      if(!iCM) return;
      
      const saveAction = () => {
          const val = (iCM.value || '').trim();
          localStorage.setItem('LS_CUTMACHINE', val); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á
      };

      // ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏ó‡∏∏‡∏Å‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏°: ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏Ñ‡πà‡∏≤, ‡∏û‡∏¥‡∏°‡∏û‡πå, ‡∏ß‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
      ['change','blur','keyup','paste'].forEach(ev => iCM.addEventListener(ev, saveAction));
  }
    // ... ‡πÇ‡∏Ñ‡πâ‡∏î‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏î‡∏¥‡∏° ...
  });

// === STRICT INPUT FILTER FOR SEARCH FIELD (A-Z / 0-9 / # ONLY) ===
function normalizeSearchInput(el){
  if(!el) return;
  let v = el.value || '';
  v = v.toUpperCase();
  v = v.replace(/[^A-Z0-9#-]/g, '');
  if(el.value !== v){
    el.value = v;
  }
}

document.addEventListener('DOMContentLoaded', function(){
  const s = document.getElementById('search');
  if(!s) return;

  // typing / scanner
  s.addEventListener('input', function(){
    normalizeSearchInput(s);
  });

  // paste protection
  s.addEventListener('paste', function(e){
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text') || '';
    s.value = text;
    normalizeSearchInput(s);
  });
});


// === SEARCH STATUS COLOR LOGIC ===
function applySearchStatus(el, hadForbidden){
  el.classList.remove('valid','invalid');
  if(el.value.length === 0){
    return;
  }
  if(hadForbidden){
    el.classList.add('invalid');
  }else{
    el.classList.add('valid');
  }
}

// Override normalizeSearchInput to track forbidden chars
function normalizeSearchInput(el){
  if(!el) return;
  const raw = el.value || '';
  const upper = raw.toUpperCase();
  const cleaned = upper.replace(/[^A-Z0-9#-]/g, '');
  const hadForbidden = (upper !== cleaned);

  el.value = cleaned;
  applySearchStatus(el, hadForbidden);
}

document.addEventListener('DOMContentLoaded', function(){
  const s = document.getElementById('search');
  if(!s) return;

  s.addEventListener('input', function(){
    normalizeSearchInput(s);
  });

  s.addEventListener('paste', function(e){
    e.preventDefault();
    const text = (e.clipboardData || window.clipboardData).getData('text') || '';
    s.value = text;
    normalizeSearchInput(s);
  });
});


// === FORCE EXACT MATCH BEFORE SHOWING PREVIEW BUTTON ===
function enforceExactMatchButtons(){
  const searchEl = document.getElementById('search');
  if(!searchEl) return;
  const search = (searchEl.value || '').trim().toUpperCase();

  document.querySelectorAll('[data-open]').forEach(btn => {
    const file = btn.getAttribute('data-open') || '';
    const cleanFile = file.replace(/\.(pdf|tif|tiff)$/i,'').toUpperCase();
    if(search && search === cleanFile){
      btn.style.display = '';
    }else{
      btn.style.display = 'none';
    }
  });
}

// Hook into existing renderList safely
(function(){
  const _renderList = window.renderList;
  window.renderList = function(){
    _renderList.apply(this, arguments);
    enforceExactMatchButtons();
  };
})();


/* === AUTO-FOCUS / AUTO-FLOW (Operator Mode) === */
document.addEventListener('DOMContentLoaded', () => {
  // 1) Focus Roll (qr21) immediately
  const roll = document.getElementById('qr21');
  const rf   = document.getElementById('qr24');

  if (roll) {
    setTimeout(() => roll.focus(), 300);
  }

  // 2) When Roll complete (21 chars) -> jump to RF
  if (roll && rf) {
    roll.addEventListener('input', () => {
      if (roll.value.trim().length === 21) {
        rf.focus();
      }
    });

    // 3) When RF complete (24 chars) -> auto process and return to Roll
    rf.addEventListener('input', () => {
      if (rf.value.trim().length === 24) {
        // small delay to let auto-build finish
        setTimeout(() => {
          roll.focus();
        }, 300);
      }
    });
  }
});
/* === END AUTO-FOCUS / AUTO-FLOW === */

</script>

<style>
  #upTable th, #upTable td {
    font-size: 16px; /* Adjust font size as needed */
  }

/* === AUTO-HIDE COLOR FIELDS (UX for operators) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏µ‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏µ Roll ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà logic ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.hide-color-field{display:none !important;}


/* === AUTO-HIDE LIST MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#vAll, #vOne, #vHide {
  display: none !important;
}


/* === HIDE CUT MACHINE FIELD (Operator UX) === */
.hide-cut-machine { display:none !important; }

/* icon button */
.cm-icon-btn{
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.cm-icon-btn:hover{ background:#f1f5f9; }


/* === HIDE CREATE / UPDATE QR BUTTON (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö autoBuild ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.btn-make-qr,
button[onclick*="makeQR"]{
  display:none !important;
}


/* === HIDE STATUS FILTER BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ / ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
#statusFilterBar {
  display: none !important;
}


/* === HIDE VIEW MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
#extraViewToggle {
  display: none !important;
}


/* === HIDE SAVE STATUS BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
#quickSaveBar,
#saveAllStatusBtn,
#saveAllEveryRowBtn {
  display: none !important;
}


/* === HIDE LIBRARY STATUS TEXT (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: QR Maker ‚úÖ ¬∑ PDF.js ‚ùå */
#libStatus {
  display: none !important;
}

</style>

<style>
  #upTable th, #upTable td {
    font-size: 18px; /* Increased font size */
  }

/* === AUTO-HIDE COLOR FIELDS (UX for operators) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏µ‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏µ Roll ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà logic ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.hide-color-field{display:none !important;}


/* === AUTO-HIDE LIST MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#vAll, #vOne, #vHide {
  display: none !important;
}


/* === HIDE CUT MACHINE FIELD (Operator UX) === */
.hide-cut-machine { display:none !important; }

/* icon button */
.cm-icon-btn{
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.cm-icon-btn:hover{ background:#f1f5f9; }


/* === HIDE CREATE / UPDATE QR BUTTON (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö autoBuild ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.btn-make-qr,
button[onclick*="makeQR"]{
  display:none !important;
}


/* === HIDE STATUS FILTER BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ / ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
#statusFilterBar {
  display: none !important;
}


/* === HIDE VIEW MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
#extraViewToggle {
  display: none !important;
}


/* === HIDE SAVE STATUS BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
#quickSaveBar,
#saveAllStatusBtn,
#saveAllEveryRowBtn {
  display: none !important;
}


/* === HIDE LIBRARY STATUS TEXT (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: QR Maker ‚úÖ ¬∑ PDF.js ‚ùå */
#libStatus {
  display: none !important;
}

</style>

<style>
  #upTable th, #upTable td {
    font-size: 20px; /* Increased font size further */
  }

/* === AUTO-HIDE COLOR FIELDS (UX for operators) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏µ‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏µ Roll ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà logic ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.hide-color-field{display:none !important;}


/* === AUTO-HIDE LIST MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#vAll, #vOne, #vHide {
  display: none !important;
}


/* === HIDE CUT MACHINE FIELD (Operator UX) === */
.hide-cut-machine { display:none !important; }

/* icon button */
.cm-icon-btn{
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.cm-icon-btn:hover{ background:#f1f5f9; }


/* === HIDE CREATE / UPDATE QR BUTTON (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö autoBuild ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.btn-make-qr,
button[onclick*="makeQR"]{
  display:none !important;
}


/* === HIDE STATUS FILTER BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ / ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
#statusFilterBar {
  display: none !important;
}


/* === HIDE VIEW MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
#extraViewToggle {
  display: none !important;
}


/* === HIDE SAVE STATUS BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
#quickSaveBar,
#saveAllStatusBtn,
#saveAllEveryRowBtn {
  display: none !important;
}


/* === HIDE LIBRARY STATUS TEXT (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: QR Maker ‚úÖ ¬∑ PDF.js ‚ùå */
#libStatus {
  display: none !important;
}

</style>

<style>
/* === NEW WORKFLOW LAYOUT v1 === */
.main-workflow{
  display:grid;
  grid-template-columns: 3fr 2fr; /* 60% / 40% */
  gap:16px;
  align-items:start;
}
@media (max-width: 1100px){
  .main-workflow{ grid-template-columns: 1fr; }
}
.work-left .card{ margin-bottom:16px; }
.work-right{
  position:sticky;
  top:12px;
}
.qr-preview-big{
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:10px;
}
.qr-preview-big canvas{
  width:260px !important;
  height:260px !important;
}
.qr-status{
  width:100%;
  background:#f8fafc;
  border:1px solid #e5e7eb;
  border-radius:12px;
  padding:12px;
}

/* === AUTO-HIDE COLOR FIELDS (UX for operators) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏µ‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏µ Roll ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà logic ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.hide-color-field{display:none !important;}


/* === AUTO-HIDE LIST MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#vAll, #vOne, #vHide {
  display: none !important;
}


/* === HIDE CUT MACHINE FIELD (Operator UX) === */
.hide-cut-machine { display:none !important; }

/* icon button */
.cm-icon-btn{
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.cm-icon-btn:hover{ background:#f1f5f9; }


/* === HIDE CREATE / UPDATE QR BUTTON (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö autoBuild ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.btn-make-qr,
button[onclick*="makeQR"]{
  display:none !important;
}


/* === HIDE STATUS FILTER BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ / ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
#statusFilterBar {
  display: none !important;
}


/* === HIDE VIEW MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
#extraViewToggle {
  display: none !important;
}


/* === HIDE SAVE STATUS BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
#quickSaveBar,
#saveAllStatusBtn,
#saveAllEveryRowBtn {
  display: none !important;
}


/* === HIDE LIBRARY STATUS TEXT (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: QR Maker ‚úÖ ¬∑ PDF.js ‚ùå */
#libStatus {
  display: none !important;
}

</style>

<style>
/* === EXPAND PRODUCTION PLAN HEIGHT === */
.work-right{
  height: calc(100vh - 120px);
  display: flex;
  flex-direction: column;
}
.work-right .card{
  flex: 1;
  display: flex;
  flex-direction: column;
}
.work-right .card > .filters,
.work-right .card > #extraFilters,
.work-right .card > #extraFetch,
.work-right .card > #mirrorBox{
  flex: 1;
}
.work-right .card table{
  max-height: calc(100vh - 220px);
}
#extraTableWrap{
  max-height: calc(100vh - 260px);
  overflow-y: auto;
}

/* === AUTO-HIDE COLOR FIELDS (UX for operators) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏µ‡πÑ‡∏ü‡∏•‡πå / ‡∏™‡∏µ Roll ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• ‡πÅ‡∏ï‡πà logic ‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.hide-color-field{display:none !important;}


/* === AUTO-HIDE LIST MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°: ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ / ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• */
#vAll, #vOne, #vHide {
  display: none !important;
}


/* === HIDE CUT MACHINE FIELD (Operator UX) === */
.hide-cut-machine { display:none !important; }

/* icon button */
.cm-icon-btn{
  border:1px solid #cbd5e1;
  background:#fff;
  border-radius:999px;
  padding:6px 10px;
  cursor:pointer;
  font-size:14px;
}
.cm-icon-btn:hover{ background:#f1f5f9; }


/* === HIDE CREATE / UPDATE QR BUTTON (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° ‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö autoBuild ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô */
.btn-make-qr,
button[onclick*="makeQR"]{
  display:none !important;
}


/* === HIDE STATUS FILTER BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏Å‡∏£‡∏≠‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ / ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô / ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ / ‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ */
#statusFilterBar {
  display: none !important;
}


/* === HIDE VIEW MODE BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏°‡∏∏‡∏°‡∏°‡∏≠‡∏á ‡∏û‡∏≠‡∏î‡∏µ‡∏Å‡∏ß‡πâ‡∏≤‡∏á / ‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô */
#extraViewToggle {
  display: none !important;
}


/* === HIDE SAVE STATUS BUTTONS (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô / ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ */
#quickSaveBar,
#saveAllStatusBtn,
#saveAllEveryRowBtn {
  display: none !important;
}


/* === HIDE LIBRARY STATUS TEXT (Operator UX) === */
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°: QR Maker ‚úÖ ¬∑ PDF.js ‚ùå */
#libStatus {
  display: none !important;
}

</style>


<!-- === PATCH v29: Hide Delete Buttons (Operator Safety) === -->
<style>
/* ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏Å‡∏î‡∏û‡∏•‡∏≤‡∏î */
button.delete,
button.btn-delete,
button[data-action='delete'],
button[onclick*='delete'],
button[onclick*='remove'],
button[onclick*='clear']{
  display:none !important;
}
</style>
<!-- === END PATCH v29 === -->


<!-- === PATCH v30: Reduce Search Filename Input Width (<=30 chars UX) === -->
<style>
/* ‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏ä‡πà‡∏≠‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡πÑ‡∏°‡πà‡πÄ‡∏Å‡∏¥‡∏ô 30 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ */
#search,
.searchShort{
  max-width: 320px !important;   /* ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏•‡πá‡∏Å‡∏•‡∏á‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏¥‡∏° */
  width: 320px !important;
}

/* ‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡πÉ‡∏´‡πâ‡∏¢‡∏∑‡∏î‡∏´‡∏¢‡∏∏‡πà‡∏ô‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
@media (max-width: 980px){
  #search,
  .searchShort{
    max-width: 260px !important;
    width: 100% !important;
  }
}
</style>
<!-- === END PATCH v30 === -->

</head>
<body>
  <div class="wrap">
    <h1>‡∏£‡∏∞‡∏ö‡∏ö ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡∏î & ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå PDF QR & ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö </h1>
    <div id="libStatus" class="status">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÑ‡∏•‡∏ö‡∏£‡∏≤‡∏£‡∏µ‚Ä¶</div>

    <div class="tabs">
      <button id="tabMain" class="tab active" onclick="showPage('main')">üìÑ ‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
      <button id="tabUpload" class="tab" onclick="goUpload()">‚¨ÜÔ∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
      <span id="uplock" class="pill bad">‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà</span>
    </div>
    
    <div id="pageMain">
      <div class="main-workflow">
  <div class="work-left">

        <div class="card">
          <h3 class="title">üìÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå & ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏ü‡∏•‡πå PDF</h3>
          <div class="inline" style="gap:8px">
            <input id="search" class="searchShort" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå..."
                   oninput="onSearchInput()" onkeydown="if(event.key==='Enter'){onSearchDone()}"/>
<div style="margin-top:10px">
  <label for="master">Master</label>
  <input id="master" type="text" placeholder="‡∏Å‡∏£‡∏≠‡∏Å Master" />
</div>

            <button class="btn gray" onclick="clearSearch()">‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏≠‡∏á</button>
            <input type="file" id="folder" webkitdirectory directory multiple style="padding:10px;border:1px dashed #cfd5e1;border-radius:10px;background:#fff"/>
            <button class="btn" id="btnLoad" onclick="loadFolder()">‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå</button>
            <div class="seg" title="‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£">
              <button id="vAll"  onclick="setListMode('all')">‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
              <button id="vOne"  class="active" onclick="setListMode('one')">‡πÅ‡∏™‡∏î‡∏á 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
              <button id="vHide" onclick="setListMode('hidden')">‡∏ã‡πà‡∏≠‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
            <div class="grow"></div>
          </div>
          <div class="status" id="fileCount" style="margin-top:8px">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå</div>
          <div id="listWrap" style="margin-top:10px">
            <div id="list" class="list">
              <div class="meta">‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‚Ä¶</div>
            </div>
          </div>
        </div>

        <div class="card">
          <h3 class="title">üìù ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏ü‡∏•‡πå & ‡∏™‡∏£‡πâ‡∏≤‡∏á QR</h3>
          <div class="row">
            <div>
              <label>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå</label>
              <input id="fileName" placeholder="‡πÄ‡∏ä‡πà‡∏ô DA0101A-18" oninput="updateLast2()"/>
              <div class="status" id="s_last2">‡∏à‡∏∞‡∏ï‡∏±‡∏î‡∏™‡∏µ ‡πÉ‡∏´‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            </div>
            <div>
              <label>‡∏™‡∏µ‡∏Ç‡∏≠‡∏á‡πÑ‡∏ü‡∏•‡πå ‡∏™‡∏µ‡∏Ç‡∏≠‡∏á Roll</label>
              <input id="last2" readonly placeholder="‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥"/>
              <div class="status" id="s_match">-</div>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î 
                <span id="cmLockStatus" class="pill bad" style="margin-left:8px;font-size:11px">üîê ‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà</span>
                <button type="button" class="btn gray" id="btnUnlockCM" style="padding:4px 8px;border-radius:6px;font-size:11px;margin-left:6px" onclick="goUnlockCM()">‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å</button>
              </label>
              <select id="cutMachineNo" disabled>
                <option value="">‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏</option>
                <option value="NC182/132">NC182/132</option>
                <option value="NC182/326">NC182/326</option>
                <option value="NC183/323">NC183/323</option>
                <option value="NC170-02">NC170-02</option>
                <option value="NC170-03">NC170-03</option>
              </select>
              <div class="status" id="s_cutMachineNo"></div>
            </div>
            <div>
              <label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Roll</label>
              <input id="qr21" placeholder="‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà" oninput="onQR21()"/>
              <div class="status" id="s_21">‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Ä¶</div>
            </div>
          </div>

          <div class="row2" style="margin-top:10px">
            <div>
              <label>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• RF</label>
              <input id="qr24" placeholder="‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏µ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡πà‡∏≠‡∏ô" disabled oninput="onQR24()" onchange="onQR24()"/>
              <div class="status" id="s_24">‚õî ‡∏ñ‡∏π‡∏Å‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¢‡∏π‡πà ‚Äî ‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
            </div>
            <div></div>
          </div>
          <div class="inline" style="margin-top:12px">
            <div class="qrbox"><canvas id="qrCanvas" width="180" height="180"></canvas></div>
            <button class="btn" id="btnBuild" onclick="makeQR()" disabled>‡∏™‡∏£‡πâ‡∏≤‡∏á/‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï QR</button>
            <div id="qrWarn" class="status warn" style="margin-top:16px;display:none">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Roll ‡πÅ‡∏•‡∏∞ RF ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö</div>
          </div>
        </div>

        </div>
  <div class="work-right">
<div class="card span-all">
          <div class="title" style="justify-content:space-between;gap:12px;align-items:center">
            <span>üß∞ ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÑ‡∏•‡∏ô‡πå</span>
            <div class="inline" style="gap:8px;align-items:center">
              <label style="margin:0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input id="date" type="date" onchange="mirrorFromUpload(); refreshExtraFromSheet();"/>
              <label style="margin:0 0 0 8px">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</label>
              <select id="line" onchange="mirrorFromUpload(); refreshExtraFromSheet();">
                
                <option value="">‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî</option>
                <option value="J69P">‡πÑ‡∏•‡∏ô‡πå J69P</option>
                <option value="J30A">‡πÑ‡∏•‡∏ô‡πå J30A</option>
                <option value="J30SXK">‡πÑ‡∏•‡∏ô‡πå J30SXK</option>
                <option value="J72A">‡πÑ‡∏•‡∏ô‡πå J72A</option>
                <option value="J03M">‡πÑ‡∏•‡∏ô‡πå J03M</option>
                <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏¥‡∏ï">‡πÑ‡∏•‡∏ô‡πå ‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</option>

              </select>
            </div>
          </div>
          <div class="filters" style="padding-left:8px;padding-right:8px" id="extraFilters">
            <div class="rowfit">
              <div class="status">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤ ‚Äú‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù</div>
            </div>
            <div id="extraFetch" style="margin-top:8px"></div>
            <div id="mirrorBox" class="card" style="border:1px dashed #cfd5e1;background:#fff;padding:12px;border-radius:12px">
              <div class="status">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î ‡∏´‡∏£‡∏∑‡∏≠‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</div>
            </div>
          </div>
        
    <div id="rightPlanSlot"></div>
  </div>
</div>

</div>
  <div class="work-right" id="rightPlan">
</div>
      </div>
    </div>

    <div id="pageUpload" class="hidden">
      <div class="card">
        <h3 class="title">‚¨ÜÔ∏è ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</h3>
        <div class="uploader">
          <div class="inline">
            <input type="file" id="upFile" accept=".csv,.json,.xlsx,.xls" onchange="handleUploadFile(this.files)"/>
            <div id="upStatus" class="status">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö CSV / JSON / Excel (.xlsx/.xls) ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ñ‡∏ß‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏™‡πà‡∏á‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏¢‡∏±‡∏á‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>

            <div class="inline" style="gap:8px;margin-left:8px;">
              <label style="margin:0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input type="date" id="upDateFilter" onchange="renderUploadTable()" />
              <button class="btn gray" onclick="document.getElementById('upDateFilter').value=''; renderUploadTable();">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>
            <div class="inline" style="gap:8px;">
              <label style="margin:0">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï</label>
              <select id="upLineFilter" onchange="renderUploadTable()">
                
                <option value="">‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî</option>
                <option value="J69P">‡πÑ‡∏•‡∏ô‡πå J69P</option>
                <option value="J30A">‡πÑ‡∏•‡∏ô‡πå J30A</option>
                <option value="J30SXK">‡πÑ‡∏•‡∏ô‡πå J30SXK</option>
                <option value="J72A">‡πÑ‡∏•‡∏ô‡πå J72A</option>
                <option value="J03M">‡πÑ‡∏•‡∏ô‡πå J03M</option>
                <option value="‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏¥‡∏ï">‡πÑ‡∏•‡∏ô‡πå ‡∏ô‡∏≠‡∏Å‡πÅ‡∏ú‡∏ô‡∏ú‡∏•‡∏¥‡∏ï</option>

              </select>
              <button class="btn gray" onclick="document.getElementById('upLineFilter').value=''; renderUploadTable();">‡∏•‡πâ‡∏≤‡∏á</button>
            </div>

            <div class="inline" style="gap:8px;align-items:center;"><button class="btn" onclick="saveToGoogleSheet()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï</button><span id="gsStatus" class="status"></span></div>
            <div class="grow"></div>
            <button class="btn gray" onclick="showPage('main')">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
          </div>
          <div id="upTable"></div>
          <div class="hint">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö: <code>fileName</code>, <code>date</code> (‡∏´‡∏£‡∏∑‡∏≠ "‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå", "‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà") ‡πÅ‡∏•‡∏∞ <code>line</code> (‡∏´‡∏£‡∏∑‡∏≠ "‡πÑ‡∏•‡∏ô‡πå", "‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï")</div>
        </div>
      </div>
    </div>
  </div>

  <div id="passModal" class="passmodal" onclick="if(event.target===this) cancelPass()">
    <div class="passcard">
      <h3 style="margin:0 0 8px">üîí ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤ ‚Äú‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‚Äù</h3>
      <div class="status">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÇ‡∏î‡∏¢‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•</div>
      <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
        <input id="passcode" type="password" placeholder="‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™" onkeydown="if(event.key==='Enter'){tryPass()}"/>
        <button class="btn" onclick="tryPass()">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
        <button class="btn gray" onclick="cancelPass()">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
      <div id="passMsg" class="status" style="margin-top:8px"></div>
      <div class="hint" style="margin-top:6px">* ‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ó‡∏î‡∏™‡∏≠‡∏ö: *****</div>
    </div>
  </div>

  <div id="modal" class="modal">
    <div class="top">
      <div class="toolbar">
        <strong id="mName">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</strong>
        <span class="meta" id="mPos"></span>
        <div class="grow"></div>
        <button class="btn" id="mPrintWithQR" onclick="printWithQR()">‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° QR</button>
        <button class="btn gray" id="mPrint" onclick="doPrint()">‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏î‡∏¥‡∏°</button>
        <button class="btn gray" id="mPrev" onclick="goPrev()">‚Üê ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤</button>
        <button class="btn gray" id="mNext" onclick="goNext()">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ ‚Üí</button>
        <button class="btn" id="mClose" onclick="closePreview()">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
    <iframe id="viewer" src=""></iframe>
  </div>

  <iframe id="gs_iframe" name="gs_iframe" style="display:none;width:0;height:0;border:0"></iframe>

<script>
// Permanent device id fallback
const DEVICE_ID = (()=>{
  const k='deviceId.v1';
  let v = localStorage.getItem(k);
  if(!v){ v = 'dev-' + Math.random().toString(36).slice(2) + Date.now().toString(36); localStorage.setItem(k, v); }
  return v;
})();

async function gsGet(params){
  if(typeof GSCRIPT_URL==='undefined'){ console.warn('GSCRIPT_URL not defined'); return {}; }
  const url = GSCRIPT_URL + '?' + new URLSearchParams(params).toString();
  const res = await fetch(url, { method:'GET' });
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}


function getThaiStatusFromSelect(sel){
  if(!sel) return '';
  const raw = (sel.value || (sel.options[sel.selectedIndex] ? sel.options[sel.selectedIndex].textContent : '') || '').trim();
  // normalize spaces and lowercase for matching
  const s = raw.replace(/\s+/g,'').toLowerCase();
  if(!s) return '';
  // map common variants
  if (s.includes('‡πÄ‡∏™‡∏£‡πá‡∏à') || s==='done') return '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
  if (s.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥') || s.includes('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£') || s==='progress' || s==='doing') return '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥';
  if (s.includes('‡∏õ‡∏±‡∏ç‡∏´‡∏≤') || s==='blocked' || s==='issue' || s.includes('‡∏ï‡∏¥‡∏î‡∏Ç‡∏±‡∏î')) return '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
  if (s.includes('‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î') || s==='all') return '‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î'; // not expected to be saved
  if (s.includes('‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞')) return ''; // placeholder
  return raw; // fallback use raw label as-is
}

async function gsPostJSON(payload){
  if(typeof GSCRIPT_URL==='undefined'){ console.warn('GSCRIPT_URL not defined'); return {}; }
  const res = await fetch(GSCRIPT_URL, {
    method: 'POST',
    headers: { 'Content-Type':'application/x-www-form-urlencoded' },
    body: 'payload=' + encodeURIComponent(JSON.stringify(payload))
  });
  if(!res.ok) throw new Error('HTTP '+res.status);
  return res.json();
}


// === v25: Read status/note via doGet?action=fetch (sheet: Extra_Status) ===

// Build row key (legacy & normalized) to maximize match
function buildRowKeyLegacy(tr, maxCols){
  const tds = tr.querySelectorAll('td');
  const a = [];
  for(let i=0;i<Math.min(4, maxCols||4); i++){
    a.push((tds[i] && String(tds[i].innerText).trim()) || '');
  }
  return a.join('|');
}
function buildRowKeyNormalized(tr, maxCols){
  const tds = tr.querySelectorAll('td');
  const a = [];
  for(let i=0;i<Math.min(4, maxCols||4); i++){
    let v = (tds[i] && tds[i].innerText) ? String(tds[i].innerText).trim() : '';
    v = v.replace(/\s+/g,' ');
    if(i>=2){ v = v.replace(/[, \u00A0]/g,''); }
    a.push(v);
  }
  return a.join('|');
}
function buildRowKeyFromTR(tr, maxCols){ return buildRowKeyLegacy(tr, maxCols); } // keep legacy for saving

// Read map from Extra_Status without changing GAS (client-side filter)
async function fetchStatusMapFromExtra(sheetName){
  try{
    const res = await gsGet({ action:'fetch', sheetName:'Extra_Status', columns:'A:E', header:'0' });
    const rows = (res && res.rows) ? res.rows : [];
    const map = {};
    for(const r of rows){
      const sh  = String(r[0]||'').trim();   // sheetName
      const key = String(r[1]||'').trim();   // rowKey
      const st  = String(r[2]||'').trim();   // status
      const note= String(r[3]||'').trim();   // note
      const ts  = String(r[4]||'').trim();   // ts
      if (sh === sheetName && key) {
        map[key] = { status: st, note: note, ts: ts };
      }
    }
    return map;
  }catch(e){
    console.warn('fetchStatusMapFromExtra failed', e);
    return {};
  }
}

// Debug toggle: Alt+D to show computed key and whether found
(function(){
  let on = false;
  document.addEventListener('keydown', (ev)=>{
    if(ev.altKey && (ev.key==='d' || ev.key==='D')){
      on = !on;
      const tbl = document.getElementById('extraTable');
      if(!tbl) return;
      tbl.querySelectorAll('tbody tr').forEach(tr=>{
        let badge = tr.querySelector('.dbg-key');
        if(on){
          if(!badge){
            badge = document.createElement('div');
            badge.className = 'dbg-key';
            badge.style = 'font-size:10px;color:#94a3b8;margin-top:2px;';
            const td = tr.querySelector('td:nth-child(1)'); if(td) td.appendChild(badge);
          }
          const k1 = buildRowKeyLegacy(tr,4);
          const k2 = buildRowKeyNormalized(tr,4);
          const found = tr.getAttribute('data-status-found')==='1' ? '‚úì' : '√ó';
          badge.textContent = `[${found}] key1=${k1} | key2=${k2}`;
        }else if(badge){
          badge.remove();
        }
      });
    }
  });
})();

// Build row key from first 4 columns (Cut-file | Materials | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á | ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡∏±‡∏î‡πÑ‡∏î‡πâ(‡∏ä‡∏¥‡πâ‡∏ô))
function buildRowKeyFromTR(tr, maxCols){
  const tds = tr.querySelectorAll('td');
  const a = [];
  for(let i=0;i<Math.min(4, maxCols); i++){
    a.push((tds[i] && tds[i].innerText.trim()) || '');
  }
  return a.join('|');
}

// Hydrate row statuses from GAS after rendering
async function hydrateStatusFromGS(sheetName, maxCols){
  try{
    const tbl = document.getElementById('extraTable');
    if(!tbl) return;
    const map = await fetchStatusMapFromExtra(sheetName);
    tbl.querySelectorAll('tbody tr').forEach(tr=>{
      const key1 = buildRowKeyLegacy(tr, maxCols||4);
      let data = map[key1];
      if(!data){ const key2 = buildRowKeyNormalized(tr, maxCols||4); data = map[key2]; }
      const sel = tr.querySelector('select[data-role="status"]');
      const note= tr.querySelector('input[data-role="note"]');
      const ts  = tr.querySelector('small[data-role="ts"]');
      const d = data || {status:'',note:'',ts:''};
      if (sel) sel.value = d.status || '';
      if (note) note.value = d.note || '';
      if (ts)   ts.textContent = d.ts ? ('‡πÄ‡∏ß‡∏•‡∏≤: ' + new Date(d.ts).toLocaleString('th-TH',{hour12:false})) : '';
      tr.setAttribute('data-status-found', d.status? '1':'0');
      tr.classList.remove('row-status-done','row-status-blocked','row-status-progress');
      if(d.status==='‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') tr.classList.add('row-status-done');
      else if(d.status==='‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤') tr.classList.add('row-status-blocked');
      else if(d.status==='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥') tr.classList.add('row-status-progress');
    });
  }catch(e){ console.warn('hydrateStatusFromGS failed', e); }
}

// Post one row status to GAS (called on select/note changes)

// === v26: Batching & Auto-save for status/note ===
const _PENDING_STATUS = new Map(); // key -> {rowKey,status,note,ts}
let _pendingTimer = null;

function markRowDirty(tr){
  try{ tr.setAttribute('data-dirty','1'); tr.style.setProperty('--dirty-shadow','inset 0 0 0 1px rgba(59,130,246,0.25)'); }catch(e){}
}
function unmarkAllDirty(){
  try{
    document.querySelectorAll('#extraTable tbody tr[data-dirty="1"]').forEach(tr=>{
      tr.removeAttribute('data-dirty');
      tr.style.removeProperty('--dirty-shadow');
    });
  }catch(e){}
}

function queueRowStatus(tr){
  const d = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter');
  const l = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter');
  const dV = (d && d.value) ? d.value : '';
  const lV = (l && l.value) ? l.value : '';
  if(!(dV && lV)) return {sheetName:'', row:null};

  const dISO = dV.includes('/')? (dV.split('/')[2]+'-'+dV.split('/')[0].padStart(2,'0')+'-'+dV.split('/')[1].padStart(2,'0')) : dV;
  const raw  = genSheetName(dISO, lV);
  const sheetName = raw.replace(/[\\/:*?\\[\\]]/g,'-');

  const key   = buildRowKeyFromTR(tr, 4); // legacy for writing
  const sel   = tr.querySelector('select[data-role=\"status\"]');
  const note  = tr.querySelector('input[data-role=\"note\"]');
  const tsLbl = tr.querySelector('small[data-role=\"ts\"]');

  const status= getThaiStatusFromSelect(sel);
  const noteVal = note ? note.value : '';
  const tsText = tsLbl && tsLbl.textContent ? tsLbl.textContent.replace('‡πÄ‡∏ß‡∏•‡∏≤:','').trim() : '';
  const tsISO = localISOInTZ('Asia/Bangkok');

  const payload = { rowKey:key, status, note:noteVal, ts:tsISO, deviceId: DEVICE_ID };
  _PENDING_STATUS.set(key, payload);
  markRowDirty(tr);

  // update button count
  const cnt = document.getElementById('saveAllCount'); if (cnt) cnt.textContent = String(_PENDING_STATUS.size);

  scheduleSavePending(sheetName);
  return {sheetName, row:payload};
}

function scheduleSavePending(sheetName){
  if (_pendingTimer) return;
  _pendingTimer = setTimeout(()=>{ flushSavePending(sheetName); }, 1200);
}

async function flushSavePending(sheetName){
  try{
    clearTimeout(_pendingTimer); _pendingTimer = null;
    if (!_PENDING_STATUS.size) return;
    const rows = Array.from(_PENDING_STATUS.values());
    const res = await gsPostJSON({ action:'saveStatus', sheetName, rows }); console.log('saveStatus batch response', res);
    _PENDING_STATUS.clear();
    const cnt = document.getElementById('saveAllCount'); if (cnt) cnt.textContent = '0';
    unmarkAllDirty();
    // reflect saved timestamp on rows
    const nowTH = new Date().toLocaleString('th-TH',{hour12:false});
    document.querySelectorAll('#extraTable tbody tr').forEach(tr=>{
      const ts  = tr.querySelector('small[data-role=\"ts\"]');
      if (ts) ts.textContent = '‡πÄ‡∏ß‡∏•‡∏≤: ' + nowTH;
    });
  }catch(e){ console.warn('flushSavePending failed', e); }
}

// QuickSave button
document.addEventListener('click', function(ev){
  const btn = ev.target.closest && ev.target.closest('#saveAllStatusBtn');
  if(!btn) return;
  const d = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter');
  const l = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter');
  const dV = (d && d.value) ? d.value : '';
  const lV = (l && l.value) ? l.value : '';
  if(!(dV && lV)) return;
  const dISO = dV.includes('/')? (dV.split('/')[2]+'-'+dV.split('/')[0].padStart(2,'0')+'-'+dV.split('/')[1].padStart(2,'0')) : dV;
  const raw  = genSheetName(dISO, lV);
  const sheetName = raw.replace(/[\\/:*?\\[\\]]/g,'-');
  flushSavePending(sheetName);
});

// On visibility change / before unload, try flushing
document.addEventListener('visibilitychange', ()=>{
  if (document.visibilityState === 'hidden'){
    const d = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter');
    const l = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter');
    const dV = (d && d.value) ? d.value : '';
    const lV = (l && l.value) ? l.value : '';
    if(dV && lV){
      const dISO = dV.includes('/')? (dV.split('/')[2]+'-'+dV.split('/')[0].padStart(2,'0')+'-'+dV.split('/')[1].padStart(2,'0')) : dV;
      const raw  = genSheetName(dISO, lV);
      const sheetName = raw.replace(/[\\/:*?\\[\\]]/g,'-');
      flushSavePending(sheetName);
    }
  }
});

async function postOneRowStatusFromTR(tr){
  try{
    const d = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter');
    const l = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter');
    const dISO = (d && d.value) ? d.value : '';
    const ln   = (l && l.value) ? l.value : '';
    if(!(dISO && ln)) return;
    const raw  = genSheetName(dISO.includes('/')? (dISO.split('/')[2]+'-'+dISO.split('/')[0].padStart(2,'0')+'-'+dISO.split('/')[1].padStart(2,'0')) : dISO, ln);
    const sheetName = raw.replace(/[\/:*?\[\]]/g,'-');
    const key   = buildRowKeyFromTR(tr, 4);
    const sel   = tr.querySelector('select[data-role=\"status\"]');
    const note  = tr.querySelector('input[data-role=\"note\"]');
    const tsLbl = tr.querySelector('small[data-role=\"ts\"]');
    const status= getThaiStatusFromSelect(sel);
    const noteVal = note ? note.value : '';
    const tsText = tsLbl && tsLbl.textContent ? tsLbl.textContent.replace('‡πÄ‡∏ß‡∏•‡∏≤:','').trim() : '';
    const tsISO = localISOInTZ('Asia/Bangkok');
    await gsPostJSON({ action:'saveStatus', sheetName, rows:[{ rowKey:key, status, note:noteVal, ts:tsISO, deviceId: DEVICE_ID }] });
  }catch(e){ console.warn('postOneRowStatusFromTR failed', e); }
}

// Attach minimal listeners (in addition to existing ones) to push to GAS
document.addEventListener('DOMContentLoaded', ()=>{
  const wrapAttach = ()=>{
    const tbl = document.getElementById('extraTable');
    if(!tbl) return;
    if(tbl._gasAttached) return;
    tbl._gasAttached = true;

    tbl.addEventListener('change', ev=>{
      const t = ev.target;
      if(t && (t.matches('select[data-role=\"status\"]'))){
        const tr = t.closest('tr');
        queueRowStatus(tr);
      }
    });

    tbl.addEventListener('input', ev=>{
      const t = ev.target;
      if(t && (t.matches('input[data-role=\"note\"]'))){
        clearTimeout(t._gsDeb || 0);
        t._gsDeb = setTimeout(()=>{
          const tr = t.closest('tr');
          queueRowStatus(tr);
        }, 500);
      }
    });
  };
  // try now and also after each render
  wrapAttach();
  const host = document.getElementById('extraFetch');
  if(host){
    const mo = new MutationObserver(()=>wrapAttach());
    mo.observe(host, { childList:true, subtree:true });
  }
});


// Show which scope is used for the filter preference
function showPrefScopeBadge(sheetName){
  try{
    const bar = document.getElementById('statusFilterBar');
    if(!bar) return;
    let badge = document.getElementById('prefScopeBadge');
    if(!badge){
      badge = document.createElement('div');
      badge.id = 'prefScopeBadge';
      badge.style = 'margin:4px 0 0 0; font-size:11px; color:#64748b;';
      bar.parentElement.insertBefore(badge, bar.nextSibling);
    }
    badge.textContent = sheetName ? ('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏ö: ' + sheetName) : '';
  }catch(e){}
}

// Persist user's status filter preference on GAS
async function loadStatusFilterPrefAndApply(sheetName){
  try{
    const js = await gsGet({ action:'loadPref', deviceId: DEVICE_ID, sheetName });     
    const want = (js && js.lastStatusFilter) ? js.lastStatusFilter : '';
    const bar = document.getElementById('statusFilterBar');
    if(!bar) return;
    if(want){
      const btn = bar.querySelector('[data-status-filter=\"'+want+'\"]');
      if(btn){ btn.click(); }
    }
  }catch(e){ console.warn('loadStatusFilterPrefAndApply failed', e); }
}

function saveStatusFilterPref(sheetName, val){
  gsPostJSON({ action:'savePref', deviceId: DEVICE_ID, sheetName, lastStatusFilter: val }).catch(console.warn);
}

// Attach click saver for filter bar
document.addEventListener('click', function(ev){
  const btn = ev.target.closest && ev.target.closest('#statusFilterBar [data-status-filter]');
  if(!btn) return;
  const val = btn.getAttribute('data-status-filter') || '';
  // derive current sheetName from controls
  const d = document.getElementById('date') || document.getElementById('mDateFilter') || document.getElementById('upDateFilter');
  const l = document.getElementById('line') || document.getElementById('mLineFilter') || document.getElementById('upLineFilter');
  const dV = (d && d.value) ? d.value : '';
  const lV = (l && l.value) ? l.value : '';
  if(!(dV && lV)) return;
  const dISO = dV.includes('/')? (dV.split('/')[2]+'-'+dV.split('/')[0].padStart(2,'0')+'-'+dV.split('/')[1].padStart(2,'0')) : dV;
  const raw  = genSheetName(dISO, lV);
  const sheetName = raw.replace(/[\/:*?\[\]]/g,'-');
  saveStatusFilterPref(sheetName, val);

});
</script>
<script>
/* === v34: Auto-save QR log on build (single sheet) === */
(function(){
  const SHEET_NAME = 'QR_Log'; // single sheet for all QR logs

  function readVal(id){
    const el = document.getElementById(id);
    return (el && typeof el.value === 'string') ? el.value.trim() : '';
  }

  function autoSaveQRLog(){
    try{
      const fileName = readVal('fileName');
      const scan21   = readVal('qr21'); // may be empty
      const scan24   = readVal('qr24'); // may be empty
      const dateV    = readVal('date');
      const lineV    = readVal('line');
      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo VVVV
      const cutMachineNo = readVal('cutMachineNo'); 

      if(!fileName || !dateV) return; // essential fields only

      let qrText = '';
      try{
        // VVVV ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï qrText VVVV
        qrText = (typeof collectData === 'function') ? collectData() : [fileName, scan24, dateV, lineV, cutMachineNo].join('|');
      }catch(_){}

      const savedAt = (typeof localISOInTZ==='function') ? localISOInTZ('Asia/Bangkok') : new Date().toISOString();

      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° 'cutMachineNo' ‡πÉ‡∏ô columns VVVV
      const columns = ['fileName','scan21','scan24','date','line','qrText','_savedAt', 'cutMachineNo'];
      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô rows VVVV
      const rows = [{ fileName, scan21, scan24, date: dateV, line: lineV, qrText, _savedAt: savedAt, cutMachineNo }];

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = (typeof GSCRIPT_URL!=='undefined' ? GSCRIPT_URL : '');
      form.target = 'gs_iframe';

      const inp = document.createElement('input');
      inp.type = 'hidden'; inp.name = 'payload';
      inp.value = JSON.stringify({ sheetName: SHEET_NAME, columns, rows });

      form.appendChild(inp);
      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>{ try{ document.body.removeChild(form);}catch(e){} }, 1000);
    }catch(e){ /* silent */ }
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnBuild');
    if(!btn) return;
    const old = btn.onclick;
    btn.onclick = function(ev){
      try{ if(old) old.call(this, ev); } finally {
        setTimeout(autoSaveQRLog, 200);
      }
    };
  });
})();
/* === /v34 === */
</script><script>
/* v35: stronger field reading for scan21/24 */
(function(){
  function val(el){ return (el && el.value!=null) ? String(el.value).trim() : ''; }
  function getScan21(){
    const cands = [
      document.getElementById('qr21'),
      document.querySelector('[data-scan="21"]'),
      document.querySelector('[data-scan21]'),
      document.querySelector('input[name*="21"]'),
      document.querySelector('input[placeholder*="21"]')
    ];
    for(const el of cands){ const v=val(el); if(v) return v; }
    return val(cands[0]);
  }
  function getScan24(){
    const cands = [
      document.getElementById('qr24'),
      document.querySelector('[data-scan="24"]'),
      document.querySelector('[data-scan24]'),
      document.querySelector('input[name*="24"]'),
      document.querySelector('input[placeholder*="24"]')
    ];
    for(const el of cands){ const v=val(el); if(v) return v; }
    return val(cands[0]);
  }
  // Monkey-patch autoSaveQRLog to use new getters if it exists
  if (window.autoSaveQRLog_v35_patched) return;
  window.autoSaveQRLog_v35_patched = true;

  const prev = window.autoSaveQRLog;
  window.autoSaveQRLog = function(){
    try{
      const readVal = (id)=>{ const el = document.getElementById(id); return (el && el.value) ? el.value.trim() : ''; }
      const fileName = readVal('fileName');
      const dateV = readVal('date');
      const lineV = readVal('line');
      const scan21 = getScan21();
      const scan24 = getScan24();
      const cutMachineNo = readVal('cutMachineNo'); // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo VVVV

      if(!fileName || !dateV) return;
      let qrText='';
      try{ // VVVV ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï qrText VVVV
        qrText = (typeof collectData==='function') ? collectData() : [fileName, scan24, dateV, lineV, cutMachineNo].join('|'); 
      }catch(_){}

      const savedAt = (typeof localISOInTZ==='function') ? localISOInTZ('Asia/Bangkoks') : new Date().toISOString();
      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° 'cutMachineNo' ‡πÉ‡∏ô columns VVVV
      const columns = ['fileName','scan21','scan24','date','line','qrText','_savedAt', 'cutMachineNo'];
      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô rows VVVV
      const rows = [{ fileName, scan21, scan24, date:dateV, line:lineV, qrText, _savedAt:savedAt, cutMachineNo }];

      const form = document.createElement('form');
      form.method = 'POST'; form.action = (typeof GSCRIPT_URL!=='undefined' ? GSCRIPT_URL : ''); form.target='gs_iframe';
      const inp = document.createElement('input'); inp.type='hidden'; inp.name='payload'; inp.value = JSON.stringify({ sheetName:'QR_Log', columns, rows });
      form.appendChild(inp); document.body.appendChild(form); form.submit();
      setTimeout(()=>{ try{ document.body.removeChild(form);}catch(e){} }, 1200);
    }catch(e){ /* silent */ }
  }
})();</script><script>
/* v36: snapshot values BEFORE makeQR runs (handles fields cleared by makeQR) */
(function(){
  const SHEET_NAME = 'QR_Log';

  function read(id){
    const el = document.getElementById(id);
    return (el && typeof el.value === 'string') ? el.value.trim() : '';
  }
  function snapshotFields(){
    // Try exact ids first
    let scan21 = read('qr21');
    let scan24 = read('qr24');
    // Fallbacks (from v35 robust)
    if(!scan21){
      const alt21 = document.querySelector('[data-scan="21"],[data-scan21],input[name*="21"],input[placeholder*="21"]');
      if(alt21 && alt21.value!=null) scan21 = String(alt21.value).trim();
    }
    if(!scan24){
      const alt24 = document.querySelector('[data-scan="24"],[data-scan24],input[name*="24"],input[placeholder*="24"]');
      if(alt24 && alt24.value!=null) scan24 = String(alt24.value).trim();
    }
    return {
      fileName: read('fileName'),
      date: read('date'),
      line: read('line'),
      scan21, scan24,
      cutMachineNo: read('cutMachineNo') // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo VVVV
    };
  }
  function postLog(snap){
    try{
      if(!snap.fileName || !snap.date) return; // essential guard
      let qrText='';
      try{ // VVVV ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï qrText VVVV
        qrText = (typeof collectData==='function') ? collectData() : [snap.fileName, snap.scan24, snap.date, snap.line, snap.cutMachineNo].join('|'); 
      }catch(_){}
      const savedAt = (typeof localISOInTZ==='function') ? localISOInTZ('Asia/Bangkok') : new Date().toISOString();
      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° 'cutMachineNo' ‡πÉ‡∏ô columns VVVV
      const columns = ['fileName','scan21','scan24','date','line','qrText','_savedAt', 'cutMachineNo'];
      // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô rows VVVV
      const rows = [{ fileName:snap.fileName, scan21:snap.scan21||'', scan24:snap.scan24||'', date:snap.date, line:snap.line, qrText, _savedAt:savedAt, cutMachineNo: snap.cutMachineNo||'' }];

      const form = document.createElement('form');
      form.method='POST'; form.action=(typeof GSCRIPT_URL!=='undefined'?GSCRIPT_URL:''); form.target='gs_iframe';
      const inp = document.createElement('input'); inp.type='hidden'; inp.name='payload'; inp.value=JSON.stringify({ sheetName:SHEET_NAME, columns, rows });
      form.appendChild(inp); document.body.appendChild(form); form.submit();
      setTimeout(()=>{ try{ document.body.removeChild(form);}catch(e){} }, 1200);
    }catch(e){ /* silent */ }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnBuild');
    if(!btn) return;
    const old = btn.onclick;
    btn.onclick = function(ev){
      // take snapshot BEFORE original handler runs (in case it clears inputs)
      const snap = snapshotFields();
      try{ if(old) old.call(this, ev); } finally {
        setTimeout(()=>postLog(snap), 150);
      }
    };
  });
})();
</script><script>
/* v37: persist last scanned 21/24; read from input, last cache, or qrText */
(function(){
  const LS21 = 'qrlog_last_scan21';
  const LS24 = 'qrlog_last_scan24';
  const LS_CUTMACHINE = 'qrlog_last_cutmachine'; // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo Cache Key VVVV

  function cache(key, val){
    try{ localStorage.setItem(key, val||''); }catch(e){}
    try{ window['__'+key] = val||''; }catch(e){}
  }
  function readCache(key){
    try{
      if (window['__'+key]) return window['__'+key];
      const v = localStorage.getItem(key);
      return v || '';
    }catch(e){ return ''; }
  }
  function hookTrackers(){
    const grab = (sel)=>document.querySelector(sel);
    const i21 = grab('#qr21') || grab('[data-scan="21"]') || grab('[data-scan21]');
    const i24 = grab('#qr24') || grab('[data-scan="24"]') || grab('[data-scan24]');
    const iCM = grab('#cutMachineNo'); // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo Hook VVVV
    
    function bind(el, key){
      if(!el) return;
      const h = ()=> cache(key, (el.value||'').trim());
      ['input','change','blur','keyup','paste'].forEach(ev=>el.addEventListener(ev,h));
      // observe programmatic value changes
      try{
        const mo = new MutationObserver(h);
        mo.observe(el, { attributes:true, attributeFilter:['value'] });
      }catch(_){}
    }
    bind(i21, LS21);
    bind(i24, LS24);
    bind(iCM, LS_CUTMACHINE); // VVVV Bind cutMachineNo VVVV
  }

  // run asap
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', hookTrackers);
  } else {
    hookTrackers();
  }

  // monkey-patch postLog in v36 to merge scan21/24 from caches
  const oldPost = (function(){
    // find the function we injected previously
    return null; // not strictly needed; we'll override snapshot post flow below
  })();

  // Override button hook again: keep snapshot then enrich from caches and qrText
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnBuild');
    if(!btn) return;
    const orig = btn.onclick;
    btn.onclick = function(ev){
      // base snapshot
      const read = (id)=>{ const el=document.getElementById(id); return (el && typeof el.value==='string')?el.value.trim():''; };
      const snap = {
        fileName: read('fileName'),
        date: read('date'),
        line: read('line'),
        scan21: read('qr21'),
        scan24: read('qr24'),
        cutMachineNo: read('cutMachineNo') // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo VVVV
      };
      // merge with cached last non-empty
      if(!snap.scan21){ snap.scan21 = readCache(LS21); }
      if(!snap.scan24){ snap.scan24 = readCache(LS24); }
      if(!snap.cutMachineNo){ snap.cutMachineNo = readCache(LS_CUTMACHINE); } // VVVV Merge cutMachineNo VVVV

      try{ if(orig) orig.call(this, ev); } finally {
        setTimeout(()=>{
          try{
            // get qrText now that QR built
            let qrText='';
            try{ // VVVV ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï qrText VVVV
              qrText = (typeof collectData==='function') ? collectData() : [snap.fileName, snap.scan24, snap.date, snap.line, snap.cutMachineNo].join('|'); 
            }catch(_){}
            // derive scan24 from qrText if still empty
            if(!snap.scan24 && qrText){
              const parts = String(qrText).split('|');
              if(parts.length>=2 && parts[1]) snap.scan24 = parts[1];
            }
            // send to GAS
            const savedAt = (typeof localISOInTZ==='function') ? localISOInTZ('Asia/Bangkok') : new Date().toISOString();
            // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° 'cutMachineNo' ‡πÉ‡∏ô columns VVVV
            const columns = ['fileName','scan21','scan24','date','line','qrText','_savedAt', 'cutMachineNo'];
            // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô rows VVVV
            const rows = [{ fileName:snap.fileName, scan21:snap.scan21||'', scan24:snap.scan24||'', date:snap.date, line:snap.line, qrText, _savedAt:savedAt, cutMachineNo: snap.cutMachineNo||'' }];
            const form = document.createElement('form');
            form.method='POST'; form.action=(typeof GSCRIPT_URL!=='undefined'?GSCRIPT_URL:''); form.target='gs_iframe';
            const inp = document.createElement('input'); inp.type='hidden'; inp.name='payload'; inp.value=JSON.stringify({ sheetName:'QR_Log', columns, rows });
            form.appendChild(inp); document.body.appendChild(form); form.submit();
            setTimeout(()=>{ try{ document.body.removeChild(form);}catch(e){} }, 1200);
          }catch(e){/*silent*/}
        },150);
      }
    };
  });
})();
</script><script>
/* v38: hook onQR21/onQR24 & makeQR to persist actual scan strings */
(function(){
  const LS21='qrlog_last_scan21', LS24='qrlog_last_scan24', LS_CUTMACHINE='qrlog_last_cutmachine'; // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo Key VVVV
  function cache(k,v){ try{ localStorage.setItem(k, v||''); window['__'+k]=v||''; }catch(e){} }
  function val(id){ const el=document.getElementById(id); return (el&&typeof el.value==='string')?el.value.trim():''; }

  function installHooks(){
    // Wrap onQR21/onQR24 if they exist later
    function wrap(name, key, id){
      try{
        const orig = window[name];
        if (orig && !orig.__qrlogWrapped){
          window[name] = function(){
            try{ return orig.apply(this, arguments); }
            finally{ cache(key, val(id)); }
          };
          window[name].__qrlogWrapped = true;
        }
      }catch(_){}
    }
    wrap('onQR21', LS21, 'qr21');
    wrap('onQR24', LS24, 'qr24');

    // Also wrap makeQR to capture final input values just before it clears
    try{
      const m = window.makeQR;
      if (m && !m.__qrlogWrapped){
        window.makeQR = function(){
          // snapshot before original (in case it clears)
          cache(LS21, val('qr21'));
          cache(LS24, val('qr24'));
          cache(LS_CUTMACHINE, val('cutMachineNo')); // VVVV Cache cutMachineNo VVVV
          return m.apply(this, arguments);
        };
        window.makeQR.__qrlogWrapped = true;
      }
    }catch(_){}
  }

  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', installHooks);
  } else {
    installHooks();
  }
})();
</script><script>
/* v39: also read from status divs #s_21 / #s_24 (textContent) */
(function(){
  const LS21='qrlog_last_scan21', LS24='qrlog_last_scan24', LS_CUTMACHINE='qrlog_last_cutmachine'; // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo Key VVVV
  function cache(k,v){ try{ localStorage.setItem(k, v||''); window['__'+k]=v||''; }catch(e){} }
  function val(id){ const el=document.getElementById(id); return (el&&typeof el.value==='string')?el.value.trim():''; }
  function valText(id){ const el=document.getElementById(id); return (el&&el.textContent)?el.textContent.trim():''; }

  // Try to parse scan text from status line "‡∏à‡∏∞‡∏£‡∏±‡∏ö‡∏™‡πÅ‡∏Å‡∏ô 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£: XXXXX"
  function parseFromStatus(text){
    // find last chunk of 21/24 after colon
    if(!text) return '';
    const parts = text.split(':'); 
    const last = parts[parts.length-1] || '';
    return last.trim();
  }

  function installStatusReaders(){
    // When onQR handlers fire, also read s_21/s_24
    function wrap(name, key, id, sid){
      const orig = window[name];
      if (orig && !orig.__qrlogStatusWrapped){
        window[name] = function(){
          try{ return orig.apply(this, arguments); }
          finally{ 
            let v = val(id);
            if(!v){ v = parseFromStatus(valText(sid)); }
            cache(key, v);
          }
        };
        window[name].__qrlogStatusWrapped = true;
      }
    }
    wrap('onQR21', LS21, 'qr21', 's_21');
    wrap('onQR24', LS24, 'qr24', 's_24');

    // Also wrap makeQR (snapshot before it clears)
    if (window.makeQR && !window.makeQR.__qrlogStatusWrapped){
      const m = window.makeQR;
      window.makeQR = function(){
        let v21 = val('qr21'); if(!v21){ v21 = parseFromStatus(valText('s_21')); }
        let v24 = val('qr24'); if(!v24){ v24 = parseFromStatus(valText('s_24')); }
        let vCM = val('cutMachineNo'); // VVVV ‡∏≠‡πà‡∏≤‡∏ô cutMachineNo VVVV
        cache(LS21, v21); 
        cache(LS24, v24);
        cache(LS_CUTMACHINE, vCM); // VVVV Cache cutMachineNo VVVV
        return m.apply(this, arguments);
      };
      window.makeQR.__qrlogStatusWrapped = true;
    }
  }

  if (document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', installStatusReaders);
  } else {
    installStatusReaders();
  }

  // Patch the btnBuild flow to use cached values + fallback to status text
  document.addEventListener('DOMContentLoaded', ()=>{
    const btn = document.getElementById('btnBuild');
    if(!btn) return;
    const orig = btn.onclick;
    btn.onclick = function(ev){
      const read = (id)=>{ const el=document.getElementById(id); return (el && typeof el.value==='string')?el.value.trim():''; };
      const readStatus = (sid)=>parseFromStatus(valText(sid));
      let snap = {
        fileName: read('fileName'),
        date: read('date'),
        line: read('line'),
        scan21: read('qr21') || readStatus('s_21') || (window.__qrlog_last_scan21||localStorage.getItem('qrlog_last_scan21')||''),
        scan24: read('qr24') || readStatus('s_24') || (window.__qrlog_last_scan24||localStorage.getItem('qrlog_last_scan24')||''),
        cutMachineNo: read('cutMachineNo') || (window.__qrlog_last_cutmachine||localStorage.getItem('qrlog_last_cutmachine')||'') // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo VVVV
      };
      try{ if(orig) orig.call(this, ev); } finally {
        setTimeout(()=>{
          try{
            let qrText = '';
            try{ // VVVV ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï qrText VVVV
              qrText = (typeof collectData==='function') ? collectData() : [snap.fileName, snap.scan24, snap.date, snap.line, snap.cutMachineNo].join('|'); 
            }catch(_){}
            if(!snap.scan24 && qrText){
              const parts = String(qrText).split('|');
              if(parts.length>=2 && parts[1]) snap.scan24 = parts[1].trim();
            }
            const savedAt = (typeof localISOInTZ==='function') ? localISOInTZ('Asia/Bangkok') : new Date().toISOString();
            // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° 'cutMachineNo' ‡πÉ‡∏ô columns VVVV
            const columns = ['fileName','scan21','scan24','date','line','qrText','_savedAt', 'cutMachineNo'];
            // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô rows VVVV
            const rows = [{ fileName:snap.fileName, scan21:snap.scan21||'', scan24:snap.scan24||'', date:snap.date, line:snap.line, qrText, _savedAt:savedAt, cutMachineNo: snap.cutMachineNo||'' }];
            const form = document.createElement('form');
            form.method='POST'; form.action=(typeof GSCRIPT_URL!=='undefined'?GSCRIPT_URL:''); form.target='gs_iframe';
            const inp = document.createElement('input'); inp.type='hidden'; inp.name='payload'; inp.value=JSON.stringify({ sheetName:'QR_Log', columns, rows });
            form.appendChild(inp); document.body.appendChild(form); form.submit();
            setTimeout(()=>{ try{ document.body.removeChild(form);}catch(e){} }, 1200);
          }catch(e){}
        }, 120);
      }
    };
  });
})();
</script>
<script>
/* QR_Log ‚Äì single-save fix (makeQR-only, strong dedupe) */
(function () {
  const SHEET = 'QR_Log';
  const LS21 = 'qrlog_last_scan21';
  const LS24 = 'qrlog_last_scan24';
  const LS_CUTMACHINE = 'qrlog_last_cutmachine'; // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° Cache Key VVVV

  // hard lock to ensure only ONE save per makeQR execution
  let _savingLock = false;
  let _lastSig = '';
  let _lastAt = 0;

  function read(id){
    const el = document.getElementById(id);
    return (el && typeof el.value === 'string') ? el.value.trim() : '';
  }
  function cached(key){
    try { return window['__' + key] || localStorage.getItem(key) || ''; }
    catch (_) { return ''; }
  }
  function snapNow(){
    return {
      fileName: read('fileName'),
      date: read('date'),
      line: read('line'),
      scan21: read('qr21') || cached(LS21),
      scan24: read('qr24') || cached(LS24),
      cutMachineNo: read('cutMachineNo') || cached(LS_CUTMACHINE) // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo VVVV
    };
  }
  function safeQRText(fileName, scan24, dateV, lineV, cutMachineNo){ // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô args VVVV
    try {
      if (typeof collectData === 'function') {
        const c = collectData();
        if (c && String(c).trim()) return c;
      }
    } catch(_) {}
    // VVVV ‡∏£‡∏ß‡∏° cutMachineNo ‡πÉ‡∏ô fallback QR Text VVVV
    const base = [fileName, scan24, dateV, lineV].join('|');
    return cutMachineNo ? base+'|'+cutMachineNo : base;
  }

  function postToGS(snap){
    if (!snap.fileName || !snap.date) return;

    // strong de-duplication: lock for a short interval
    if (_savingLock) return;
    _savingLock = true;
    setTimeout(() => { _savingLock = false; }, 1500);

    // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô sig VVVV
    const sig = [snap.fileName, snap.scan21, snap.scan24, snap.date, snap.line, snap.cutMachineNo].join('|');
    const now = Date.now();
    if (sig === _lastSig && (now - _lastAt) < 2000) return;
    _lastSig = sig; _lastAt = now;

    // VVVV ‡∏™‡πà‡∏á cutMachineNo ‡πÑ‡∏õ‡∏¢‡∏±‡∏á safeQRText VVVV
    const qrText = safeQRText(snap.fileName, snap.scan24, snap.date, snap.line, snap.cutMachineNo);
    const savedAt = (typeof localISOInTZ==='function') ? localISOInTZ('Asia/Bangkok') : new Date().toISOString();
    // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° 'cutMachineNo' ‡πÉ‡∏ô columns VVVV
    const columns = ['fileName','scan21','scan24','date','line','qrText','_savedAt', 'cutMachineNo'];
    // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏° cutMachineNo ‡πÉ‡∏ô rows VVVV
    const rows = [{ 
      fileName: snap.fileName, scan21: snap.scan21 || '', scan24: snap.scan24 || '', date: snap.date, line: snap.line, qrText, _savedAt: savedAt, 
      cutMachineNo: snap.cutMachineNo || '' 
    }];

    try {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = (typeof GSCRIPT_URL !== 'undefined' ? GSCRIPT_URL : '');
      form.target = 'gs_iframe';
      const inp = document.createElement('input');
      inp.type = 'hidden'; inp.name = 'payload';
      inp.value = JSON.stringify({ sheetName: SHEET, columns, rows });
      form.appendChild(inp);
      document.body.appendChild(form);
      form.submit();
      setTimeout(()=>{ try{ document.body.removeChild(form);}catch(e){} }, 1200);
    } catch(e) {}
  }
  
  // VVVV ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£ Cache ‡∏Ñ‡πà‡∏≤ cutMachineNo VVVV
  function hookCutMachineCache(){
      const iCM = document.getElementById('cutMachineNo');
      if(!iCM) return;
      const h = ()=> cache(LS_CUTMACHINE, (iCM.value||'').trim());
      ['change','blur','keyup','paste'].forEach(ev=>iCM.addEventListener(ev,h));
  }


  document.addEventListener('DOMContentLoaded', () => {
    // VVVV ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ hookCutMachineCache VVVV
    hookCutMachineCache(); 
    
    // REMOVE any previous click handler patch on btnBuild if exists
    const btn = document.getElementById('btnBuild');
    if (btn && btn.__qrlogRobustPatched) {
      try { btn.onclick = null; } catch(e){}
    }

    // Hook ONLY makeQR()
    if (window.makeQR && !window.makeQR.__qrlogSinglePatched) {
      const originalMakeQR = window.makeQR;
      window.makeQR = function(){
        const snap = snapNow(); // snapshot BEFORE makeQR clears inputs
        try { return originalMakeQR.apply(this, arguments); }
        finally { setTimeout(() => postToGS(snap), 150); }
      };
      window.makeQR.__qrlogSinglePatched = true;
    }
  });
})();
</script>

<script>
(function(){
  function toggleBuildBtn(){
    const roll = (document.getElementById('qr21')?.value || '').trim();
    const rf   = (document.getElementById('qr24')?.value || '').trim();
    const btn  = document.getElementById('btnBuild');
    if(!btn) return;
    btn.disabled = !(roll && rf);
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    ['qr21','qr24'].forEach(id=>{
      const el=document.getElementById(id);
      if(el){
        ['input','change','keyup','paste','blur'].forEach(ev=>{
          el.addEventListener(ev, toggleBuildBtn);
        });
      }
    });
    toggleBuildBtn();
  });
})();
</script>


<script>
(function(){
  function toggleBuildBtn(){
    const roll = (document.getElementById('qr21')?.value || '').trim();
    const rf   = (document.getElementById('qr24')?.value || '').trim();
    const btn  = document.getElementById('btnBuild');
    const warn = document.getElementById('qrWarn');
    if(!btn) return;

    const ready = !!(roll && rf);
    btn.disabled = !ready;

    if(warn){
      if(ready){
        warn.style.display = 'none';
      }else{
        let msg = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ';
        if(!roll && !rf) msg += 'Roll ‡πÅ‡∏•‡∏∞ RF ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';
        else if(!roll) msg += 'Roll ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';
        else if(!rf) msg += 'RF ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö';
        warn.textContent = msg;
        warn.style.display = 'block';
      }
    }
  }
  document.addEventListener('DOMContentLoaded', ()=>{
    ['qr21','qr24'].forEach(id=>{
      const el=document.getElementById(id);
      if(el){
        ['input','change','keyup','paste','blur'].forEach(ev=>{
          el.addEventListener(ev, toggleBuildBtn);
        });
      }
    });
    toggleBuildBtn();
  });
})();
</script>


<script>
(function(){
  function syncBigQR(){
    const src = document.getElementById('qrCanvas');
    const dst = document.getElementById('qrCanvasBig');
    if(!src || !dst) return;
    const ctx = dst.getContext('2d');
    ctx.clearRect(0,0,dst.width,dst.height);
    ctx.drawImage(src,0,0,dst.width,dst.height);
  }
  const orig = window.makeQR;
  if(orig){
    window.makeQR = async function(){
      const r = await orig.apply(this, arguments);
      setTimeout(syncBigQR,50);
      return r;
    }
  }
})();
</script>


<script>
document.addEventListener('DOMContentLoaded',()=>{
  document.querySelectorAll('label').forEach(lb=>{
    if(lb.textContent.includes('‡∏™‡∏µ')){
      const row = lb.closest('.row') || lb.parentElement;
      if(row) row.classList.add('hide-color-field');
    }
  });
});
</script>


<!-- Cut Machine Quick Edit -->
<div id="cmQuickModal" class="modal">
  <div class="top toolbar">
    <strong>‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î</strong>
    <span class="grow"></span>
    <button class="btn gray" onclick="closeCMQuick()">‡∏õ‡∏¥‡∏î</button>
  </div>
  <div style="background:#fff;padding:16px">
    <label>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î</label>
    <select id="cmQuickSelect" style="min-width:240px"></select>
    <div class="hint" style="margin-top:8px">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡∏ã‡πà‡∏≠‡∏ô‡πÑ‡∏ß‡πâ‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
  // ‡∏ã‡πà‡∏≠‡∏ô‡πÅ‡∏ñ‡∏ß‡∏Ç‡∏≠‡∏á cutMachineNo
  const cm = document.getElementById('cutMachineNo');  
  if(cm){
    const row = cm.closest('.row') || cm.parentElement;
    if(row) row.classList.add('hide-cut-machine');

    // clone options to quick modal select
    const qs = document.getElementById('cmQuickSelect');
    if(qs){
      qs.innerHTML = cm.innerHTML;
      qs.value = cm.value;
      qs.onchange = ()=>{ cm.value = qs.value; };
    }

    // add icon button near title
    const title = document.querySelector('.title');
    if(title && !document.getElementById('cmIconBtn')){
      const btn = document.createElement('button');
      btn.id = 'cmIconBtn';
      btn.className = 'cm-icon-btn';
      btn.innerHTML = 'üõ† ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î';
      btn.onclick = openCMQuick;
      title.appendChild(btn);
    }
  }
});

function openCMQuick(){
  const cm = document.getElementById('cutMachineNo');
  const qs = document.getElementById('cmQuickSelect');
  if(cm && qs){ qs.value = cm.value; }
  document.getElementById('cmQuickModal').classList.add('show');
}
function closeCMQuick(){
  document.getElementById('cmQuickModal').classList.remove('show');
}

// === REQUIRE LINE BEFORE SCAN (AUTO-LOCK QR) ===
document.addEventListener('DOMContentLoaded',()=>{
  const lineEl = document.getElementById('line');
  const qr21 = document.getElementById('qr21');
  const s21 = document.getElementById('s_21');

  function lockScan(){
    if(qr21){
      qr21.disabled = true;
      qr21.placeholder = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πà‡∏≠‡∏ô';
    }
    if(s21){
      s21.textContent = '‚õî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô';
      s21.className = 'status bad';
    }
  }

  function unlockScan(){
    if(qr21){
      qr21.disabled = false;
      qr21.placeholder = '‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
    }
    if(s21){
      s21.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
      s21.className = 'status ok';
    }
  }

  if(!lineEl || !qr21) return;

  // initial state
  if(!lineEl.value){
    lockScan();
  } else {
    unlockScan();
  }

  lineEl.addEventListener('change',()=>{
    if(!lineEl.value){
      lockScan();
      lineEl.focus();
    } else {
      unlockScan();
      qr21.focus();
    }
  });
});


// === REQUIRE CUT MACHINE NO BEFORE SCAN (AUTO-LOCK QR) ===
document.addEventListener('DOMContentLoaded',()=>{
  const cmEl = document.getElementById('cutMachineNo');
  const qr21 = document.getElementById('qr21');
  const s21 = document.getElementById('s_21');

  function lockByCM(){
    if(qr21){
      qr21.disabled = true;
      qr21.placeholder = '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô';
    }
    if(s21){
      s21.textContent = '‚õî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏á‡∏≤‡∏ô';
      s21.className = 'status bad';
    }
  }

  function unlockByCM(){
    if(qr21){
      qr21.disabled = false;
      qr21.placeholder = '‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
    }
    if(s21){
      s21.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
      s21.className = 'status ok';
    }
  }

  if(!cmEl || !qr21) return;

  // initial state
  if(!cmEl.value){
    lockByCM();
  }

  cmEl.addEventListener('change',()=>{
    if(!cmEl.value){
      lockByCM();
      cmEl.focus();
    } else {
      unlockByCM();
      qr21.focus();
    }
  });
});


// === HARD REQUIRE CUT MACHINE (OVERRIDE ALL UNLOCK LOGIC) ===
document.addEventListener('DOMContentLoaded',()=>{
  const lineEl = document.getElementById('line');
  const cmEl   = document.getElementById('cutMachineNo');
  const qr21   = document.getElementById('qr21');
  const s21    = document.getElementById('s_21');

  function lockAll(msg){
    if(qr21){
      qr21.disabled = true;
      qr21.placeholder = msg || '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô';
    }
    if(s21){
      s21.textContent = '‚õî ' + (msg || '‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï ‡πÅ‡∏•‡∏∞ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î');
      s21.className = 'status bad';
    }
  }

  function tryUnlock(){
    const lineOK = lineEl && lineEl.value.trim();
    const cmOK   = cmEl && !cmEl.disabled && cmEl.value.trim();

    if(lineOK && cmOK){
      if(qr21){
        qr21.disabled = false;
        qr21.placeholder = '‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
        qr21.focus();
      }
      if(s21){
        s21.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
        s21.className = 'status ok';
      }
    }else{
      if(!lineOK){
        lockAll('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πà‡∏≠‡∏ô');
      }else if(!cmOK){
        lockAll('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
      }
    }
  }

  if(!qr21) return;

  // initial lock
  lockAll();

  // watch changes
  if(lineEl) lineEl.addEventListener('change', tryUnlock);
  if(cmEl)   cmEl.addEventListener('change', tryUnlock);

  // also block manual focus
  qr21.addEventListener('focus',()=>{
    if(qr21.disabled){
      tryUnlock();
    }
  });
});


// === FIX: HARD REQUIRE CUT MACHINE (CORRECT STATE CHECK) ===
document.addEventListener('DOMContentLoaded',()=>{
  const lineEl = document.getElementById('line');
  const cmEl   = document.getElementById('cutMachineNo');
  const qr21   = document.getElementById('qr21');
  const s21    = document.getElementById('s_21');

  function lock(msg){
    if(qr21){
      qr21.disabled = true;
      qr21.placeholder = msg;
    }
    if(s21){
      s21.textContent = '‚õî ' + msg;
      s21.className = 'status bad';
    }
  }

  function unlock(){
    if(qr21){
      qr21.disabled = false;
      qr21.placeholder = '‡∏¢‡∏¥‡∏á‡∏™‡πÅ‡∏Å‡∏ô 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà';
      qr21.focus();
    }
    if(s21){
      s21.textContent = '‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 21 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£';
      s21.className = 'status ok';
    }
  }

  function checkGate(){
    const lineOK = lineEl && lineEl.value.trim() !== '';
    const cmOK   = cmEl && cmEl.value && cmEl.value.trim() !== '';

    if(!lineOK){
      lock('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏•‡∏ô‡πå‡∏ú‡∏•‡∏¥‡∏ï‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    if(!cmOK){
      lock('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î‡∏Å‡πà‡∏≠‡∏ô');
      return;
    }
    unlock();
  }

  if(!qr21) return;

  // initial
  checkGate();

  if(lineEl) lineEl.addEventListener('change', checkGate);
  if(cmEl)   cmEl.addEventListener('change', checkGate);

  qr21.addEventListener('focus',()=>{
    if(qr21.disabled){
      checkGate();
    }
  });
});


// === OVERRIDE onQR24 : HARD VALIDATION A/B/C + 23 DIGITS ===
function onQR24(){
  let vRaw = $('qr24').value || '';
  let v = vRaw.replace(/\s/g,'').toUpperCase();
  if(v !== vRaw){ $('qr24').value = v; }

  // ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢ A, B ‡∏´‡∏£‡∏∑‡∏≠ C ‡πÅ‡∏•‡∏∞‡∏ï‡∏≤‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 23 ‡∏ï‡∏±‡∏ß ‡∏£‡∏ß‡∏° 24 ‡∏ï‡∏±‡∏ß
  const pattern = /^[ABC]\d{23}$/;

  if(v.length !== 24){
    $('s_24').textContent='‚õî RF ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ('+v.length+'/24)';
    $('s_24').className='status bad';
    return;
  }

  if(!pattern.test(v)){
    $('s_24').textContent='‚õî QR ‡∏ú‡∏¥‡∏î‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó (‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏∂‡πâ‡∏ô‡∏ï‡πâ‡∏ô A / B / C ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)';
    $('s_24').className='status bad';
    $('qr24').value = '';
    $('qr24').focus();
    return;
  }

  $('s_24').textContent='‚úÖ RF ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£)';
  $('s_24').className='status ok';
  if(CFG.autoBuild){ makeQR(); }
}

</script>


<script>
// === Step 2: Auto-fill Master from Materials when clicking Cut-file ===
document.addEventListener('click', function(e){
  const el = e.target;
  if(el && el.classList.contains('cf-link')){
    // find the row
    const tr = el.closest('tr');
    if(!tr) return;
    const tds = tr.querySelectorAll('td');
    // Materials column is index 1
    if(tds.length > 1){
      const materials = tds[1].innerText.trim();
      const masterInput = document.getElementById('master');
      if(masterInput){
        masterInput.value = materials;
        masterInput.dispatchEvent(new Event('input'));
      }
    }
  }
});
</script>

<!-- === PATCH v25: Disable QR21 length/cut logic === -->
<script>
(function(){
  try{
    if(typeof state!=='undefined'){
      state.requireScan21 = false;
    }
    // override onQR21 to accept any length and do nothing special
    window.onQR21 = function(){
      let el = document.getElementById('qr21');
      let st = document.getElementById('s_21');
      if(!el) return;
      el.value = el.value.toUpperCase();
      if(st){
        st.textContent = el.value ? '‚úîÔ∏è ‡∏£‡∏±‡∏ö‡∏Ñ‡πà‡∏≤ QR21 ‡πÅ‡∏•‡πâ‡∏ß (‡πÑ‡∏°‡πà‡∏ï‡∏±‡∏î ‡πÑ‡∏°‡πà‡πÄ‡∏ä‡πá‡∏Å‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß)' : '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR21';
        st.className = 'status ' + (el.value ? 'ok':''); 
      }
    };
    // always allow QR24
    window.setInfo2Enabled = function(enabled, focus){
      const q=document.getElementById('qr24');
      const s=document.getElementById('s_24');
      if(q){ q.disabled=false; if(focus) q.focus(); }
      if(s){ s.textContent='‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• 24 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£'; s.className='status ok'; }
    };
  }catch(e){ console.error(e); }
})();
</script>
<!-- === END PATCH v25 === -->


<!-- === PATCH v27: Master‚ÜîQR21 match (trim P#) + Auto-focus QR24 === -->
<script>
(function(){
  try{
    function normalizeQR21(v){
      v = (v||'').toUpperCase().trim();
      if(v.startsWith('P#')) return v.substring(1);
      return v;
    }

    window.onQR21 = function(){
      const qr21 = document.getElementById('qr21');
      const master = document.getElementById('master');
      const qr24 = document.getElementById('qr24');
      const s21 = document.getElementById('s_21');
      const s24 = document.getElementById('s_24');

      if(!qr21) return;

      qr21.value = qr21.value.toUpperCase();

      const raw = qr21.value;
      const norm = normalizeQR21(raw);
      const mval = master ? master.value.toUpperCase().trim() : '';

      if(s21){
        s21.textContent = raw ? ('QR21 ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î = ' + norm) : '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR21';
        s21.className = raw ? 'status ok' : 'status';
      }

      if(!qr24) return;

      if(mval && norm === mval){
        qr24.disabled = false;
        if(s24){
          s24.textContent = '‚úÖ QR21 ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Master ‚Üí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å QR24';
          s24.className = 'status ok';
        }
        // AUTO-FOCUS QR24
        setTimeout(()=>{
          qr24.focus();
          if(qr24.select) qr24.select();
        }, 0);
      }else{
        qr24.disabled = true;
        qr24.value = '';
        if(s24){
          s24.textContent = '‚õî QR21 ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á Master';
          s24.className = 'status bad';
        }
      }
    };

    document.addEventListener('DOMContentLoaded', function(){
      const qr24 = document.getElementById('qr24');
      const s24 = document.getElementById('s_24');
      if(qr24){
        qr24.disabled = true;
        if(s24){
          s24.textContent = '‚õî ‡∏£‡∏≠ QR21 ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Master';
          s24.className = 'status';
        }
      }
    });
  }catch(e){ console.error(e); }
})();
</script>
<!-- === END PATCH v27 === -->


<!-- === PATCH v28: Highlight mismatch message when QR21 != Master === -->
<script>
(function(){
  try{
    function normalizeQR21(v){
      v = (v||'').toUpperCase().trim();
      if(v.startsWith('P#')) return v.substring(1);
      return v;
    }

    window.onQR21 = function(){
      const qr21 = document.getElementById('qr21');
      const master = document.getElementById('master');
      const qr24 = document.getElementById('qr24');
      const s21 = document.getElementById('s_21');
      const s24 = document.getElementById('s_24');

      if(!qr21) return;

      qr21.value = qr21.value.toUpperCase();

      const raw = qr21.value;
      const norm = normalizeQR21(raw);
      const mval = master ? master.value.toUpperCase().trim() : '';

      if(s21){
        s21.textContent = raw ? ('QR21 ‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏±‡∏î = ' + norm) : '‡∏£‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• QR21';
        s21.className = raw ? 'status ok' : 'status';
      }

      if(!qr24) return;

      if(mval && norm === mval){
        qr24.disabled = false;
        if(s24){
          s24.textContent = '‚úÖ QR21 ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Master ‚Üí ‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å QR24';
          s24.className = 'status ok';
        }
        setTimeout(()=>{
          qr24.focus();
          if(qr24.select) qr24.select();
        }, 0);
      }else{
        qr24.disabled = true;
        qr24.value = '';
        if(s24){
          if(mval && norm){
            s24.innerHTML = '‚ùå <strong style="color:#dc2626">‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô</strong><br>'
              + 'Master: <span style="color:#2563eb">' + mval + '</span><br>'
              + 'QR21: <span style="color:#b45309">' + norm + '</span>';
            s24.className = 'status bad';
          }else{
            s24.textContent = '‚õî ‡∏£‡∏≠ QR21 ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Master';
            s24.className = 'status';
          }
        }
      }
    };

    document.addEventListener('DOMContentLoaded', function(){
      const qr24 = document.getElementById('qr24');
      const s24 = document.getElementById('s_24');
      if(qr24){
        qr24.disabled = true;
        if(s24){
          s24.textContent = '‚õî ‡∏£‡∏≠ QR21 ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö Master';
          s24.className = 'status';
        }
      }
    });
  }catch(e){ console.error(e); }
})();
</script>
<!-- === END PATCH v28 === -->


<script>
/* Fallback: ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ '‡∏•‡∏ö' ‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° */
(function(){
  try{
    document.querySelectorAll('button').forEach(b=>{
      if((b.textContent||'').includes('‡∏•‡∏ö')){
        b.style.display='none';
      }
    });
  }catch(e){}
})();



















// === AUTO-FILL NOTE (SANITIZE + OVERWRITE) ===
document.addEventListener('change', function(e){
  const el = e.target;
  if(el.tagName !== 'SELECT') return;

  const tr = el.closest('tr');
  if(!tr) return;

  const detail = tr.querySelector('input[placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏õ‡∏±‡∏ç‡∏´‡∏≤"], textarea');
  if(!detail) return;

  const status = el.value;

  // ‡∏î‡∏∂‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ï‡∏±‡∏î (row > global)
  let machine = '';
  const rowMachine = tr.querySelector('select[id*="cut"], select[id*="Machine"], select[name*="Machine"], select[name*="cut"]');
  if(rowMachine && rowMachine.value) machine = rowMachine.value;

  if(!machine){
    const globalMachine =
      document.getElementById('cutMachineNo')
      || document.querySelector('select[id*="cutMachine"]')
      || document.querySelector('select[name*="cutMachine"]');
    if(globalMachine && globalMachine.value) machine = globalMachine.value;
  }

  // üßπ SANITIZE: ‡∏•‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Å‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡∏Ñ‡πâ‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà
  detail.value = detail.value
    .replace(/^(‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥|‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô|‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤).*?(?=$|:)/, '')
    .trim();

  if(status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥'){
    detail.value = machine ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥';
    detail.readOnly = true;
  }
  else if(status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'){
    detail.value = machine ? `‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
    detail.readOnly = true;
  }
  else if(status === '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'){
    detail.value = machine ? `‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
    detail.readOnly = false;
    detail.focus();
  }
  else{
    detail.readOnly = false;
  }
});
// === END AUTO-FILL NOTE (SANITIZE + OVERWRITE) ===

</script>


<script>
// === FINAL GUARD: FORCE NOTE SYNC BEFORE SAVE ===
document.addEventListener('click', function(e){
  const btn = e.target.closest('button');
  if(!btn) return;

  const isSave = /‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å|save|submit|‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•/i.test(btn.textContent || '');
  if(!isSave) return;

  document.querySelectorAll('tr').forEach(tr => {
    const statusSel = tr.querySelector('select');
    const detail = tr.querySelector('input[placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î/‡∏õ‡∏±‡∏ç‡∏´‡∏≤"], textarea');
    if(!statusSel || !detail) return;

    const status = statusSel.value;

    let machine = '';
    const globalMachine =
      document.getElementById('cutMachineNo')
      || document.querySelector('select[id*="cutMachine"]')
      || document.querySelector('select[name*="cutMachine"]');
    if(globalMachine && globalMachine.value) machine = globalMachine.value;

    if(status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥'){
      detail.value = machine ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥';
    } else if(status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô'){
      detail.value = machine ? `‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
    } else if(status === '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤'){
      detail.value = machine ? `‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
    }
  });
});
// === END FINAL GUARD ===
</script>


<script>
// === V10 DEFINITIVE FIX: COMPUTE NOTE AT SEND TIME ===
(function(){
  function computeNote(status, machine){
    if(status === '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥') return machine ? `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥';
    if(status === '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô') return machine ? `‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô';
    if(status === '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤') return machine ? `‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤ ‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á ${machine}` : '‡∏ï‡∏¥‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤';
    return '';
  }

  const _fetch = window.fetch;
  window.fetch = function(input, init){
    try{
      if(init && init.body && typeof init.body === 'string'){
        const data = JSON.parse(init.body);

        const gm =
          document.getElementById('cutMachineNo')
          || document.querySelector('select[id*="cutMachine"]')
          || document.querySelector('select[name*="cutMachine"]');
        const machine = gm ? gm.value : '';

        if(data && data.status){
          data.note = computeNote(data.status, machine);
          init.body = JSON.stringify(data);
        }
      }
    }catch(e){}
    return _fetch.apply(this, arguments);
  };
})();
// === END V10 FIX ===
</script>

</body>
</html>

</html>
